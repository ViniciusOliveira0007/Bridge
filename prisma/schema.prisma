// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USUÁRIOS (Professor + Aluno + Empresa)
// ============================================
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  senha     String
  role      String   @default("aluno") // "professor", "aluno" ou "empresa"
  perfilUrl String?  // Foto de perfil
  telefone  String?
  createdAt DateTime @default(now())
  
  // Perfil do usuário (aluno/professor)
  especializacaoEmAndamento String?  // Curso atual
  sobreMim                  String?  // Biografia
  
  // Relações antigas (mantidas)
  posts              Post[]
  atividadesCriadas  Atividade[]  @relation("ProfessorAtividades")
  entregas           Entrega[]
  turmasComoAluno    TurmaAluno[]
  turmasCriadas      Turma[]      @relation("ProfessorTurmas")
  codigosVerificacao CodigoVerificacao[]
  presencasComoAluno     Presenca[] @relation("AlunoPresencas")
  presencasComoProfessor Presenca[] @relation("ProfessorPresencas")
  
  // Novas relações
  empresa            Empresa?
  formacoes          Formacao[]
  habilidades        UsuarioHabilidade[]
  portfolios         Portfolio[]
  projetosUsuario    ProjetoUsuario[]
  propostasRecebidas Proposta[]
  candidaturas       Candidatura[]
  avaliacoesRecebidas Avaliacao[] @relation("UsuarioAvaliado")
  avaliacoesFeitas    Avaliacao[] @relation("EmpresaAvaliadora")
}

// ============================================
// EMPRESA (Dados específicos de empresa)
// ============================================
model Empresa {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  nomeEmpresa String
  logoUrl     String?
  descricao   String?
  site        String?
  createdAt   DateTime @default(now())
  
  user     User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  projetos ProjetoEmpresa[]
  propostas Proposta[]
}

// ============================================
// PROJETOS DA EMPRESA (Explorar)
// ============================================
model ProjetoEmpresa {
  id               Int       @id @default(autoincrement())
  empresaId        Int
  nome             String
  descricao        String?
  estado           String    @default("Aberto") // "Aberto", "Em Andamento", "Finalizado", "Cancelado"
  categoria        String?   // "Desenvolvimento", "Design", "Marketing", "Dados"
  prioridade       String    @default("Media") // "Baixa", "Media", "Alta", "Urgente"
  prazo            DateTime?
  vagasTotal       Int       @default(1)
  vagasPreenchidas Int       @default(0)
  imagemUrl        String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  
  empresa                Empresa             @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  candidaturas           Candidatura[]
  habilidadesRequeridas  ProjetoHabilidade[]
  
  @@index([empresaId, estado])
  @@index([categoria])
  @@index([estado, prioridade])
}

// ============================================
// HABILIDADES REQUERIDAS NO PROJETO
// ============================================
model ProjetoHabilidade {
  id           Int @id @default(autoincrement())
  projetoId    Int
  habilidadeId Int
  nivelMinimo  Int @default(1)
  
  projeto    ProjetoEmpresa @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  habilidade Habilidade     @relation(fields: [habilidadeId], references: [id], onDelete: Cascade)
  
  @@unique([projetoId, habilidadeId])
}

// ============================================
// CANDIDATURAS (Pessoas que aceitaram)
// ============================================
model Candidatura {
  id        Int      @id @default(autoincrement())
  projetoId Int
  usuarioId Int
  status    String   @default("Aceito") // "Aceito", "Em Andamento", "Concluído"
  createdAt DateTime @default(now())
  
  projeto   ProjetoEmpresa @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  usuario   User           @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  avaliacoes Avaliacao[]
  
  @@unique([projetoId, usuarioId])
  @@index([usuarioId])
}

// ============================================
// FORMAÇÕES ACADÊMICAS
// ============================================
model Formacao {
  id          Int      @id @default(autoincrement())
  usuarioId   Int
  titulo      String   // "Tecnólogo em ADS"
  instituicao String   // "FATEC Itanhaém"
  descricao   String?
  dataInicio  DateTime?
  dataFim     DateTime?
  emAndamento Boolean  @default(false)
  createdAt   DateTime @default(now())
  
  usuario User @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@index([usuarioId])
}

// ============================================
// HABILIDADES (Catálogo)
// ============================================
model Habilidade {
  id        Int      @id @default(autoincrement())
  nome      String   @unique // "React", "Node.js", "Python"
  categoria String?  // "Frontend", "Backend", "Design"
  icone     String?
  createdAt DateTime @default(now())
  
  usuariosHabilidades UsuarioHabilidade[]
  propostas           PropostaHabilidade[]
  projetosUsuario     ProjetoUsuarioHabilidade[]
  projetosEmpresa     ProjetoHabilidade[]
}

// ============================================
// HABILIDADES DO USUÁRIO
// ============================================
model UsuarioHabilidade {
  id           Int      @id @default(autoincrement())
  usuarioId    Int
  habilidadeId Int
  nivel        Int      @default(1) // 1-10 ou 1-5
  xp           Int      @default(0) // Experiência acumulada
  validado     Boolean  @default(false) // Se foi validado por empresa
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  usuario    User       @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  habilidade Habilidade @relation(fields: [habilidadeId], references: [id], onDelete: Cascade)
  
  @@unique([usuarioId, habilidadeId])
  @@index([usuarioId])
}

// ============================================
// PORTFÓLIO
// ============================================
model Portfolio {
  id          Int      @id @default(autoincrement())
  usuarioId   Int
  titulo      String
  descricao   String?
  imagemUrl   String?
  linkExterno String?
  ordem       Int      @default(0)
  createdAt   DateTime @default(now())
  
  usuario User @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@index([usuarioId, ordem])
}

// ============================================
// PROJETOS DO USUÁRIO
// ============================================
model ProjetoUsuario {
  id            Int       @id @default(autoincrement())
  usuarioId     Int
  nome          String
  descricao     String?
  imagemUrl     String?
  dataRealizada DateTime?
  createdAt     DateTime  @default(now())
  
  usuario            User                         @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  habilidadesUsadas  ProjetoUsuarioHabilidade[]
  
  @@index([usuarioId])
}

// ============================================
// HABILIDADES USADAS NO PROJETO
// ============================================
model ProjetoUsuarioHabilidade {
  id         Int @id @default(autoincrement())
  projetoId  Int
  habilidadeId Int
  
  projeto    ProjetoUsuario @relation(fields: [projetoId], references: [id], onDelete: Cascade)
  habilidade Habilidade     @relation(fields: [habilidadeId], references: [id], onDelete: Cascade)
  
  @@unique([projetoId, habilidadeId])
}

// ============================================
// PROPOSTAS (Empresa -> Usuário)
// ============================================
model Proposta {
  id          Int      @id @default(autoincrement())
  empresaId   Int
  usuarioId   Int
  nome        String
  descricao   String?
  imagemUrl   String?
  estado      String   @default("Pendente") // "Pendente", "Aceita", "Recusada", "Concluída"
  nivelMinimo Int      @default(1) // Nível mínimo requerido
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  empresa     Empresa              @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  usuario     User                 @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  habilidades PropostaHabilidade[]
  
  @@index([usuarioId, estado])
  @@index([empresaId])
}

// ============================================
// HABILIDADES REQUERIDAS NA PROPOSTA
// ============================================
model PropostaHabilidade {
  id           Int @id @default(autoincrement())
  propostaId   Int
  habilidadeId Int
  nivelMinimo  Int @default(1)
  
  proposta   Proposta   @relation(fields: [propostaId], references: [id], onDelete: Cascade)
  habilidade Habilidade @relation(fields: [habilidadeId], references: [id], onDelete: Cascade)
  
  @@unique([propostaId, habilidadeId])
}

// ============================================
// AVALIAÇÕES (Empresa avalia usuário)
// ============================================
model Avaliacao {
  id            Int      @id @default(autoincrement())
  candidaturaId Int
  empresaId     Int      // User com role="empresa"
  usuarioId     Int      // User avaliado
  nota          Float    // 1-5 ou 1-10
  comentario    String?
  xpConcedido   Int      @default(0) // XP dado ao usuário
  habilidadeId  Int?     // Habilidade específica avaliada
  createdAt     DateTime @default(now())
  
  candidatura Candidatura @relation(fields: [candidaturaId], references: [id], onDelete: Cascade)
  empresa     User        @relation("EmpresaAvaliadora", fields: [empresaId], references: [id])
  usuario     User        @relation("UsuarioAvaliado", fields: [usuarioId], references: [id], onDelete: Cascade)
  
  @@index([usuarioId])
  @@index([candidaturaId])
}

// ============================================
// VERIFICAÇÃO SMS (mantido)
// ============================================
model CodigoVerificacao {
  id        Int      @id @default(autoincrement())
  telefone  String
  codigo    String
  expiraEm  DateTime
  usado     Boolean  @default(false)
  userId    Int?
  criadoEm  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])

  @@index([telefone, codigo])
}

// ============================================
// CURSOS (mantido)
// ============================================
model Curso {
  id        Int      @id @default(autoincrement())
  nome      String
  sigla     String
  descricao String?
  createdAt DateTime @default(now())
  
  turmas Turma[]
}

// ============================================
// TURMAS/GRUPOS (mantido)
// ============================================
model Turma {
  id           Int      @id @default(autoincrement())
  nome         String
  sigla        String   @default("TEMP")
  descricao    String?
  cor          String   @default("#FF6B6B")
  corTexto     String   @default("#FFFFFF")
  cursoId      Int
  professorId  Int
  createdAt    DateTime @default(now())
  
  curso       Curso          @relation(fields: [cursoId], references: [id])
  professor   User           @relation("ProfessorTurmas", fields: [professorId], references: [id])
  alunos      TurmaAluno[]
  atividades  Atividade[]
  presencas   Presenca[]
}

// ============================================
// RELAÇÃO ALUNO-TURMA (mantido)
// ============================================
model TurmaAluno {
  id       Int      @id @default(autoincrement())
  turmaId  Int
  alunoId  Int
  entryAt  DateTime @default(now())
  
  turma Turma @relation(fields: [turmaId], references: [id])
  aluno User  @relation(fields: [alunoId], references: [id])
  
  @@unique([turmaId, alunoId])
}

// ============================================
// ATIVIDADES/TAREFAS (mantido)
// ============================================
model Atividade {
  id           Int       @id @default(autoincrement())
  titulo       String
  descricao    String?
  dataEntrega  DateTime?
  turmaId      Int
  professorId  Int
  createdAt    DateTime  @default(now())
  
  turma     Turma     @relation(fields: [turmaId], references: [id])
  professor User      @relation("ProfessorAtividades", fields: [professorId], references: [id])
  entregas  Entrega[]
  arquivos  Arquivo[] @relation("AtividadeArquivos")
}

// ============================================
// ENTREGAS DOS ALUNOS (mantido)
// ============================================
model Entrega {
  id           Int       @id @default(autoincrement())
  atividadeId  Int
  alunoId      Int
  comentario   String?
  dataEntrega  DateTime  @default(now())
  nota         Float?
  
  atividade Atividade @relation(fields: [atividadeId], references: [id])
  aluno     User      @relation(fields: [alunoId], references: [id])
  arquivos  Arquivo[] @relation("EntregaArquivos")
  
  @@unique([atividadeId, alunoId])
}

// ============================================
// ARQUIVOS (mantido)
// ============================================
model Arquivo {
  id           Int       @id @default(autoincrement())
  nomeOriginal String
  nomeArquivo  String
  tamanho      Int
  tipo         String
  atividadeId  Int?
  entregaId    Int?
  createdAt    DateTime  @default(now())
  
  atividade Atividade? @relation("AtividadeArquivos", fields: [atividadeId], references: [id])
  entrega   Entrega?   @relation("EntregaArquivos", fields: [entregaId], references: [id])
}

// ============================================
// POSTS (mantido)
// ============================================
model Post {
  id        Int      @id @default(autoincrement())
  title     String
  content   String?
  imageUrl  String?
  published Boolean  @default(true)
  authorId  Int
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
}

// ============================================
// PRESENÇAS (mantido)
// ============================================
model Presenca {
  id          Int      @id @default(autoincrement())
  turmaId     Int
  alunoId     Int
  professorId Int
  data        DateTime
  presente    Boolean  @default(true)
  createdAt   DateTime @default(now())
  
  turma     Turma @relation(fields: [turmaId], references: [id], onDelete: Cascade)
  aluno     User  @relation("AlunoPresencas", fields: [alunoId], references: [id], onDelete: Cascade)
  professor User  @relation("ProfessorPresencas", fields: [professorId], references: [id])
  
  @@unique([turmaId, alunoId, data])
  @@index([alunoId, turmaId])
  @@index([turmaId, data])
}