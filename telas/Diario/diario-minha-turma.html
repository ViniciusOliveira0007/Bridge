<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DiÃ¡rio - Minhas Turmas</title>
    
 
    

    <link rel="stylesheet" href="./css-diario/estilo-minha-turma.css">
    
 
</head>
<body>

    <nav class="navegacao">
        <div class="menu">
            <div class="menu-1">
                <img src="./imagens-diario/lotus.svg" alt="Logo" class="projeto" width="30px" height="30px">
            </div>
            <div class="menu-2">
                <input type="text" placeholder="Pesquise aqui...">
            </div>
            
            <div class="menu-3">
                <img src="./imagens-diario/sininho.svg" alt="notificaÃ§Ã£o" class="btn-notificao-nav">
                <img src="./imagens-diario/configuracao.svg" alt="configuraÃ§Ã£o" class="btn-config">
                <img src="./imagens-diario/foto_de_perfil.png" alt="perfil" class="foto-de-perfil" id="fotoPerfil">
                
                <div class="dropdown-notificacoes" id="dropdownNotif">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-diario/sino-black.svg" alt="NotificaÃ§Ã£o">
                            <span>NotificaÃ§Ãµes</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-notif">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <div class="notificacao-vazia">Nenhuma notificaÃ§Ã£o no momento</div>
                    </div>
                </div>

                <div class="dropdown-configuracoes" id="dropdownConfig">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-diario/configuracao-black.svg" alt="ConfiguraÃ§Ã£o">
                            <span>ConfiguraÃ§Ãµes</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-config">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item">Tema</button>
                        <button class="opcao-item">Acessibilidade</button>
                        <button class="opcao-item">OpÃ§Ãµes avanÃ§adas</button>
                    </div>
                </div>

                <div class="dropdown-perfil" id="dropdownPerfil">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-diario/foto_de_perfil.png" alt="Perfil" class="perfil-mini" id="fotoPerfilMini">
                            <span id="nomeNoDropdown">OlÃ¡, Professor</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-perfil">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item">Seu perfil</button>
                        <button class="opcao-item">Privacidade</button>
                        <button class="opcao-item">Ajuda e Recursos</button>
                        <button class="opcao-item sair-conta" data-action="sair-da-conta">Sair da Conta</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="nome-da-guia">
        <ul>
            <li><a href="../Rede/connect.html">Redes</a></li>
            <li><a href="../Sala-de-Aula/sala.html">Sala de Aula</a></li>
            <li><a href="../Trilhas/trilhas.html">Trilhas</a></li>
            <li><a href="diario.html">DiÃ¡rio</a></li>
        </ul>
    </div>

    <main class="conteudo-principal">
        <div class="bloco-de-conteudo-aulas">
            <div class="sub-guia-aulas">
                <a class="btn-sub-guia-aulas" href="diario-professor-inicio.html">InÃ­cio</a>
                <a class="btn-sub-guia-aulas" href="diario-registrar-presenca.html">PresenÃ§a</a>
                <a class="btn-sub-guia-aulas" href="diario-relatorio-professor.html">RelatÃ³rios</a>
                <a class="btn-sub-guia-aulas" href="diario-minha-turma.html">Turmas</a>
            </div>
        </div>

        <div class="bloco-de-conteudo2">
            <div class="secao-turmas">
                <h2>ðŸ“š Minhas Turmas</h2>

                <div class="estatisticas-resumo" id="estatisticasResumo" style="display: none;">
                    <div class="card-estatistica turmas">
                        <div class="label">Total de Turmas</div>
                        <div class="numero" id="totalTurmas">0</div>
                    </div>
                    <div class="card-estatistica alunos">
                        <div class="label">Total de Alunos</div>
                        <div class="numero" id="totalAlunos">0</div>
                    </div>
                    <div class="card-estatistica cursos">
                        <div class="label">Cursos Diferentes</div>
                        <div class="numero" id="totalCursos">0</div>
                    </div>
                </div>

                <div class="loading-spinner" id="loadingSpinner">
                    <div class="spinner"></div>
                    <p>Carregando suas turmas...</p>
                </div>

                <div class="grid-turmas" id="gridTurmas"></div>
            </div>
        </div>
    </main>

    <div class="modal-overlay" id="modalAlunos">
        <div class="modal-container">
            <div class="modal-header">
                <h3 id="modalTitulo">Alunos da Turma</h3>
                <button class="btn-fechar" onclick="fecharModal()">&times;</button>
            </div>
            <div class="modal-body">
                <ul class="lista-alunos-modal" id="listaAlunosModal"></ul>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        
        // Pega dados do usuÃ¡rio
        let userData = JSON.parse(localStorage.getItem('user') || 'null');
        if (!userData) {
            userData = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
        }
        
        const professorId = userData ? userData.id : null;
        const userName = userData ? userData.name : 'Professor';
        const userPerfilUrl = userData ? userData.perfilUrl : null;

        // Atualizar nome e foto
        document.getElementById('nomeNoDropdown').textContent = `OlÃ¡, ${userName}`;

        if (userPerfilUrl) {
            const urlFoto = userPerfilUrl.startsWith('http') 
                ? userPerfilUrl 
                : `http://localhost:3000${userPerfilUrl}`;
            
            document.getElementById('fotoPerfil').src = urlFoto;
            document.getElementById('fotoPerfilMini').src = urlFoto;
        }

        // ===================================
        // DROPDOWNS - MESMO PADRÃƒO DO SALA.HTML
        // ===================================
        const dropdownNotif = document.getElementById('dropdownNotif');
        const dropdownConfig = document.getElementById('dropdownConfig');
        const dropdownPerfil = document.getElementById('dropdownPerfil');

        document.querySelector('.btn-notificao-nav').addEventListener('click', () => {
            dropdownConfig.classList.remove('ativo');
            dropdownPerfil.classList.remove('ativo');
            dropdownNotif.classList.toggle('ativo');
        });

        document.querySelector('.btn-config').addEventListener('click', () => {
            dropdownNotif.classList.remove('ativo');
            dropdownPerfil.classList.remove('ativo');
            dropdownConfig.classList.toggle('ativo');
        });

        document.querySelector('.foto-de-perfil').addEventListener('click', () => {
            dropdownNotif.classList.remove('ativo');
            dropdownConfig.classList.remove('ativo');
            dropdownPerfil.classList.toggle('ativo');
        });

        document.querySelectorAll('[data-action]').forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                
                if (action === 'fechar-notif') {
                    dropdownNotif.classList.remove('ativo');
                } else if (action === 'fechar-config') {
                    dropdownConfig.classList.remove('ativo');
                } else if (action === 'fechar-perfil') {
                    dropdownPerfil.classList.remove('ativo');
                } else if (action === 'sair-da-conta') {
                    if (confirm('Deseja sair da conta?')) {
                        localStorage.removeItem('user');
                        localStorage.removeItem('usuarioLogado');
                        window.location.href = '../login.html';
                    }
                }
            });
        });

        // ===================================
        // FUNÃ‡Ã•ES DE TURMAS
        // ===================================
        
        function fazerLogout() {
            localStorage.removeItem('user');
            localStorage.removeItem('usuarioLogado');
            window.location.href = '/public/home.html';
        }

        async function carregarTurmas() {
            try {
                const response = await fetch(`${API_URL}/turmas/professor/${professorId}`);
                const data = await response.json();

                const spinner = document.getElementById('loadingSpinner');
                if(spinner) spinner.style.display = 'none';

                if (data.turmas && data.turmas.length > 0) {
                    renderizarEstatisticas(data.turmas);
                    renderizarTurmas(data.turmas);
                } else {
                    mostrarMensagemVazio();
                }
            } catch (error) {
                console.error('Erro ao carregar turmas:', error);
                const spinner = document.getElementById('loadingSpinner');
                if(spinner) {
                    spinner.innerHTML = `
                        <p style="color: #d32f2f;">Erro ao carregar turmas. Por favor, tente novamente.</p>
                    `;
                }
            }
        }

        function renderizarEstatisticas(turmas) {
            const totalTurmas = turmas.length;
            const totalAlunos = turmas.reduce((acc, turma) => acc + turma._count.alunos, 0);
            const cursosUnicos = new Set(turmas.map(t => t.curso?.nome || t.curso || 'NÃ£o definido'));
            const totalCursos = cursosUnicos.size;

            document.getElementById('totalTurmas').textContent = totalTurmas;
            document.getElementById('totalAlunos').textContent = totalAlunos;
            document.getElementById('totalCursos').textContent = totalCursos;
            document.getElementById('estatisticasResumo').style.display = 'grid';
        }

        function renderizarTurmas(turmas) {
            const grid = document.getElementById('gridTurmas');
            
            grid.innerHTML = turmas.map(turma => {
                const nomeCurso = turma.curso?.nome || turma.curso || 'NÃ£o definido';
                const totalAlunos = turma._count?.alunos || 0;
                const anoLetivo = turma.anoLetivo || new Date().getFullYear();
                
                return `
                    <div class="card-turma">
                        <div class="card-turma-header">
                            <h3>${turma.nome}</h3>
                            <p>${nomeCurso}</p>
                        </div>
                        <div class="card-turma-body">
                            <div class="info-item">
                                <strong>ðŸ‘¥ Alunos:</strong>
                                <span class="badge badge-alunos">${totalAlunos} matriculado${totalAlunos !== 1 ? 's' : ''}</span>
                            </div>
                            <div class="info-item">
                                <strong>ðŸ“… Ano Letivo:</strong>
                                <span>${anoLetivo}</span>
                            </div>
                            <div class="info-item">
                                <strong>ðŸ“Š Status:</strong>
                                <span class="badge badge-ativo">Ativo</span>
                            </div>
                        </div>
                        <div class="card-turma-footer">
                            <button class="btn-turma-acao btn-ver-alunos" onclick="verAlunos(${turma.id}, '${turma.nome}')">
                                ðŸ‘¥ Ver Alunos
                            </button>
                            <a href="diario-registrar-presenca.html" class="btn-turma-acao btn-presenca">
                                âœ“ PresenÃ§a
                            </a>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function mostrarMensagemVazio() {
            const grid = document.getElementById('gridTurmas');
            grid.innerHTML = `
                <div class="mensagem-vazio" style="grid-column: 1/-1;">
                    <h3>ðŸ“š Nenhuma turma encontrada</h3>
                    <p>VocÃª ainda nÃ£o possui turmas cadastradas como professor.</p>
                    <p style="margin-top: 10px; font-size: 13px;">Entre em contato com a coordenaÃ§Ã£o para obter acesso Ã s suas turmas.</p>
                </div>
            `;
        }

        async function verAlunos(turmaId, nomeTurma) {
            try {
                const response = await fetch(`${API_URL}/turmas/${turmaId}`);
                const data = await response.json();

                if (data.turma && data.turma.alunos) {
                    document.getElementById('modalTitulo').textContent = `Alunos - ${nomeTurma}`;
                    
                    const listaAlunos = document.getElementById('listaAlunosModal');
                    
                    if (data.turma.alunos.length === 0) {
                        listaAlunos.innerHTML = `
                            <li style="text-align: center; padding: 40px; color: #666;">
                                Nenhum aluno matriculado nesta turma
                            </li>
                        `;
                    } else {
                        listaAlunos.innerHTML = data.turma.alunos.map((matricula, index) => {
                            const aluno = matricula.aluno;
                            const fotoUrl = aluno.perfilUrl 
                                ? `http://localhost:3000${aluno.perfilUrl}` 
                                : './imagens-diario/foto_de_perfil.png';
                            
                            return `
                                <li class="aluno-item-modal">
                                    <span class="aluno-numero-modal">${index + 1}</span>
                                    <img src="${fotoUrl}" alt="${aluno.name}" class="aluno-foto-modal">
                                    <div class="aluno-info-modal">
                                        <div class="aluno-nome-modal">${aluno.name}</div>
                                        <div class="aluno-email-modal">${aluno.email}</div>
                                    </div>
                                </li>
                            `;
                        }).join('');
                    }
                    
                    document.getElementById('modalAlunos').classList.add('ativo');
                }
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                alert('Erro ao carregar lista de alunos');
            }
        }

        function fecharModal() {
            document.getElementById('modalAlunos').classList.remove('ativo');
        }

        document.getElementById('modalAlunos').addEventListener('click', (e) => {
            if (e.target.id === 'modalAlunos') {
                fecharModal();
            }
        });

        // Inicializar
        if (!professorId) {
            alert('VocÃª precisa fazer login como professor!');
        } else {
            carregarTurmas();
        }
    </script>

</body>
</html>