<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diário - Aluno</title>
    <link rel="stylesheet" href="./css-diario/estilos_diario.css">
    <style>
        /* --- CSS DO BOTÃO TROCAR FOTO --- */
        .container-btn-foto {
            width: 100%;
            padding: 10px 20px;
            box-sizing: border-box;
            text-align: center;
        }

        .btn-trocar-foto {
            width: 100%;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 8px 0;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .btn-trocar-foto:hover {
            background-color: #f4f4f4;
            border-color: #999;
        }
    </style>
</head>
<body>
    <nav class="navegacao">
        <div class="menu">
            <div class="menu-1">
                <img src="./imagens-diario/lotus.svg" alt="Logo" class="projeto" width="30px" height="30px">
            </div>
            <div class="menu-2">
                <input type="text" placeholder="Pesquise aqui...">
            </div>
            
            <div class="menu-3">
                <img src="./imagens-diario/sininho.svg" alt="notificação" class="btn-notificao-nav">
                <img src="./imagens-diario/configuracao.svg" alt="configuração" class="btn-config">
                <img src="./imagens-diario/foto_de_perfil.png" alt="perfil" class="foto-de-perfil">

                <div class="dropdown-notificacoes" id="dropdownNotif">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-diario/sino-black.svg" alt="Notificação">
                            <span>Notificações</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-notif">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <div class="notificacao-vazia">Nenhuma notificação no momento</div>
                    </div>
                </div>

                <div class="dropdown-configuracoes" id="dropdownConfig">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-diario/configuracao-black.svg" alt="Configuração">
                            <span>Configurações</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-config">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item">Tema</button>
                        <button class="opcao-item">Acessibilidade</button>
                        <button class="opcao-item">Opções avançadas</button>
                    </div>
                </div>

                <div class="dropdown-perfil" id="dropdownPerfil">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-diario/foto_de_perfil.png" alt="Perfil" class="perfil-mini">
                            <span id="nomeNoDropdown">Olá, Aluno</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-perfil">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item">Seu perfil</button>
                        <button class="opcao-item">Privacidade</button>
                        <button class="opcao-item">Ajuda e Recursos</button>
                        <button class="opcao-item sair-conta" data-action="sair-da-conta">Sair da Conta</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="nome-da-guia">
        <ul>
            <li><a href="../Rede/connect.html">Redes</a></li>
            <li><a href="../Sala-de-Aula/sala.html">Sala de Aula</a></li>
            <li><a href="../Trilhas/trilhas.html">Trilhas</a></li>
            <li><a href="diario.html">Diário</a></li>
        </ul>
    </div>

    <main class="conteudo-principal">
        <div class="bloco-de-conteudo">
            <div class="bloco-interno">
                <div class="img-saudacao">
                    <img src="./imagens-diario/foto_de_perfil.png" alt="Foto" class="foto-de-perfil-diario" id="fotoPerfilDiario">
                    <h2 class="saudacao" id="saudacao">Bem-vindo!</h2>
                </div>
            </div>
            
            <div class="container-btn-foto">
                <button class="btn-trocar-foto" onclick="document.getElementById('inputFotoAluno').click()">Trocar Foto</button>
                <input type="file" id="inputFotoAluno" style="display: none;" accept="image/*">
            </div>

            <div class="bloco-info">
                <h3 class="titulo-bloco">Informações do Aluno</h3>
                <div class="texto-e-info">
                    <p class="info-aluno"><strong>RM:</strong> <span id="rmAluno">-</span></p>
                    <p class="info-aluno"><strong>Nome:</strong> <span id="nomeCompleto">-</span></p>
                    <p class="info-aluno"><strong>Email:</strong> <span id="emailAluno">-</span></p>
                </div>
            </div>

            <div class="bloco-de-detalhe">
                <h4>Habilitação:</h4>
                <p id="habilitacao">Técnico de desenvolvimento de sistemas</p>
            </div>

            <div class="bloco-de-detalhe">
                <h4>Situação Matricula:</h4>
                <p id="situacao">Cursando</p>
            </div>

            <div class="sub-guia-diario">
                <a class="btn-sub-guia" href="diario-aulas.html">Aula e Faltas</a>
                <a class="btn-sub-guia" href="diario-cronograma.html">Cronograma</a>
                <a class="btn-sub-guia" href="diario-boletim.html">Boletim</a>
                <a class="btn-sub-guia" href="diario-turma.html">Turma</a>
                <a class="btn-sub-guia" href="diario-professor.html">Professores</a>
            </div>
        </div>

        <div class="bloco-de-conteudo2">
            <div class="bloco-interno-maior">
                <div class="Informacoes">
                    <h3 class="titulo-box">Comunicado</h3>
                    <div class="Informacoes-para-aluno"></div>
                </div>

                <div class="Informacoes">
                    <h3 class="titulo-box">Pendências</h3>
                    <div class="Informacoes-para-aluno">
                        <p>Entregar Documento: RG</p>
                        <p>Entregar Comprovante de Residência</p>
                    </div>
                </div>
            </div>

            <div class="Informacoes-not">
                <h3 class="titulo-box">Notificações</h3>
                <div class="Informacoes-para-aluno-not"></div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:3000/api';
        
        // --- 1. VERIFICAÇÃO DE SEGURANÇA IMEDIATA ---
        // Se não tiver usuário, nem carrega o resto, joga para o login/home
        let userData = JSON.parse(localStorage.getItem('user') || 'null');
        if (!userData) {
            userData = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
        }

        if (!userData || !userData.id) {
            // Se não estiver logado, redireciona imediatamente
            window.location.href = '/public/home.html'; 
        }

        // --- 2. CARREGAMENTO DE DADOS NA TELA ---
        document.addEventListener('DOMContentLoaded', function() {
            if (userData && userData.id) {
                // Preencher Saudação e Header
                const saudacao = document.getElementById('saudacao');
                const nomeDropdown = document.getElementById('nomeNoDropdown');
                
                if(saudacao) saudacao.textContent = `Bem-vindo, ${userData.name || 'Aluno'}!`;
                if(nomeDropdown) nomeDropdown.textContent = `Olá, ${userData.name || 'Aluno'}`;
                
                // Preencher Bloco de Informações
                const elRm = document.getElementById('rmAluno');
                const elNome = document.getElementById('nomeCompleto');
                const elEmail = document.getElementById('emailAluno');
                
                if(elRm) elRm.textContent = userData.id;
                if(elNome) elNome.textContent = userData.name || '-';
                if(elEmail) elEmail.textContent = userData.email || '-';
                
                // Carregar Fotos
                if (userData.perfilUrl) {
                    const fotoUrl = `http://localhost:3000${userData.perfilUrl}`;
                    
                    // Atualiza todas as fotos com a classe .foto-de-perfil (nav e outras)
                    document.querySelectorAll('.foto-de-perfil').forEach(img => {
                        img.src = fotoUrl;
                        img.onerror = () => img.src = './imagens-diario/foto_de_perfil.png';
                    });
                    
                    // Atualiza foto grande do diário
                    const fotoDiario = document.getElementById('fotoPerfilDiario');
                    if (fotoDiario) {
                        fotoDiario.src = fotoUrl;
                        fotoDiario.onerror = () => fotoDiario.src = './imagens-diario/foto_de_perfil.png';
                    }
                    
                    // Atualiza foto mini do dropdown
                    const fotoMini = document.querySelector('.perfil-mini');
                    if (fotoMini) {
                        fotoMini.src = fotoUrl;
                        fotoMini.onerror = () => fotoMini.src = './imagens-diario/foto_de_perfil.png';
                    }
                }
            }

            // --- 3. LÓGICA DE PREVIEW DE FOTO ---
            const inputFoto = document.getElementById('inputFotoAluno');
            if(inputFoto) {
                inputFoto.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        const previewUrl = URL.createObjectURL(file);
                        
                        // Atualiza visualmente na hora
                        const fotoDiario = document.getElementById('fotoPerfilDiario');
                        if(fotoDiario) fotoDiario.src = previewUrl;
                        
                        document.querySelectorAll('.foto-de-perfil').forEach(img => {
                            img.src = previewUrl;
                        });
                        
                        // Opcional: Aqui você adicionaria a lógica para enviar a foto para a API
                    }
                });
            }

            // --- 4. LÓGICA DOS DROPDOWNS (MENU) ---
            const dropdownNotif = document.getElementById('dropdownNotif');
            const dropdownConfig = document.getElementById('dropdownConfig');
            const dropdownPerfil = document.getElementById('dropdownPerfil');

            function fecharTodos() {
                if(dropdownNotif) dropdownNotif.classList.remove('ativo');
                if(dropdownConfig) dropdownConfig.classList.remove('ativo');
                if(dropdownPerfil) dropdownPerfil.classList.remove('ativo');
            }

            // Listeners de abertura
            const btnNotif = document.querySelector('.btn-notificao-nav');
            if(btnNotif) btnNotif.onclick = (e) => { e.stopPropagation(); const ab = dropdownNotif.classList.contains('ativo'); fecharTodos(); if(!ab) dropdownNotif.classList.add('ativo'); };

            const btnConfig = document.querySelector('.btn-config');
            if(btnConfig) btnConfig.onclick = (e) => { e.stopPropagation(); const ab = dropdownConfig.classList.contains('ativo'); fecharTodos(); if(!ab) dropdownConfig.classList.add('ativo'); };

            // Botão da foto de perfil no menu superior
            // Nota: Seleciona especificamente a imagem dentro do menu-3 para evitar conflito
            const btnPerfil = document.querySelector('.menu-3 .foto-de-perfil'); 
            if(btnPerfil) btnPerfil.onclick = (e) => { e.stopPropagation(); const ab = dropdownPerfil.classList.contains('ativo'); fecharTodos(); if(!ab) dropdownPerfil.classList.add('ativo'); };

            // Botões de fechar (X)
            document.querySelectorAll('.btn-fechar').forEach(btn => {
                btn.onclick = (e) => { e.stopPropagation(); fecharTodos(); };
            });

            // Fechar ao clicar fora
            window.onclick = () => fecharTodos();

            // --- 5. AÇÕES DOS BOTÕES DO MENU (INCLUINDO LOGOUT CORRIGIDO) ---
            document.querySelectorAll('[data-action]').forEach(btn => {
                btn.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'fechar-notif') dropdownNotif.classList.remove('ativo');
                    else if (action === 'fechar-config') dropdownConfig.classList.remove('ativo');
                    else if (action === 'fechar-perfil') dropdownPerfil.classList.remove('ativo');
                    
                    else if (action === 'sair-da-conta') {
                        if (confirm('Deseja sair da conta?')) {
                            // Limpa os dados
                            localStorage.removeItem('user');
                            localStorage.removeItem('usuarioLogado');
                            localStorage.clear(); // Garante limpeza total
                            
                            // Redirecionamento CORRIGIDO (Caminho absoluto)
                            window.location.href = '/public/home.html';
                        }
                    }
                });
            });
        });
    </script>

    
</body>
</html>