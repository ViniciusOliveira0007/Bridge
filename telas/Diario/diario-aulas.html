<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Di√°rio - Aulas e Faltas</title>
    <link rel="stylesheet" href="./css-diario/estilos_diario.css">
    <link rel="stylesheet" href="./css-diario/estilo_diario-aulas.css">
</head>
<body>

    <nav class="navegacao">
        <div class="menu">
            <div class="menu-1">
                <img src="./imagens-diario/lotus.svg" alt="Logo da institui√ß√£o" class="projeto" width="30px" height="30px">
            </div>

            <div class="menu-2">
                <input type="text" placeholder="Pesquise aqui...">
            </div> 

            <div class="menu-3">
                <img src="./imagens-diario/sininho.svg" alt="notifica√ß√£o" class="btn-notificao-nav">
                <img src="./imagens-diario/configuracao.svg" alt="bot√£o de configura√ß√£o" class="btn-config">
                <img src="./imagens-diario/foto_de_perfil.png" alt="imagem de perfil" class="foto-de-perfil" id="fotoPerfil">
                
                <div class="dropdown-notificacoes" id="dropdownNotif">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-diario/sino-black.svg" alt="Notifica√ß√£o">
                            <span>Notifica√ß√µes</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-notif">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <div class="notificacao-vazia">Nenhuma notifica√ß√£o no momento</div>
                    </div>
                </div>

                <div class="dropdown-configuracoes" id="dropdownConfig">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-diario/configuracao-black.svg" alt="Configura√ß√£o">
                            <span>Configura√ß√µes</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-config">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item" data-action="abrir-tema">Tema</button>
                        <button class="opcao-item" data-action="abrir-acessibilidade">Acessibilidade</button>
                        <button class="opcao-item" data-action="abrir-opcoes-avancadas">Op√ß√µes avan√ßadas</button>
                    </div>
                </div>

                <div class="dropdown-perfil" id="dropdownPerfil">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-diario/foto_de_perfil.png" alt="Perfil" class="perfil-mini">
                            <span id="nomeUsuarioPerfil">Ol√°, Carregando...</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-perfil">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item" data-action="abrir-seu-perfil">Seu perfil</button>
                        <button class="opcao-item" data-action="abrir-privacidade">Privacidade</button>
                        <button class="opcao-item" data-action="abrir-ajuda-recursos">Ajuda e Recursos</button>
                        <button class="opcao-item sair-conta" data-action="sair-da-conta">Sair da Conta</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <div class="nome-da-guia">
        <ul>
            <li><a href="../Rede/connect.html">Redes</a></li>
            <li><a href="../Sala-de-Aula/sala.html">Sala de Aula</a></li>
            <li><a href="../Trilhas/trilhas.html">Trilhas</a></li>
            <li><a href="diario.html">Di√°rio</a></li>
        </ul>
    </div>

    <main class="conteudo-principal">
        <div class="bloco-de-conteudo-aulas">
            <div class="sub-guia-aulas">
                <a class="btn-sub-guia-aulas" href="diario.html">In√≠cio</a>
                <a class="btn-sub-guia-aulas" href="diario-aulas.html">Aula e Faltas</a>
                <a class="btn-sub-guia-aulas" href="diario-cronograma.html">Cronograma</a>
                <a class="btn-sub-guia-aulas" href="diario-boletim.html">Boletim</a>
                <a class="btn-sub-guia-aulas" href="diario-turma.html">Turma</a>
                <a class="btn-sub-guia-aulas" href="diario-professor.html">Professores</a>
            </div>
        </div>

        <div class="bloco-de-conteudo2">
            <div class="frame-476">
                <div class="bloco-tabela">
                    <div class="titulo-tabela-aulas">
                        <div class="aulas-faltas">AULAS E FALTAS</div>
                    </div>
                    <table class="tabela" id="tabelaPresencas">
                        <thead>
                            <tr>
                                <th class="titulo-guia">COMPONENTE CURRICULAR</th>
                                <th class="titulo-guia">Carga Hor√°ria</th>
                                <th class="titulo-guia">Aulas Dadas</th>
                                <th class="titulo-guia">Faltas</th>
                                <th class="titulo-guia">Faltas Permitidas</th>
                                <th class="titulo-guia">Freq. Atual</th>
                                <th class="titulo-guia">Freq. M√≠nima</th>
                                <th class="titulo-guia">Status</th>
                            </tr>
                        </thead>
                        <tbody id="corpoTabelaPresencas">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px;">
                                    Carregando informa√ß√µes...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="media-geral" id="mediaGeral">Frequ√™ncia M√©dia: Calculando...</div>
                </div>        
            </div>
        </div>
    </main>

   
    <script>
        const API_URL = 'http://localhost:3000/api';
        
        // --- RECUPERA√á√ÉO ROBUSTA DE DADOS DO USU√ÅRIO ---
        let userData = JSON.parse(localStorage.getItem('user') || 'null');
        
        if (!userData) {
            userData = JSON.parse(localStorage.getItem('usuarioLogado') || '{}');
        }
        
        // Se ainda n√£o tiver, tenta construir manualmente (fallback)
        if (!userData.id) {
            const userId = localStorage.getItem('userId');
            const userName = localStorage.getItem('userName');
            const userEmail = localStorage.getItem('userEmail');
            const userRole = localStorage.getItem('userRole');
            
            if (userId) {
                userData = {
                    id: parseInt(userId),
                    name: userName,
                    email: userEmail,
                    role: userRole
                };
                // Salva no formato correto para as pr√≥ximas vezes
                localStorage.setItem('user', JSON.stringify(userData));
            }
        }
        
        const userId = userData.id;
        const userName = userData.name;

        console.log('üë§ Dados do usu√°rio carregados:', userData);

        // --- CORRE√á√ÉO AQUI: EXIBIR NOME COMPLETO ---
        // Antes estava: userName.split(' ')[0]
        if (userName) {
            document.getElementById('nomeUsuarioPerfil').textContent = `Ol√°, ${userName}`;
        }
        
        // Atualiza foto de perfil se existir
        const fotoPerfil = document.getElementById('fotoPerfil');
        const userPerfilUrl = userData.perfilUrl || localStorage.getItem('userPerfilUrl');
        if (userPerfilUrl && fotoPerfil) {
            fotoPerfil.src = `http://localhost:3000${userPerfilUrl}`;
        }

        // --- FUN√á√ÉO PARA CARREGAR PRESEN√áAS ---
        async function carregarPresencas() {
            try {
                const response = await fetch(`${API_URL}/presencas/aluno/${userId}`);
                const data = await response.json();

                if (data.success) {
                    renderizarTabela(data.estatisticas);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('Erro ao carregar presen√ßas:', error);
                document.getElementById('corpoTabelaPresencas').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #d32f2f;">
                            Erro ao carregar informa√ß√µes de presen√ßa
                        </td>
                    </tr>
                `;
            }
        }

        // --- FUN√á√ÉO PARA RENDERIZAR TABELA ---
        function renderizarTabela(estatisticas) {
            const tbody = document.getElementById('corpoTabelaPresencas');
            
            if (estatisticas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px;">
                            Voc√™ ainda n√£o est√° matriculado em nenhuma turma
                        </td>
                    </tr>
                `;
                return;
            }

            let totalFrequencia = 0;
            let countTurmas = 0;

            tbody.innerHTML = estatisticas.map(stat => {
                totalFrequencia += stat.frequenciaAtual;
                countTurmas++;

                const statusColor = stat.status === 'REGULAR' ? '#4caf50' : '#f44336';

                return `
                    <tr>
                        <td>
                            <strong>${stat.turma.nome}</strong><br>
                            <small style="color: #666;">${stat.turma.curso}</small>
                        </td>
                        <td>${stat.cargaHoraria}h</td>
                        <td>${stat.aulasDadas}</td>
                        <td style="color: ${stat.faltas > stat.faltasPermitidas ? '#f44336' : '#333'}; font-weight: ${stat.faltas > stat.faltasPermitidas ? 'bold' : 'normal'};">
                            ${stat.faltas}
                        </td>
                        <td>${stat.faltasPermitidas}</td>
                        <td style="font-weight: bold; color: ${stat.frequenciaAtual >= 75 ? '#4caf50' : '#f44336'};">
                            ${stat.frequenciaAtual.toFixed(2)}%
                        </td>
                        <td>${stat.frequenciaMinima}%</td>
                        <td style="color: ${statusColor}; font-weight: bold;">
                            ${stat.status}
                        </td>
                    </tr>
                `;
            }).join('');

            // Calcula m√©dia geral
            const mediaGeral = countTurmas > 0 ? (totalFrequencia / countTurmas).toFixed(2) : 0;
            const mediaColor = mediaGeral >= 75 ? '#4caf50' : '#f44336';
            
            document.getElementById('mediaGeral').innerHTML = `
                Frequ√™ncia M√©dia Geral: <span style="font-weight: bold; color: ${mediaColor};">${mediaGeral}%</span>
            `;
        }

        // Carrega as presen√ßas quando a p√°gina carregar
        if (userId) {
            carregarPresencas();
        } else {
            document.getElementById('corpoTabelaPresencas').innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #d32f2f;">
                        Usu√°rio n√£o autenticado. Por favor, fa√ßa login novamente.
                    </td>
                </tr>
            `;
        }

        // --- GERENCIAMENTO DE DROPDOWNS ---
        // Adiciona l√≥gica de clique para mostrar/esconder
        const dropNotif = document.getElementById('dropdownNotif');
        const dropConfig = document.getElementById('dropdownConfig');
        const dropPerfil = document.getElementById('dropdownPerfil');

        function fecharTodos() {
            if(dropNotif) dropNotif.classList.remove('ativo');
            if(dropConfig) dropConfig.classList.remove('ativo');
            if(dropPerfil) dropPerfil.classList.remove('ativo');
        }

        // Bot√µes
        document.querySelector('.btn-notificao-nav').addEventListener('click', (e) => {
            e.stopPropagation();
            const estaAberto = dropNotif.classList.contains('ativo');
            fecharTodos();
            if(!estaAberto) dropNotif.classList.add('ativo');
        });

        document.querySelector('.btn-config').addEventListener('click', (e) => {
            e.stopPropagation();
            const estaAberto = dropConfig.classList.contains('ativo');
            fecharTodos();
            if(!estaAberto) dropConfig.classList.add('ativo');
        });

        document.getElementById('fotoPerfil').addEventListener('click', (e) => {
            e.stopPropagation();
            const estaAberto = dropPerfil.classList.contains('ativo');
            fecharTodos();
            if(!estaAberto) dropPerfil.classList.add('ativo');
        });

        // Fechar nos bot√µes X
        document.querySelectorAll('.btn-fechar').forEach(btn => {
            btn.addEventListener('click', fecharTodos);
        });

        // Fechar ao clicar fora
        window.addEventListener('click', () => {
            fecharTodos();
        });

        // A√ß√µes dos bot√µes dentro dos dropdowns
        document.querySelectorAll('[data-action]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const action = e.target.getAttribute('data-action');
                if (action === 'sair-da-conta') {
                    if(confirm('Tem certeza que deseja sair?')) {
                        localStorage.removeItem('user');
                        localStorage.removeItem('usuarioLogado');
                        window.location.href = '/public/home.html';
                    }
                }
            });
        });
    </script>
</body>
</html>