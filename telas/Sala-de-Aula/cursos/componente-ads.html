    <!DOCTYPE html>
    <html lang="pt-br">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sala de Aula</title>
        <link rel="stylesheet" href="../css-Sala/estilo_componente.css">
        
    </head>
    <body>
        <nav class="navegacao">
            <div class="menu">
                <div class="menu-1">
                    <img src="../imagens-Sala/lotus.svg" alt="Logo da institui√ß√£o" class="projeto" width="30px" height="30px">
                </div>
                <div class="menu-2">
                    <input type="text" placeholder="Pesquise aqui...">
                </div> 
                <div class="menu-3">
                    <img src="../imagens-sala/sininho.svg" alt="notifica√ß√£o" class="btn-notificao-nav">
                    <img src="../imagens-sala/configuracao.svg" alt="bot√£o de configura√ß√£o" class="btn-config">
                    <img src="../imagens-sala/foto_de_perfil.png" alt="imagem de perfil" class="foto-de-perfil" width="30px" height="30px">
                    
                    <div class="dropdown-notificacoes" id="dropdownNotif">
                        <div class="dropdown-header">
                            <div class="dropdown-titulo">
                                <img src="../imagens-sala/sino-black.svg" alt="Notifica√ß√£o">
                                <span>Notifica√ß√µes</span>
                            </div>
                            <button class="btn-fechar" data-action="fechar-notif">&times;</button>
                        </div>
                        <div class="dropdown-opcoes">
                            <div class="notificacao-vazia">Nenhuma notifica√ß√£o no momento</div>
                        </div>
                    </div>

                    <div class="dropdown-configuracoes" id="dropdownConfig">
                        <div class="dropdown-header">
                            <div class="dropdown-titulo">
                                <img src="../imagens-sala/configuracao-black.svg" alt="Configura√ß√£o">
                                <span>Configura√ß√µes</span>
                            </div>
                            <button class="btn-fechar" data-action="fechar-config">&times;</button>
                        </div>
                        <div class="dropdown-opcoes">
                            <button class="opcao-item" data-action="abrir-tema">Tema</button>
                            <button class="opcao-item" data-action="abrir-acessibilidade">Acessibilidade</button>
                            <button class="opcao-item" data-action="abrir-opcoes-avancadas">Op√ß√µes avan√ßadas</button>
                        </div>
                    </div>

                    <div class="dropdown-perfil" id="dropdownPerfil">
                        <div class="dropdown-header">
                            <div class="dropdown-titulo">
                                <img src="../imagens-sala/foto_de_perfil.png" alt="Perfil" class="perfil-mini">
                                <span id="nomeUsuarioPerfil">Ol√°, Rodrigo</span>
                            </div>
                            <button class="btn-fechar" data-action="fechar-perfil">&times;</button>
                        </div>
                        <div class="dropdown-opcoes">
                            <button class="opcao-item" data-action="abrir-seu-perfil">Seu perfil</button>
                            <button class="opcao-item" data-action="abrir-privacidade">Privacidade</button>
                            <button class="opcao-item" data-action="abrir-ajuda-recursos">Ajuda e Recursos</button>
                            <button class="opcao-item sair-conta" data-action="sair-da-conta">Sair da Conta</button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="nome-da-guia">
            <ul>
                <li><a href="/telas/Rede/connect.html">Redes</a></li>
                <li><a href="/telas/Sala-de-Aula/sala.html">Sala de Aula</a></li>
                <li><a href="/telas/Trilhas/trilhas.html">Trilhas</a></li>
                <li><a href="/telas/Diario/diario.html">Di√°rio</a></li>
            </ul>
        </div>

        <main>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-content">
                    <div class="expand-section">
                        <div class="expand-button" id="expandButton">
                            <svg class="expand-icon" viewBox="0 0 24 24">
                                <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/>
                            </svg>
                            <span class="expand-text" id="expandText">Expandir</span>
                        </div>
                    </div>
                    <nav class="nav-menu">
                        <div class="nav-item active" data-tela="visao">
                            <svg class="nav-icon" viewBox="0 0 24 24">
                                <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
                            </svg>
                            <span class="nav-text visao-geral-text">Vis√£o<br>Geral</span>
                        </div>
                        <div class="nav-item" data-tela="tarefa">
                            <svg class="nav-icon" viewBox="0 0 24 24">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                            <span class="nav-text">Tarefas</span>
                        </div>
                        <div class="nav-item" data-tela="postagens">
                            <svg class="nav-icon" viewBox="0 0 24 24">
                                <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19Z"/>
                            </svg>
                            <span class="nav-text">Postagens</span>
                        </div>
                        <div class="nav-item" data-tela="arquivo">
                            <svg class="nav-icon" viewBox="0 0 24 24">
                                <path d="M6,2A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2H6Z"/>
                            </svg>
                            <span class="nav-text">Arquivos</span>
                        </div>
                        <div class="nav-item" data-tela="membros">
                            <svg class="nav-icon" viewBox="0 0 24 24">
                                <path d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25Z"/>
                            </svg>
                            <span class="nav-text">Membros</span>
                        </div>
                    </nav>
                </div>
            </div>

            <div class="container-principal">
                <div class="conteudo-visao-geral" id="conteudoVisao">
                    <img src="../imagens-sala/Banner_Titulo_se√ß√£o_Visao.svg" alt="Banner" class="banner visao-geral" id="banner">
                    
                    <div class="vis-o-geral">
                        <div class="descri-o">
                            <div class="card-componente">    
                                <div class="nome-logo"> 
                                    <div class="sigla-componente">
                                        <div class="se">SE</div>
                                    </div>
                                    <div class="separador"></div>
                                    <div class="nome-componente">
                                        <div class="sistemas-embarados">Sistemas Embarcados</div>
                                    </div>
                                </div>
                            </div>
                            <div class="descri-o-componente">
                                <div class="descri-o2">
                                    <div class="descri-o3">Descri√ß√£o</div>
                                </div>
                                <div class="texto-descri-o">
                                    <div class="texto">
                                        <div class="descri-o-do-seu-componente-sera-descrito-bem-aqui-mesmo">
                                            Disciplina voltada para o estudo e desenvolvimento de sistemas embarcados utilizando microcontroladores.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tarefa">
                            <div class="tarefa2">
                                <div class="tarefa3">Tarefas</div>
                            </div>
                            <div id="btnCriarContainer" style="padding: 15px;"></div>
                            <div class="tarefas-viss-o-geral" id="tarefasVisaoGeral">
                                <div class="mensagem-vazia">Carregando atividades...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="conteudo-tarefas desativado" id="conteudoTarefas">
                    <img src="../imagens-sala/Banner_Titulo_se√ß√£o-Tarefa.svg" alt="Banner Tarefas" class="banner tarefas">
                    
                    <div class="filtros-tarefas">
                        <button class="btn-filtro ativo" data-filtro="todas">Todas</button>
                        <button class="btn-filtro" data-filtro="pendente">Pendentes</button>
                        <button class="btn-filtro" data-filtro="atraso">Em Atraso</button>
                        <button class="btn-filtro" data-filtro="concluida">Conclu√≠das</button>
                    </div>

                    <div id="tarefasPorStatus"></div>
                </div>

                <div class="conteudo-postagens desativado" id="conteudoPostagens">
                    <img src="../imagens-sala/Titulo_se√ß√£o_Postagens.svg" alt="Banner Postagens" class="banner">
                    <div class="mensagem-vazia">Em desenvolvimento...</div>
                </div>

                <div class="conteudo-arquivo desativado" id="conteudoArquivo">
                    <img src="../imagens-sala/Titulo_se√ß√£o_arquivos.svg" alt="Banner Arquivos" class="banner">
                    <div class="mensagem-vazia">Em desenvolvimento...</div>
                </div>

                <div class="conteudo-membros desativado" id="conteudoMembros">
                    <img src="../imagens-sala/Titulo_se√ß√£o_Membros.svg" alt="Banner Membros" class="banner">
                    <div class="mensagem-vazia">Em desenvolvimento...</div>
                </div>
            </div>
        </main>

        <div class="modal-criar" id="modalCriar">
            <div class="modal-content">
                <h2>‚ûï Criar Nova Atividade</h2>
                <form id="formCriarAtividade">
                    <div class="form-group">
                        <label for="tituloAtividade">T√≠tulo *</label>
                        <input type="text" id="tituloAtividade" required>
                    </div>
                    <div class="form-group">
                        <label for="descricaoAtividade">Descri√ß√£o</label>
                        <textarea id="descricaoAtividade"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="dataEntregaAtividade">Data de Entrega</label>
                        <input type="datetime-local" id="dataEntregaAtividade">
                    </div>
                    <div class="form-group">
                        <label for="arquivoAtividade">üìé Anexar Arquivo (opcional)</label>
                        <input type="file" id="arquivoAtividade" accept=".pdf,.doc,.docx,.txt,.zip,.rar,.jpg,.jpeg,.png">
                        <div class="arquivo-info" id="arquivoInfo">
                            üìÑ <span class="arquivo-nome" id="arquivoNome"></span>
                            <button type="button" class="btn-remover-arquivo" onclick="removerArquivo()">‚úï Remover</button>
                        </div>
                    </div>
                    <div class="modal-botoes">
                        <button type="button" class="btn-modal btn-cancelar" onclick="fecharModal()">Cancelar</button>
                        <button type="submit" class="btn-modal btn-salvar">Salvar</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="modal-detalhes" id="modalDetalhes">
            <div class="detalhes-content">
                <div class="detalhes-header"> 
                    <h2 id="detalheTitulo">Carregando...</h2>
                    <button class="btn-fechar-detalhes" onclick="fecharDetalhes(event)">‚úï</button> 
                    <button class="btn-entregar-modal" id="btnEntregarDetalhes" style="display: none;">
                        üì§ Entregar Atividade
                    </button>
                </div>
                <div class="detalhes-body" id="detalheBody">
                    <div style="text-align: center; padding: 40px;">
                        <p>Carregando detalhes...</p>
                    </div>
                </div>
            </div>
        </div>

        <script>
    // ===============================================
    // SCRIPT COMPLETO E DIN√ÇMICO PARA P√ÅGINA DE TURMA
    // Substitua TODO o <script> pelo c√≥digo abaixo
    // ===============================================

    const API_URL = 'http://localhost:3000/api';

    // ===============================================
    // OBTER turmaId DA URL
    // ===============================================
    function obterTurmaIdDaURL() {
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('turmaId');
        
        if (!id) {
            alert('‚ùå Nenhuma turma foi selecionada!');
            window.location.href = '/telas/Sala-de-Aula/sala.html';
            throw new Error('TurmaId n√£o encontrado na URL');
        }
        
        return parseInt(id);
    }

    const turmaId = obterTurmaIdDaURL();

    // ===============================================
    // VERIFICAR LOGIN
    // ===============================================
    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));

    if (!usuarioLogado || !usuarioLogado.id) {
        alert('Voc√™ precisa fazer login primeiro!');
        window.location.href = '/home.html';
        throw new Error('Usu√°rio n√£o logado');
    }

    const userId = usuarioLogado.id;
    const userName = usuarioLogado.name || 'Usu√°rio';
    const userRole = usuarioLogado.role || 'aluno';

    let dadosTurma = null;
    let todasAtividades = [];
    let todasPostagens = [];
    let todosArquivos = [];
    let todosMembros = [];
    let filtroAtivo = 'todas';
    let arquivoSelecionado = null;

    console.log('üî• Sistema carregado!');
    console.log('User:', userName, 'Role:', userRole, 'TurmaId:', turmaId);

    // ===============================================
    // CARREGAR DADOS DA TURMA
    // ===============================================
    async function carregarDadosTurma() {
        try {
            console.log('üîç Carregando dados da turma:', turmaId);
            console.log('üîó URL da API:', `${API_URL}/turmas/${turmaId}`);
            
            const response = await fetch(`${API_URL}/turmas/${turmaId}`);
            
            console.log('üì° Status da resposta:', response.status);
            
            if (!response.ok) {
                throw new Error(`Erro ao carregar turma: ${response.status}`);
            }
            
            const dados = await response.json();
            console.log('üì¶ Dados recebidos da API:', dados);
            
            // Tentar diferentes estruturas de resposta da API
            dadosTurma = dados.turma || dados.data || dados;
            
            console.log('‚úÖ Dados da turma processados:', dadosTurma);
            
            // Se n√£o tiver dados essenciais, usar fallback
            if (!dadosTurma || !dadosTurma.id) {
                throw new Error('Dados da turma incompletos');
            }
            
            atualizarInterfaceTurma();
            
        } catch (error) {
            console.error('‚ùå Erro ao carregar dados da turma:', error);
            console.warn('‚ö†Ô∏è Usando dados de fallback tempor√°rios');
            
            // FALLBACK: Dados tempor√°rios para n√£o redirecionar
            dadosTurma = {
                id: turmaId,
                nome: 'Turma ' + turmaId,
                sigla: 'T' + turmaId,
                descricao: 'Carregando dados da turma...',
                cor: '#667eea',
                corTexto: '#FFFFFF'
            };
            
            atualizarInterfaceTurma();
            
            // REMOVIDO O LOOP INFINITO - N√£o vai mais tentar recarregar automaticamente
            console.log('üí° Dica: Verifique se o endpoint /api/turmas/' + turmaId + ' existe no backend');
        }
    }

    // ===============================================
    // ATUALIZAR INTERFACE COM DADOS DA TURMA
    // ===============================================
    function atualizarInterfaceTurma() {
        if (!dadosTurma) {
            console.error('‚ùå dadosTurma est√° vazio!');
            return;
        }
        
        console.log('üé® Atualizando interface com:', dadosTurma);
        
        // Atualizar SIGLA
        const siglaElement = document.querySelector('.se');
        if (siglaElement) {
            siglaElement.textContent = dadosTurma.sigla || 'SALA';
            console.log('‚úÖ Sigla atualizada:', dadosTurma.sigla);
        } else {
            console.warn('‚ö†Ô∏è Elemento .se n√£o encontrado');
        }
        
        // Atualizar NOME DA TURMA
        const nomeElement = document.querySelector('.sistemas-embarados');
        if (nomeElement) {
            nomeElement.textContent = dadosTurma.nome || 'Nome da Turma';
            console.log('‚úÖ Nome atualizado:', dadosTurma.nome);
        } else {
            console.warn('‚ö†Ô∏è Elemento .sistemas-embarados n√£o encontrado');
        }
        
        // Atualizar DESCRI√á√ÉO
        const descricaoElement = document.querySelector('.descri-o-do-seu-componente-sera-descrito-bem-aqui-mesmo');
        if (descricaoElement) {
            descricaoElement.textContent = dadosTurma.descricao || 'Sem descri√ß√£o dispon√≠vel.';
            console.log('‚úÖ Descri√ß√£o atualizada');
        } else {
            console.warn('‚ö†Ô∏è Elemento de descri√ß√£o n√£o encontrado');
        }
        
        // Atualizar COR DA SIGLA
        const siglaContainer = document.querySelector('.sigla-componente');
        if (siglaContainer && dadosTurma.cor) {
            siglaContainer.style.backgroundColor = dadosTurma.cor;
            siglaContainer.style.color = dadosTurma.corTexto || '#FFFFFF';
            console.log('‚úÖ Cores atualizadas:', dadosTurma.cor, dadosTurma.corTexto);
        } else {
            console.warn('‚ö†Ô∏è Elemento .sigla-componente n√£o encontrado ou sem cor');
        }
        
        // Atualizar T√çTULO DA P√ÅGINA (usando NOME ao inv√©s de SIGLA)
        document.title = `${dadosTurma.nome || 'Sala de Aula'}`;
        
        console.log('‚úÖ Interface totalmente atualizada!');
    }

    // ===============================================
    // CARREGAR FOTO DE PERFIL
    // ===============================================
    async function carregarFotoPerfilComponente() {
        try {
            const fotoPerfilNav = document.querySelector('.foto-de-perfil');
            const fotoPerfilMini = document.querySelector('.perfil-mini');
            const URL_PADRAO = '../imagens-sala/foto_de_perfil.png';
            
            if (!fotoPerfilNav || !fotoPerfilMini) {
                console.warn('‚ö†Ô∏è Elementos de foto de perfil n√£o encontrados');
                return;
            }
            
            const response = await fetch(`${API_URL}/users/${userId}`);
            const data = await response.json();
            
            if (data.success && data.user) {
                const fotoUrl = data.user.perfilUrl 
                    ? `http://localhost:3000${data.user.perfilUrl}` 
                    : URL_PADRAO;
                
                fotoPerfilNav.src = fotoUrl;
                fotoPerfilMini.src = fotoUrl;
                
                const nomeElement = document.getElementById('nomeUsuarioPerfil');
                if (nomeElement) {
                    nomeElement.textContent = `Ol√°, ${data.user.name || userName}`;
                }
                
                localStorage.setItem('usuarioLogado', JSON.stringify(data.user));
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar foto de perfil:', error);
            const fotoPerfilNav = document.querySelector('.foto-de-perfil');
            const fotoPerfilMini = document.querySelector('.perfil-mini');
            const URL_PADRAO = '../imagens-sala/foto_de_perfil.png';
            
            if (fotoPerfilNav) fotoPerfilNav.src = URL_PADRAO;
            if (fotoPerfilMini) fotoPerfilMini.src = URL_PADRAO;
        }
    }

    // ===============================================
    // INICIALIZA√á√ÉO
    // ===============================================
    document.addEventListener('DOMContentLoaded', async function() {
        carregarFotoPerfilComponente();
        await carregarDadosTurma();
        
        inicializarDropdowns();
        inicializarSidebar();
        inicializarNavegacao();
        inicializarFiltros();
        inicializarModal();
        inicializarFormularios();
        
        carregarAtividades();
        carregarPostagens();
        carregarArquivos();
        carregarMembros();
        atualizarNomeUsuario();
        
        if (userRole === 'professor') {
            adicionarBotaoCriar();
        }
    });

    // ===============================================
    // DROPDOWNS
    // ===============================================
    function inicializarDropdowns() {
        const dropdownNotif = document.getElementById('dropdownNotif');
        const dropdownConfig = document.getElementById('dropdownConfig');
        const dropdownPerfil = document.getElementById('dropdownPerfil');
        const btnNotif = document.querySelector('.btn-notificao-nav');
        const btnConfig = document.querySelector('.btn-config');
        const btnPerfil = document.querySelector('.foto-de-perfil');
        
        if (!dropdownNotif || !dropdownConfig || !dropdownPerfil || !btnNotif || !btnConfig || !btnPerfil) {
            console.error("Erro: Elementos do dropdown n√£o encontrados.");
            return;
        }

        const fecharDropdownNotif = () => dropdownNotif.classList.remove('ativo');
        const fecharDropdownConfig = () => dropdownConfig.classList.remove('ativo');
        const fecharDropdownPerfil = () => dropdownPerfil.classList.remove('ativo');
        
        btnNotif.addEventListener('click', (e) => {
            e.stopPropagation();
            fecharDropdownConfig();
            fecharDropdownPerfil();
            dropdownNotif.classList.toggle('ativo');
        });
        
        btnConfig.addEventListener('click', (e) => {
            e.stopPropagation();
            fecharDropdownNotif();
            fecharDropdownPerfil();
            dropdownConfig.classList.toggle('ativo');
        });
        
        btnPerfil.addEventListener('click', (e) => {
            e.stopPropagation();
            fecharDropdownNotif();
            fecharDropdownConfig();
            dropdownPerfil.classList.toggle('ativo');
        });
        
        document.querySelectorAll('[data-action]').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const action = this.getAttribute('data-action');
                switch(action) {
                    case 'fechar-notif': fecharDropdownNotif(); break;
                    case 'fechar-config': fecharDropdownConfig(); break;
                    case 'fechar-perfil': fecharDropdownPerfil(); break;
                    case 'sair-da-conta':
                        if (confirm('Tem certeza que deseja sair da conta?')) {
                            localStorage.removeItem('usuarioLogado');
                            localStorage.removeItem('userId');
                            localStorage.removeItem('userName');
                            localStorage.removeItem('userRole');
                            window.location.href = '/home.html';
                        }
                        fecharDropdownPerfil();
                        break;
                    case 'perfil':
                    case 'abrir-seu-perfil':
                        fecharDropdownPerfil();
                        window.location.href = '/telas/Diario/diario.html';
                        break;
                    case 'configuracoes':
                    case 'abrir-tema':
                    case 'abrir-acessibilidade':
                    case 'abrir-opcoes-avancadas':
                        fecharDropdownConfig();
                        console.log('‚öôÔ∏è Funcionalidade em desenvolvimento:', action);
                        break;
                    case 'ajuda':
                    case 'abrir-ajuda-recursos':
                        fecharDropdownConfig();
                        fecharDropdownPerfil();
                        console.log('‚ùì Central de ajuda em desenvolvimento');
                        break;
                    case 'abrir-privacidade':
                        fecharDropdownPerfil();
                        console.log('üîí Configura√ß√µes de privacidade em desenvolvimento');
                        break;
                    default:
                        console.log('Funcionalidade:', action);
                        fecharDropdownNotif();
                        fecharDropdownConfig();
                        fecharDropdownPerfil();
                }
            });
        });
        
        document.addEventListener('click', (event) => {
            const target = event.target;
            if (
                !dropdownNotif.contains(target) && target !== btnNotif &&
                !dropdownConfig.contains(target) && target !== btnConfig &&
                !dropdownPerfil.contains(target) && target !== btnPerfil
            ) {
                fecharDropdownNotif();
                fecharDropdownConfig();
                fecharDropdownPerfil();
            }
        });
    }

    // ===============================================
    // SIDEBAR
    // ===============================================
    function inicializarSidebar() {
        const sidebar = document.getElementById('sidebar');
        const expandButton = document.getElementById('expandButton');
        const expandText = document.getElementById('expandText');
        const visaoGeralText = document.querySelector('.visao-geral-text');
        
        if (!sidebar || !expandButton || !expandText || !visaoGeralText) return;

        expandButton.addEventListener('click', () => {
            sidebar.classList.toggle('expanded');
            if (sidebar.classList.contains('expanded')) {
                expandText.textContent = 'Recolher';
                visaoGeralText.innerHTML = 'Vis√£o Geral';
            } else {
                expandText.textContent = 'Expandir';
                visaoGeralText.innerHTML = 'Vis√£o<br>Geral';
            }
        });
    }

    // ===============================================
    // NAVEGA√á√ÉO
    // ===============================================
    function inicializarNavegacao() {
        const telas = {
            'visao': document.getElementById('conteudoVisao'),
            'tarefa': document.getElementById('conteudoTarefas'),
            'postagens': document.getElementById('conteudoPostagens'),
            'arquivo': document.getElementById('conteudoArquivo'),
            'membros': document.getElementById('conteudoMembros')
        };

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');

                const telaAlvo = this.getAttribute('data-tela');

                Object.values(telas).forEach(tela => {
                    if (tela) tela.classList.add('desativado');
                });

                const telaAtual = telas[telaAlvo];
                if (telaAtual) {
                    telaAtual.classList.remove('desativado');
                }

                if (telaAlvo === 'tarefa') {
                    renderizarTarefas();
                } else if (telaAlvo === 'postagens') {
                    renderizarPostagens();
                } else if (telaAlvo === 'arquivo') {
                    renderizarArquivos();
                } else if (telaAlvo === 'membros') {
                    renderizarMembros();
                }
            });
        });
    }

    // ===============================================
    // FUN√á√ïES AUXILIARES
    // ===============================================
    function atualizarNomeUsuario() {
        const nomeElement = document.getElementById('nomeUsuarioPerfil');
        if (nomeElement) nomeElement.textContent = `Ol√°, ${userName}`;
    }

    function adicionarBotaoCriar() {
        const container = document.getElementById('btnCriarContainer');
        if (container) {
            container.innerHTML = `<button id="btnCriarAtividade" class="btn-criar-atividade">‚ûï Criar Atividade</button>`;
            
            const btnCriar = document.getElementById('btnCriarAtividade');
            if (btnCriar) {
                btnCriar.addEventListener('click', () => abrirModal());
            }
        }
    }

    function abrirModal(atividadeId = null) {
        const modal = document.getElementById('modalCriar');
        if (!modal) return;
        
        const titulo = document.getElementById('tituloModal');
        const btnSalvar = modal.querySelector('.btn-salvar');
        
        if (atividadeId) {
            const atividade = todasAtividades.find(a => a.id === atividadeId);
            if (!atividade) return;
            
            if (titulo) titulo.textContent = '‚úèÔ∏è Editar Atividade';
            if (btnSalvar) btnSalvar.textContent = 'üíæ Salvar Altera√ß√µes';
            
            document.getElementById('tituloAtividade').value = atividade.titulo;
            document.getElementById('descricaoAtividade').value = atividade.descricao;
            
            const prazoDate = new Date(atividade.prazo);
            const prazoFormatado = prazoDate.toISOString().slice(0, 16);
            document.getElementById('dataEntregaAtividade').value = prazoFormatado;
            
            modal.dataset.editandoId = atividadeId;
        } else {
            if (titulo) titulo.textContent = '‚ûï Criar Nova Atividade';
            if (btnSalvar) btnSalvar.textContent = '‚úÖ Criar Atividade';
            limparFormulario();
            delete modal.dataset.editandoId;
        }
        
        modal.classList.add('ativo');
    }

    function fecharModal() {
        const modal = document.getElementById('modalCriar');
        if (modal) modal.classList.remove('ativo');
        limparFormulario();
    }

    function limparFormulario() {
        const form = document.getElementById('formCriarAtividade');
        if (form) form.reset();
        removerArquivo();
    }

    function removerArquivo() {
        const input = document.getElementById('arquivoAtividade');
        if (input) input.value = '';
        
        const info = document.getElementById('arquivoInfo');
        const nome = document.getElementById('arquivoNome');
        
        if (info) info.classList.remove('ativo');
        if (nome) nome.textContent = '';
        
        arquivoSelecionado = null;
    }

    function fecharDetalhes(event) {
        if (event) {
            event.stopPropagation();
        }
        const modal = document.getElementById('modalDetalhes');
        if (modal) modal.classList.remove('ativo');
    }

    // ===============================================
    // INICIALIZA√á√ÉO DE MODAIS E FORMUL√ÅRIOS
    // ===============================================
    function inicializarModal() {
        const modalCriar = document.getElementById('modalCriar');
        const modalDetalhes = document.getElementById('modalDetalhes');
        
        if (modalCriar) {
            modalCriar.addEventListener('click', (e) => {
                if (e.target === modalCriar) {
                    fecharModal();
                }
            });
        }
        
        if (modalDetalhes) {
            modalDetalhes.addEventListener('click', (e) => {
                if (e.target === modalDetalhes) {
                    fecharDetalhes();
                }
            });
            
            const btnFecharX = modalDetalhes.querySelector('.btn-fechar-detalhes');
            if (btnFecharX) {
                btnFecharX.addEventListener('click', fecharDetalhes);
            }
        }
    }

    function inicializarFormularios() {
        const arquivoInput = document.getElementById('arquivoAtividade');
        if (arquivoInput) {
            arquivoInput.addEventListener('change', function() {
                const info = document.getElementById('arquivoInfo');
                const nome = document.getElementById('arquivoNome');
                
                if (this.files && this.files.length > 0) {
                    const arquivo = this.files[0];
                    arquivoSelecionado = {
                        nome: arquivo.name,
                        tamanho: arquivo.size,
                        tipo: arquivo.type
                    };
                    if (nome) nome.textContent = arquivo.name;
                    if (info) info.classList.add('ativo');
                } else {
                    removerArquivo();
                }
            });
        }
        
        const btnRemoverArq = document.querySelector('#arquivoInfo .btn-remover-arquivo');
        if (btnRemoverArq) {
            btnRemoverArq.addEventListener('click', removerArquivo);
        }
        
        const formCriar = document.getElementById('formCriarAtividade');
        if (formCriar) {
            formCriar.addEventListener('submit', function(e) {
                e.preventDefault();
                const modal = document.getElementById('modalCriar');
                const editandoId = modal.dataset.editandoId;
                
                if (editandoId) {
                    editarAtividade(parseInt(editandoId));
                } else {
                    criarNovaAtividade();
                }
            });
        }
        
        const btnCancelar = document.querySelector('#modalCriar .btn-cancelar');
        if (btnCancelar) {
            btnCancelar.addEventListener('click', fecharModal);
        }
    }

    // ===============================================
    // GERENCIAMENTO DE ATIVIDADES
    // ===============================================
    function carregarAtividades() {
        const atividadesSalvas = localStorage.getItem('atividades_turma_' + turmaId);
        
        if (atividadesSalvas) {
            todasAtividades = JSON.parse(atividadesSalvas);
        } else {
            todasAtividades = [
                { 
                    id: 1, 
                    titulo: "Atividade de Exemplo", 
                    prazo: new Date(Date.now() + 86400000 * 7).toISOString(), 
                    descricao: "Esta √© uma atividade de exemplo para esta turma.", 
                    arquivo: null,
                    entregas: [],
                    criadoEm: new Date().toISOString()
                }
            ];
            salvarAtividades();
        }

        todasAtividades.sort((a, b) => {
            const dataA = new Date(a.criadoEm || a.prazo).getTime();
            const dataB = new Date(b.criadoEm || b.prazo).getTime();
            return dataB - dataA;
        });

        if (userRole === 'professor') {
            const atividadesDestaque = todasAtividades.filter(a => {
                const statusProf = getStatusProfessor(a);
                const hoje = new Date();
                const dataPrazo = new Date(a.prazo);
                const diasRestantes = Math.ceil((dataPrazo - hoje) / (1000 * 60 * 60 * 24));
                
                return diasRestantes <= 3 || statusProf.totalEntregas < 15;
            });
            renderizarTarefasVisaoGeral(atividadesDestaque.slice(0, 3));
        } else {
            const atividadesParaVisao = todasAtividades.filter(a => {
                const status = getStatus(a.prazo, a);
                return status === 'pendente' || status === 'atraso';
            });
            renderizarTarefasVisaoGeral(atividadesParaVisao);
        }
        
        renderizarTarefas();
    }

    function salvarAtividades() {
        localStorage.setItem('atividades_turma_' + turmaId, JSON.stringify(todasAtividades));
    }

    function criarNovaAtividade() {
        const titulo = document.getElementById('tituloAtividade').value.trim();
        const descricao = document.getElementById('descricaoAtividade').value.trim();
        const prazo = document.getElementById('dataEntregaAtividade').value;
        
        if (!titulo) {
            alert('Por favor, preencha o t√≠tulo da atividade.');
            return;
        }
        
        const novaAtividade = {
            id: Date.now(),
            titulo: titulo,
            descricao: descricao || 'Sem descri√ß√£o',
            prazo: prazo ? new Date(prazo).toISOString() : new Date(Date.now() + 86400000 * 7).toISOString(),
            arquivo: arquivoSelecionado ? { nome: arquivoSelecionado.nome } : null,
            entregas: [],
            criadoEm: new Date().toISOString()
        };
        
        todasAtividades.unshift(novaAtividade);
        salvarAtividades();
        
        fecharModal();
        carregarAtividades();
        
        alert('‚úÖ Atividade criada com sucesso!');
    }

    function editarAtividade(atividadeId) {
        const atividade = todasAtividades.find(a => a.id === atividadeId);
        if (!atividade) return;
        
        const titulo = document.getElementById('tituloAtividade').value.trim();
        const descricao = document.getElementById('descricaoAtividade').value.trim();
        const prazo = document.getElementById('dataEntregaAtividade').value;
        
        if (!titulo) {
            alert('Por favor, preencha o t√≠tulo da atividade.');
            return;
        }
        
        atividade.titulo = titulo;
        atividade.descricao = descricao || 'Sem descri√ß√£o';
        atividade.prazo = prazo ? new Date(prazo).toISOString() : atividade.prazo;
        
        if (arquivoSelecionado) {
            atividade.arquivo = { nome: arquivoSelecionado.nome };
        }
        
        salvarAtividades();
        fecharModal();
        carregarAtividades();
        
        alert('‚úÖ Atividade atualizada com sucesso!');
    }

    function excluirAtividade(atividadeId) {
        if (!confirm('Tem certeza que deseja excluir esta atividade? Esta a√ß√£o n√£o pode ser desfeita.')) {
            return;
        }
        
        const index = todasAtividades.findIndex(a => a.id === atividadeId);
        if (index !== -1) {
            todasAtividades.splice(index, 1);
            salvarAtividades();
            carregarAtividades();
            fecharDetalhes();
            alert('‚úÖ Atividade exclu√≠da com sucesso!');
        }
    }

    function adiarAtividade(atividadeId) {
        const atividade = todasAtividades.find(a => a.id === atividadeId);
        if (!atividade) return;
        
        const diasAdiar = prompt('Quantos dias deseja adiar o prazo?', '7');
        if (!diasAdiar || isNaN(diasAdiar)) return;
        
        const dias = parseInt(diasAdiar);
        const novoPrazo = new Date(atividade.prazo);
        novoPrazo.setDate(novoPrazo.getDate() + dias);
        
        atividade.prazo = novoPrazo.toISOString();
        
        salvarAtividades();
        carregarAtividades();
        
        alert(`‚úÖ Prazo adiado em ${dias} dias! Novo prazo: ${formatarData(atividade.prazo)}`);
        
        abrirDetalhes(atividadeId);
    }

    function entregarAtividade(atividadeId) {
        const atividade = todasAtividades.find(a => a.id === atividadeId);
        if (!atividade) return;
        
        const modalHTML = `
            <div id="modalEntrega" class="modal-criar ativo">
                <div class="modal-content">
                    <h2>üì§ Entregar Atividade</h2>
                    <form id="formEntregarAtividade">
                        <div class="form-group">
                            <label for="comentarioEntrega">Coment√°rio sobre a entrega</label>
                            <textarea id="comentarioEntrega" placeholder="Adicione observa√ß√µes sobre sua entrega..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="arquivoEntrega">üìé Anexar Arquivo (opcional)</label>
                            <input type="file" id="arquivoEntrega" accept=".pdf,.doc,.docx,.txt,.zip,.rar,.jpg,.jpeg,.png,.c,.cpp,.py,.js">
                            <div class="arquivo-info" id="arquivoInfoEntrega">
                                üìÑ <span class="arquivo-nome" id="arquivoNomeEntrega"></span>
                                <button type="button" class="btn-remover-arquivo" id="btnRemoverArqEntrega">‚úï Remover</button>
                            </div>
                        </div>
                        <div class="modal-botoes">
                            <button type="button" class="btn-modal btn-cancelar" id="btnCancelarEntrega">Cancelar</button>
                            <button type="submit" class="btn-modal btn-salvar">‚úÖ Confirmar Entrega</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        const modalExistente = document.getElementById('modalEntrega');
        if (modalExistente) modalExistente.remove();
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        const arquivoInput = document.getElementById('arquivoEntrega');
        arquivoInput.addEventListener('change', function() {
            const info = document.getElementById('arquivoInfoEntrega');
            const nome = document.getElementById('arquivoNomeEntrega');
            
            if (this.files && this.files.length > 0) {
                nome.textContent = this.files[0].name;
                info.classList.add('ativo');
            }
        });
        
        document.getElementById('btnRemoverArqEntrega').addEventListener('click', function() {
            arquivoInput.value = '';
            document.getElementById('arquivoInfoEntrega').classList.remove('ativo');
            document.getElementById('arquivoNomeEntrega').textContent = '';
        });
        
        document.getElementById('btnCancelarEntrega').addEventListener('click', function() {
            document.getElementById('modalEntrega').remove();
        });
        
        const form = document.getElementById('formEntregarAtividade');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const comentario = document.getElementById('comentarioEntrega').value.trim();
            const arquivoInput = document.getElementById('arquivoEntrega');
            
            const entrega = {
                alunoId: userId,
                alunoNome: userName,
                data: new Date().toISOString(),
                comentario: comentario || 'Sem coment√°rio',
                arquivo: arquivoInput.files.length > 0 ? { nome: arquivoInput.files[0].name } : null,
                nota: null,
                feedback: ''
            };
            
            if (!atividade.entregas) {
                atividade.entregas = [];
            }
            
            const entregaExistente = atividade.entregas.findIndex(e => e.alunoId === userId);
            if (entregaExistente !== -1) {
                if (!confirm('Voc√™ j√° entregou esta atividade. Deseja reenviar?')) {
                    return;
                }
                const notaAnterior = atividade.entregas[entregaExistente].nota;
                const feedbackAnterior = atividade.entregas[entregaExistente].feedback;
                entrega.nota = notaAnterior;
                entrega.feedback = feedbackAnterior;
                atividade.entregas[entregaExistente] = entrega;
            } else {
                atividade.entregas.push(entrega);
            }
            
            salvarAtividades();
            carregarAtividades();
            document.getElementById('modalEntrega').remove();
            fecharDetalhes();
            
            alert('‚úÖ Atividade entregue com sucesso!');
        });
    }

    function salvarNota(atividadeId, alunoId, nota, feedback) {
        const atividade = todasAtividades.find(a => a.id === atividadeId);
        if (!atividade) return;
        
        const entrega = atividade.entregas.find(e => e.alunoId === alunoId);
        if (!entrega) return;
        
        entrega.nota = nota;
        entrega.feedback = feedback;
        
        salvarAtividades();
        
        alert(`‚úÖ Nota ${nota}/10 salva com sucesso para ${entrega.alunoNome}!`);
        
        abrirDetalhes(atividadeId);
    }

    function getStatus(prazo, atividadeCompleta) {
        const hoje = new Date();
        const dataPrazo = new Date(prazo);
        
        if (userRole === 'professor') {
            return dataPrazo < hoje ? 'expirada' : 'aberta';
        }
        
        const minhaEntrega = atividadeCompleta?.entregas?.find(e => e.alunoId === userId);
        if (minhaEntrega) return 'concluida';
        
        if (dataPrazo < hoje) return 'atraso';
        return 'pendente';
    }

    function getStatusProfessor(atividade) {
        const totalEntregas = atividade.entregas?.length || 0;
        const hoje = new Date();
        const dataPrazo = new Date(atividade.prazo);
        const prazoExpirou = dataPrazo < hoje;
        
        const totalAlunos = todosMembros.filter(m => 
            m.tipo === 'aluno' || m.role === 'aluno' || (!m.tipo && !m.role)
        ).length || 30;
        
        return {
            totalEntregas: totalEntregas,
            totalAlunos: totalAlunos,
            prazoExpirou: prazoExpirou,
            statusTexto: prazoExpirou ? 'Prazo Encerrado' : 'Em Andamento'
        };
    }

    function formatarData(isoString) {
        const data = new Date(isoString);
        return data.toLocaleDateString('pt-BR', { 
            day: '2-digit', 
            month: '2-digit', 
            year: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        });
    }

    // ===============================================
    // RENDERIZA√á√ÉO DE CARDS
    // ===============================================
    function criarCardAtividade(atividade) {
        const isProfessor = userRole === 'professor';
        
        if (isProfessor) {
            const statusProf = getStatusProfessor(atividade);
            const dataFormatada = formatarData(atividade.prazo);
            const porcentagem = statusProf.totalAlunos > 0 
                ? Math.round((statusProf.totalEntregas / statusProf.totalAlunos) * 100) 
                : 0;
            
            return `
                <div class="card-atividade-dinamico" data-id="${atividade.id}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <h3>${atividade.titulo}</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span class="badge-status ${statusProf.prazoExpirou ? 'badge-atraso' : 'badge-pendente'}">
                                ${statusProf.statusTexto}
                            </span>
                            <button class="btn-editar-card" data-acao="editar" data-id="${atividade.id}" title="Editar atividade">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn-excluir-card" data-acao="excluir" data-id="${atividade.id}" title="Excluir atividade">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <p class="prazo-entrega">
                        Prazo: ${dataFormatada}
                    </p>
                    <p class="descricao-atividade">
                        ${atividade.descricao.substring(0, 80)}${atividade.descricao.length > 80 ? '...' : ''}
                    </p>
                    <div style="margin-top: 15px; padding: 12px; background: #f5f5f5; border-radius: 6px; border-left: 4px solid #2196F3;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="font-weight: bold; color: #333;">üìä Entregas</span>
                            <span style="font-weight: bold; color: #2196F3; font-size: 18px;">
                                ${statusProf.totalEntregas}/${statusProf.totalAlunos}
                            </span>
                        </div>
                        <div style="background: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: ${porcentagem === 100 ? '#4CAF50' : '#2196F3'}; height: 100%; width: ${porcentagem}%; transition: width 0.3s ease;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 12px; color: #666;">
                            <span>${porcentagem}% entregaram</span>
                            <span>${statusProf.totalAlunos - statusProf.totalEntregas} faltam</span>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 10px;">
                        <button class="btn-adiar" data-acao="adiar" data-id="${atividade.id}">
                            ‚è∞ Adiar Prazo
                        </button>
                        <button class="btn-ver-entregas" data-acao="ver-detalhes" data-id="${atividade.id}">
                            üìã Gerenciar Entregas
                        </button>
                    </div>
                </div>
            `;
        } else {
            const status = getStatus(atividade.prazo, atividade);
            const statusText = status === 'pendente' ? 'Pendente' : status === 'atraso' ? 'Em Atraso' : 'Conclu√≠da';
            const dataFormatada = formatarData(atividade.prazo);
            const minhaEntrega = atividade.entregas?.find(e => e.alunoId === userId);

            return `
                <div class="card-atividade-dinamico" data-id="${atividade.id}">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <h3 style="margin: 0; flex: 1;">${atividade.titulo}</h3>
                        <span class="badge-status badge-${status}" style="margin-left: 10px;">${statusText}</span>
                    </div>
                    <p class="prazo-entrega" style="margin: 8px 0;">
                        Prazo de Entrega: ${dataFormatada}
                    </p>
                    <p class="descricao-atividade" style="margin: 8px 0;">
                        ${atividade.descricao.substring(0, 80)}${atividade.descricao.length > 80 ? '...' : ''}
                    </p>
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-top: 15px;">
                        <button class="btn-ver-detalhes" data-acao="ver-detalhes" data-id="${atividade.id}" style="flex: 1; padding: 10px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            üìã Ver Detalhes
                        </button>
                        ${minhaEntrega ? 
                            `<span class="status-entregue" style="padding: 10px 20px; background: #D4EDDA; color: #155724; border-radius: 6px; font-weight: bold; white-space: nowrap;">‚úÖ Entregue</span>` :
                            `<button class="btn-entregar" data-acao="entregar" data-id="${atividade.id}" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap;">üì§ Entregar</button>`
                        }
                    </div>
                </div>
            `;
        }
    }

    function inicializarCardsAtividade() {
        document.querySelectorAll('.card-atividade-dinamico').forEach(card => {
            card.addEventListener('click', function(event) {
                const target = event.target;
                
                const btnAcao = target.closest('[data-acao]');
                if (btnAcao) {
                    event.stopPropagation();
                    const acao = btnAcao.getAttribute('data-acao');
                    const id = parseInt(btnAcao.getAttribute('data-id'));
                    
                    if (acao === 'ver-detalhes') {
                        abrirDetalhes(id);
                    } else if (acao === 'entregar') {
                        entregarAtividade(id);
                    } else if (acao === 'editar') {
                        abrirModal(id);
                    } else if (acao === 'excluir') {
                        excluirAtividade(id);
                    } else if (acao === 'adiar') {
                        adiarAtividade(id);
                    }
                } else {
                    const atividadeId = parseInt(this.getAttribute('data-id'));
                    if (atividadeId) {
                        abrirDetalhes(atividadeId);
                    }
                }
            });
        });
    }

    // ===============================================
    // RENDERIZA√á√ÉO DE TAREFAS
    // ===============================================
    function renderizarTarefasVisaoGeral(atividades) {
        const container = document.getElementById('tarefasVisaoGeral');
        if (!container) return;

        if (atividades.length === 0) {
            container.innerHTML = `<div class="mensagem-vazia">üéâ Nenhuma tarefa pendente para o momento!</div>`;
            return;
        }

        container.innerHTML = atividades.slice(0, 3).map(criarCardAtividade).join('');
        inicializarCardsAtividade();
    }

    // ===============================================
    // MODAL DE DETALHES (CONTINUA...)
    // ===============================================
    function abrirDetalhes(id) {
        const atividade = todasAtividades.find(a => a.id === id);
        if (!atividade) return;

        const modal = document.getElementById('modalDetalhes');
        const titulo = document.getElementById('detalheTitulo');
        const corpo = document.getElementById('detalheBody');
        const btnEntregar = document.getElementById('btnEntregarDetalhes');
        const isProfessor = userRole === 'professor';
        const status = getStatus(atividade.prazo, atividade);
        const minhaEntrega = atividade.entregas?.find(e => e.alunoId === userId);
        
        if (titulo) titulo.textContent = atividade.titulo;

        const btnFecharX = modal.querySelector('.btn-fechar-detalhes');
        
        if (isProfessor) {
            btnEntregar.style.display = 'none';
            if (btnFecharX) btnFecharX.style.display = 'block';
        } else if (minhaEntrega) {
            btnEntregar.style.display = 'none';
            if (btnFecharX) btnFecharX.style.display = 'block';
        } else {
            if (btnFecharX) btnFecharX.style.display = 'none';
            
            btnEntregar.textContent = 'üì§ Entregar Atividade';
            btnEntregar.style.display = 'block';
            
            const novoBtn = btnEntregar.cloneNode(true);
            btnEntregar.parentNode.replaceChild(novoBtn, btnEntregar);
            novoBtn.addEventListener('click', function() {
                entregarAtividade(id);
            });
        }

        let corpoHTML = `
            <div class="secao-detalhes">
                <h3>Descri√ß√£o e Informa√ß√µes</h3>
                <div class="info-item">
                    <span class="info-label">Descri√ß√£o</span>
                    <span class="info-value">${atividade.descricao}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Prazo de Entrega</span>
                    <span class="info-value">${formatarData(atividade.prazo)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Status</span>
                    <span class="info-value"><span class="badge-status badge-${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span></span>
                </div>
            </div>
        `;
        
        if (atividade.arquivo) {
            corpoHTML += `
                <div class="secao-detalhes">
                    <h3>Arquivo Anexado</h3>
                    <div class="arquivo-anexado">
                        <span class="arquivo-icon">üìé</span>
                        <div class="arquivo-info-detalhe">
                            <span class="arquivo-nome-detalhe">${atividade.arquivo.nome}</span>
                            <span class="arquivo-tipo">Tipo: ${atividade.arquivo.nome.split('.').pop().toUpperCase()}</span>
                        </div>
                        <button class="btn-download" data-acao="download" data-arquivo="${atividade.arquivo.nome}">
                            üì• Download
                        </button>
                    </div>
                </div>
            `;
        }
        
        if (isProfessor) {
            corpoHTML += `
                <div class="secao-detalhes">
                    <h3>A√ß√µes do Professor</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn-editar-detalhes" data-acao="editar-detalhes" data-id="${id}" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            ‚úèÔ∏è Editar Atividade
                        </button>
                        <button class="btn-adiar-detalhes" data-acao="adiar-detalhes" data-id="${id}" style="background: #FF9800; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            ‚è∞ Adiar Prazo
                        </button>
                        <button class="btn-excluir-detalhes" data-acao="excluir-detalhes" data-id="${id}" style="background: #F44336; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                            üóëÔ∏è Excluir Atividade
                        </button>
                    </div>
                </div>
            `;
            
            const entregas = atividade.entregas || [];
            corpoHTML += `
                <div class="secao-detalhes">
                    <h3>Entregas dos Alunos (${entregas.length})</h3>
                    <div class="lista-entregas">
            `;
            
            if (entregas.length === 0) {
                corpoHTML += `<div class="nenhuma-entrega">Nenhuma entrega ainda.</div>`;
            } else {
                entregas.forEach(entrega => {
                    const temNota = entrega.nota !== undefined && entrega.nota !== null;
                    corpoHTML += `
                        <div class="entrega-item">
                            <div class="entrega-header">
                                <span class="entrega-aluno">Aluno: ${entrega.alunoNome}</span>
                                <span class="entrega-data">Entregue em: ${formatarData(entrega.data)}</span>
                            </div>
                            <div class="entrega-comentario">${entrega.comentario}</div>
                            ${entrega.arquivo ? `
                                <div style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 6px;">
                                    üìé <strong>Arquivo:</strong> ${entrega.arquivo.nome}
                                </div>
                            ` : ''}
                            <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 6px; border-left: 4px solid ${temNota ? '#4CAF50' : '#FFA726'};">
                                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                    <div style="flex: 1; min-width: 150px;">
                                        <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">
                                            üìù Nota (0 a 10):
                                        </label>
                                        <input 
                                            type="number" 
                                            min="0" 
                                            max="10" 
                                            step="0.5" 
                                            value="${entrega.nota || ''}" 
                                            placeholder="0.0"
                                            class="input-nota"
                                            data-entrega-aluno="${entrega.alunoId}"
                                            data-atividade-id="${atividade.id}"
                                            style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; font-weight: bold; text-align: center;"
                                        >
                                    </div>
                                    <div style="flex: 2; min-width: 200px;">
                                        <label style="display: block; font-weight: bold; margin-bottom: 5px; color: #333;">
                                            üí¨ Feedback:
                                        </label>
                                        <textarea 
                                            placeholder="Escreva um feedback para o aluno..."
                                            class="textarea-feedback"
                                            data-entrega-aluno="${entrega.alunoId}"
                                            data-atividade-id="${atividade.id}"
                                            style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; min-height: 60px; resize: vertical; font-family: Arial, sans-serif;"
                                        >${entrega.feedback || ''}</textarea>
                                    </div>
                                    <button 
                                        class="btn-salvar-nota" 
                                        data-entrega-aluno="${entrega.alunoId}"
                                        data-atividade-id="${atividade.id}"
                                        style="padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;">
                                        ‚úÖ Salvar Avalia√ß√£o
                                    </button>
                                </div>
                                ${temNota ? `
                                    <div style="margin-top: 10px; padding: 10px; background: #D4EDDA; border-radius: 6px; color: #155724;">
                                        ‚úì Avalia√ß√£o salva: Nota ${entrega.nota}/10
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            corpoHTML += `
                    </div>
                </div>
            `;
        } else if (minhaEntrega) {
            const temNota = minhaEntrega.nota !== undefined && minhaEntrega.nota !== null;
            corpoHTML += `
                <div class="secao-detalhes">
                    <h3>Sua Entrega</h3>
                    <div class="info-item" style="background: #D4EDDA;">
                        <span class="info-label">Status da Entrega</span>
                        <span class="info-value status-entregue">‚úÖ Entregue em: ${formatarData(minhaEntrega.data)}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Coment√°rio</span>
                        <span class="info-value">${minhaEntrega.comentario}</span>
                    </div>
                    ${minhaEntrega.arquivo ? `
                        <div class="info-item">
                            <span class="info-label">Arquivo Enviado</span>
                            <span class="info-value">üìé ${minhaEntrega.arquivo.nome}</span>
                        </div>
                    ` : ''}
                    ${temNota ? `
                        <div class="info-item" style="background: #E3F2FD; border-left: 4px solid #2196F3;">
                            <span class="info-label">üìä Nota Recebida</span>
                            <span class="info-value" style="font-size: 24px; font-weight: bold; color: #1976D2;">
                                ${minhaEntrega.nota}/10
                            </span>
                        </div>
                        ${minhaEntrega.feedback ? `
                            <div class="info-item" style="background: #FFF9C4;">
                                <span class="info-label">üí¨ Feedback do Professor</span>
                                <span class="info-value">${minhaEntrega.feedback}</span>
                            </div>
                        ` : ''}
                    ` : `
                        <div class="info-item" style="background: #FFF3E0;">
                            <span class="info-label">üìä Avalia√ß√£o</span>
                            <span class="info-value" style="color: #F57C00;">‚è≥ Aguardando corre√ß√£o do professor</span>
                        </div>
                    `}
                </div>
            `;
        } else {
            corpoHTML += `
                <div class="secao-detalhes">
                    <h3>Sua Entrega</h3>
                    <div class="info-item" style="background: #F8D7DA;">
                        <span class="info-label">Status da Entrega</span>
                        <span class="info-value" style="color: #721C24;">‚ùå Pendente</span>
                    </div>
                    <button class="btn-entregar" data-acao="entregar-modal" data-id="${id}" style="width: 100%; margin-top: 15px;">
                        üì§ Entregar Atividade
                    </button>
                </div>
            `;
        }

        if (corpo) corpo.innerHTML = corpoHTML;
        
        setTimeout(() => {
            const btnDownload = corpo.querySelector('[data-acao="download"]');
            if (btnDownload) {
                btnDownload.addEventListener('click', function() {
                    const arquivo = this.getAttribute('data-arquivo');
                    alert(`Download de ${arquivo} simulado!`);
                });
            }
            
            const btnEntregarModal = corpo.querySelector('[data-acao="entregar-modal"]');
            if (btnEntregarModal) {
                btnEntregarModal.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    entregarAtividade(id);
                });
            }
            
            if (isProfessor) {
                const btnEditarDetalhes = corpo.querySelector('[data-acao="editar-detalhes"]');
                if (btnEditarDetalhes) {
                    btnEditarDetalhes.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        fecharDetalhes();
                        abrirModal(id);
                    });
                }
                
                const btnAdiarDetalhes = corpo.querySelector('[data-acao="adiar-detalhes"]');
                if (btnAdiarDetalhes) {
                    btnAdiarDetalhes.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        adiarAtividade(id);
                    });
                }
                
                const btnExcluirDetalhes = corpo.querySelector('[data-acao="excluir-detalhes"]');
                if (btnExcluirDetalhes) {
                    btnExcluirDetalhes.addEventListener('click', function() {
                        const id = parseInt(this.getAttribute('data-id'));
                        excluirAtividade(id);
                    });
                }
                
                const btnsSalvarNota = corpo.querySelectorAll('.btn-salvar-nota');
                btnsSalvarNota.forEach(btn => {
                    btn.addEventListener('click', function() {
                        const alunoId = this.getAttribute('data-entrega-aluno');
                        const atividadeId = parseInt(this.getAttribute('data-atividade-id'));
                        
                        const inputNota = corpo.querySelector(`.input-nota[data-entrega-aluno="${alunoId}"][data-atividade-id="${atividadeId}"]`);
                        const textareaFeedback = corpo.querySelector(`.textarea-feedback[data-entrega-aluno="${alunoId}"][data-atividade-id="${atividadeId}"]`);
                        
                        if (inputNota && textareaFeedback) {
                            const nota = parseFloat(inputNota.value);
                            const feedback = textareaFeedback.value.trim();
                            
                            if (isNaN(nota) || nota < 0 || nota > 10) {
                                alert('Por favor, insira uma nota v√°lida entre 0 e 10.');
                                return;
                            }
                            
                            salvarNota(atividadeId, alunoId, nota, feedback);
                        }
                    });
                });
            }
        }, 0);
        
        if (modal) modal.classList.add('ativo');
    }

    // ===============================================
    // SISTEMA DE POSTAGENS
    // ===============================================
    function carregarPostagens() {
        const postagensSalvas = localStorage.getItem('postagens_turma_' + turmaId);
        
        if (postagensSalvas) {
            todasPostagens = JSON.parse(postagensSalvas);
        } else {
            todasPostagens = [];
            salvarPostagens();
        }
        
        renderizarPostagens();
    }

    function salvarPostagens() {
        localStorage.setItem('postagens_turma_' + turmaId, JSON.stringify(todasPostagens));
    }

    function renderizarPostagens() {
        const container = document.getElementById('conteudoPostagens');
        if (!container) return;
        
        let html = '';
        
        if (userRole === 'professor') {
            html += `
                <div style="padding: 20px;">
                    <button id="btnCriarPostagem" class="btn-criar-atividade">
                        ‚úèÔ∏è Nova Postagem
                    </button>
                </div>
            `;
        }
        
        html += '<div style="padding: 20px;">';
        
        if (todasPostagens.length === 0) {
            html += '<div class="mensagem-vazia">Nenhuma postagem ainda.</div>';
        } else {
            const postagensOrdenadas = [...todasPostagens].sort((a, b) => 
                new Date(b.data).getTime() - new Date(a.data).getTime()
            );
            
            postagensOrdenadas.forEach(postagem => {
                const comentarios = postagem.comentarios || [];
                const comentariosHTML = comentarios.map(comentario => {
                    const podeEditar = comentario.autorId == userId;
                    const podeApagar = comentario.autorId == userId || userRole === 'professor';
                    
                    return `
                    <div id="comentario-${comentario.id}" style="background: #f0f2f5; padding: 10px; border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <div style="width: 32px; height: 32px; border-radius: 50%; overflow: hidden; background: #ddd;">
                                <img src="${comentario.avatar || '../imagens-sala/foto_de_perfil.png'}" 
                                    style="width: 100%; height: 100%; object-fit: cover;"
                                    onerror="this.src='../imagens-sala/foto_de_perfil.png'">
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: bold; font-size: 14px; color: #333;">${comentario.autor}</div>
                                <div style="font-size: 12px; color: #666;">${formatarData(comentario.data)}</div>
                            </div>
                            ${podeEditar || podeApagar ? `
                                <div style="display: flex; gap: 8px;">
                                    ${podeEditar ? `
                                        <button 
                                            onclick="editarComentario(${postagem.id}, ${comentario.id})"
                                            style="padding: 4px 8px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
                                            title="Editar coment√°rio">
                                            ‚úèÔ∏è
                                        </button>
                                    ` : ''}
                                    ${podeApagar ? `
                                        <button 
                                            onclick="apagarComentario(${postagem.id}, ${comentario.id})"
                                            style="padding: 4px 8px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;"
                                            title="Apagar coment√°rio">
                                            üóëÔ∏è
                                        </button>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div id="texto-comentario-${comentario.id}" style="padding-left: 42px; color: #333;">${comentario.texto}</div>
                        <div id="form-editar-${comentario.id}" style="display: none; padding-left: 42px; margin-top: 8px;">
                            <textarea 
                                id="textarea-editar-${comentario.id}"
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; min-height: 60px; font-family: inherit; font-size: 14px;"
                            >${comentario.texto}</textarea>
                            <div style="display: flex; justify-content: flex-end; gap: 8px; margin-top: 8px;">
                                <button 
                                    onclick="cancelarEdicaoComentario(${comentario.id})"
                                    style="padding: 6px 12px; background: #f5f5f5; color: #666; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold;">
                                    Cancelar
                                </button>
                                <button 
                                    onclick="salvarEdicaoComentario(${postagem.id}, ${comentario.id})"
                                    style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: bold;">
                                    ‚úÖ Salvar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
                
                html += `
                    <div class="card-atividade-dinamico" style="margin-bottom: 20px;" id="postagem-${postagem.id}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                            <div>
                                <h3 style="margin: 0 0 5px 0;">${postagem.titulo}</h3>
                                <div style="font-size: 13px; color: #666;">
                                    <span>üë§ ${postagem.autor}</span>
                                    <span style="margin-left: 15px;">üìÖ ${formatarData(postagem.data)}</span>
                                </div>
                            </div>
                        </div>
                        <div style="padding: 15px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; margin: 15px 0;">
                            <p style="margin: 0; line-height: 1.6; color: #333; white-space: pre-wrap;">${postagem.conteudo}</p>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div style="display: flex; align-items: center; gap: 10px; color: #666; font-size: 14px; margin-bottom: 10px; cursor: pointer;" onclick="toggleComentarios(${postagem.id})">
                                <span id="count-comentarios-${postagem.id}">üí¨ ${comentarios.length} coment√°rio${comentarios.length !== 1 ? 's' : ''}</span>
                                <span id="toggle-icon-${postagem.id}">‚ñº</span>
                            </div>
                            
                            <div id="secao-comentarios-${postagem.id}" style="display: none; margin-top: 15px;">
                                <div id="lista-comentarios-${postagem.id}" style="margin-bottom: 15px; max-height: 400px; overflow-y: auto;">
                                    ${comentariosHTML || '<div style="color: #999; font-style: italic; padding: 10px;">Nenhum coment√°rio ainda. Seja o primeiro a comentar!</div>'}
                                </div>
                                
                                <div style="display: flex; gap: 10px; align-items: start; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 2px solid #e0e0e0;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; background: #ddd; flex-shrink: 0;">
                                        <img id="avatar-comentario-${postagem.id}" 
                                            src="../imagens-sala/foto_de_perfil.png" 
                                            style="width: 100%; height: 100%; object-fit: cover;"
                                            onerror="this.src='../imagens-sala/foto_de_perfil.png'">
                                    </div>
                                    <div style="flex: 1;">
                                        <textarea 
                                            id="input-comentario-${postagem.id}" 
                                            placeholder="Escreva um coment√°rio..."
                                            style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; resize: vertical; min-height: 60px; font-family: inherit; font-size: 14px;"
                                        ></textarea>
                                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 8px;">
                                            <button 
                                                onclick="cancelarComentario(${postagem.id})"
                                                style="padding: 8px 16px; background: #f5f5f5; color: #666; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                                Cancelar
                                            </button>
                                            <button 
                                                onclick="adicionarComentario(${postagem.id})"
                                                style="padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                                                üí¨ Comentar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        }
        
        html += '</div>';
        
        // CORRE√á√ÉO APLICADA AQUI:
        const content = container;
        content.innerHTML = html;
        
        setTimeout(async () => {
            try {
                const response = await fetch(`${API_URL}/users/${userId}`);
                const data = await response.json();
                
                if (data.success && data.user && data.user.perfilUrl) {
                    const avatarUrl = `http://localhost:3000${data.user.perfilUrl}`;
                    
                    todasPostagens.forEach(postagem => {
                        const avatarImg = document.getElementById(`avatar-comentario-${postagem.id}`);
                        if (avatarImg) {
                            avatarImg.src = avatarUrl;
                        }
                    });
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel carregar avatar do usu√°rio');
            }
        }, 0);
        
        if (userRole === 'professor') {
            const btnCriarPost = document.getElementById('btnCriarPostagem');
            if (btnCriarPost) {
                btnCriarPost.addEventListener('click', abrirModalPostagem);
            }
        }
    }

    function toggleComentarios(postagemId) {
        const secao = document.getElementById(`secao-comentarios-${postagemId}`);
        const icon = document.getElementById(`toggle-icon-${postagemId}`);
        
        if (secao.style.display === 'none') {
            secao.style.display = 'block';
            icon.textContent = '‚ñ≤';
        } else {
            secao.style.display = 'none';
            icon.textContent = '‚ñº';
        }
    }

    async function adicionarComentario(postagemId) {
        const textarea = document.getElementById(`input-comentario-${postagemId}`);
        const texto = textarea.value.trim();
        
        if (!texto) {
            alert('Por favor, escreva um coment√°rio antes de enviar.');
            return;
        }
        
        let avatarUrl = '../imagens-sala/foto_de_perfil.png';
        try {
            const response = await fetch(`${API_URL}/users/${userId}`);
            const data = await response.json();
            
            if (data.success && data.user && data.user.perfilUrl) {
                avatarUrl = `http://localhost:3000${data.user.perfilUrl}`;
            }
        } catch (error) {
            console.warn('‚ö†Ô∏è Usando avatar padr√£o');
        }
        
        const postagem = todasPostagens.find(p => p.id === postagemId);
        if (!postagem) return;
        
        const novoComentario = {
            id: Date.now(),
            texto: texto,
            autor: userName,
            autorId: userId,
            avatar: avatarUrl,
            data: new Date().toISOString()
        };
        
        if (!postagem.comentarios) {
            postagem.comentarios = [];
        }
        
        postagem.comentarios.push(novoComentario);
        salvarPostagens();
        
        textarea.value = '';
        renderizarPostagens();
        
        setTimeout(() => {
            const secao = document.getElementById(`secao-comentarios-${postagemId}`);
            const icon = document.getElementById(`toggle-icon-${postagemId}`);
            if (secao && icon) {
                secao.style.display = 'block';
                icon.textContent = '‚ñ≤';
            }
        }, 100);
    }

    function cancelarComentario(postagemId) {
        const textarea = document.getElementById(`input-comentario-${postagemId}`);
        textarea.value = '';
    }

    function editarComentario(postagemId, comentarioId) {
        const textoDiv = document.getElementById(`texto-comentario-${comentarioId}`);
        const formDiv = document.getElementById(`form-editar-${comentarioId}`);
        
        if (textoDiv && formDiv) {
            textoDiv.style.display = 'none';
            formDiv.style.display = 'block';
        }
    }

    function cancelarEdicaoComentario(comentarioId) {
        const textoDiv = document.getElementById(`texto-comentario-${comentarioId}`);
        const formDiv = document.getElementById(`form-editar-${comentarioId}`);
        
        if (textoDiv && formDiv) {
            textoDiv.style.display = 'block';
            formDiv.style.display = 'none';
        }
    }

    function salvarEdicaoComentario(postagemId, comentarioId) {
        const textarea = document.getElementById(`textarea-editar-${comentarioId}`);
        const novoTexto = textarea.value.trim();
        
        if (!novoTexto) {
            alert('O coment√°rio n√£o pode estar vazio.');
            return;
        }
        
        const postagem = todasPostagens.find(p => p.id === postagemId);
        if (!postagem) return;
        
        const comentario = postagem.comentarios.find(c => c.id === comentarioId);
        if (!comentario) return;
        
        comentario.texto = novoTexto;
        salvarPostagens();
        renderizarPostagens();
        
        setTimeout(() => {
            const secao = document.getElementById(`secao-comentarios-${postagemId}`);
            const icon = document.getElementById(`toggle-icon-${postagemId}`);
            if (secao && icon) {
                secao.style.display = 'block';
                icon.textContent = '‚ñ≤';
            }
        }, 100);
    }

    function apagarComentario(postagemId, comentarioId) {
        if (!confirm('Tem certeza que deseja apagar este coment√°rio?')) {
            return;
        }
        
        const postagem = todasPostagens.find(p => p.id === postagemId);
        if (!postagem) return;
        
        postagem.comentarios = postagem.comentarios.filter(c => c.id !== comentarioId);
        salvarPostagens();
        renderizarPostagens();
        
        setTimeout(() => {
            const secao = document.getElementById(`secao-comentarios-${postagemId}`);
            const icon = document.getElementById(`toggle-icon-${postagemId}`);
            if (secao && icon) {
                secao.style.display = 'block';
                icon.textContent = '‚ñ≤';
            }
        }, 100);
    }

    function abrirModalPostagem() {
        const modalHTML = `
            <div id="modalPostagem" class="modal-criar ativo">
                <div class="modal-content">
                    <h2>‚úèÔ∏è Nova Postagem</h2>
                    <form id="formCriarPostagem">
                        <div class="form-group">
                            <label for="tituloPostagem">T√≠tulo *</label>
                            <input type="text" id="tituloPostagem" required>
                        </div>
                        <div class="form-group">
                            <label for="conteudoPostagem">Conte√∫do *</label>
                            <textarea id="conteudoPostagem" required style="min-height: 150px;"></textarea>
                        </div>
                        <div class="modal-botoes">
                            <button type="button" class="btn-modal btn-cancelar" id="btnCancelarPostagem">Cancelar</button>
                            <button type="submit" class="btn-modal btn-salvar">üì§ Publicar</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        document.getElementById('btnCancelarPostagem').addEventListener('click', function() {
            document.getElementById('modalPostagem').remove();
        });
        
        document.getElementById('formCriarPostagem').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const titulo = document.getElementById('tituloPostagem').value.trim();
            const conteudo = document.getElementById('conteudoPostagem').value.trim();
            
            if (!titulo || !conteudo) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            const novaPostagem = {
                id: Date.now(),
                titulo: titulo,
                conteudo: conteudo,
                autor: userName,
                autorId: userId,
                data: new Date().toISOString(),
                comentarios: []
            };
            
            todasPostagens.push(novaPostagem);
            salvarPostagens();
            renderizarPostagens();
            document.getElementById('modalPostagem').remove();
            alert('‚úÖ Postagem publicada com sucesso!');
        });
    }

    // ===============================================
    // SISTEMA DE ARQUIVOS
    // ===============================================
    function carregarArquivos() {
        const arquivosSalvos = localStorage.getItem('arquivos_turma_' + turmaId);
        
        if (arquivosSalvos) {
            todosArquivos = JSON.parse(arquivosSalvos);
        } else {
            todosArquivos = [];
            salvarArquivos();
        }
        
        renderizarArquivos();
    }

    function salvarArquivos() {
        localStorage.setItem('arquivos_turma_' + turmaId, JSON.stringify(todosArquivos));
    }

    function renderizarArquivos() {
        const container = document.getElementById('conteudoArquivo');
        if (!container) return;
        
        let html = '';
        
        if (userRole === 'professor') {
            html += `
                <div style="padding: 20px;">
                    <button id="btnAdicionarArquivo" class="btn-criar-atividade">
                        üìé Adicionar Arquivo
                    </button>
                </div>
            `;
        }
        
        html += '<div style="padding: 20px;">';
        
        if (todosArquivos.length === 0) {
            html += '<div class="mensagem-vazia">Nenhum arquivo dispon√≠vel.</div>';
        } else {
            const arquivosOrdenados = [...todosArquivos].sort((a, b) => 
                new Date(b.dataUpload).getTime() - new Date(a.dataUpload).getTime()
            );
            
            arquivosOrdenados.forEach(arquivo => {
                const icone = getIconeArquivo(arquivo.tipo);
                html += `
                    <div class="card-atividade-dinamico" style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 48px;">${icone}</div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 5px 0;">${arquivo.nome}</h3>
                                <div style="font-size: 13px; color: #666;">
                                    <span>üì¶ ${arquivo.tamanho}</span>
                                    <span style="margin-left: 15px;">üìÖ ${formatarData(arquivo.dataUpload)}</span>
                                    <span style="margin-left: 15px;">üë§ ${arquivo.autor}</span>
                                </div>
                            </div>
                            <button class="btn-download" data-arquivo-id="${arquivo.id}" style="white-space: nowrap;">
                                üì• Baixar
                            </button>
                        </div>
                    </div>
                `;
            });
        }
        
        html += '</div>';
        
        // CORRE√á√ÉO APLICADA AQUI:
        const content = container;
        content.innerHTML = html;
        
        setTimeout(() => {
            if (userRole === 'professor') {
                const btnAddArquivo = document.getElementById('btnAdicionarArquivo');
                if (btnAddArquivo) {
                    btnAddArquivo.addEventListener('click', abrirModalArquivo);
                }
            }
            
            document.querySelectorAll('.btn-download').forEach(btn => {
                btn.addEventListener('click', function() {
                    const arquivoId = parseInt(this.getAttribute('data-arquivo-id'));
                    const arquivo = todosArquivos.find(a => a.id === arquivoId);
                    if (arquivo) {
                        alert(`üì• Download de "${arquivo.nome}" iniciado!`);
                    }
                });
            });
        }, 0);
    }

    function getIconeArquivo(tipo) {
        const icones = {
            'pdf': 'üìÑ',
            'doc': 'üìù',
            'docx': 'üìù',
            'ppt': 'üìä',
            'pptx': 'üìä',
            'xls': 'üìä',
            'xlsx': 'üìä',
            'zip': 'üì¶',
            'rar': 'üì¶',
            'jpg': 'üñºÔ∏è',
            'jpeg': 'üñºÔ∏è',
            'png': 'üñºÔ∏è',
            'txt': 'üìÉ'
        };
        return icones[tipo.toLowerCase()] || 'üìé';
    }

    function abrirModalArquivo() {
        const modalHTML = `
            <div id="modalArquivo" class="modal-criar ativo">
                <div class="modal-content">
                    <h2>üìé Adicionar Arquivo</h2>
                    <form id="formAdicionarArquivo">
                        <div class="form-group">
                            <label for="arquivoUpload">Selecione o arquivo *</label>
                            <input type="file" id="arquivoUpload" required accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip,.rar,.jpg,.jpeg,.png,.txt">
                            <div class="arquivo-info" id="arquivoInfoUpload">
                                üìÑ <span class="arquivo-nome" id="arquivoNomeUpload"></span>
                                <button type="button" class="btn-remover-arquivo" id="btnRemoverArqUpload">‚úï Remover</button>
                            </div>
                        </div>
                        <div class="modal-botoes">
                            <button type="button" class="btn-modal btn-cancelar" id="btnCancelarArquivo">Cancelar</button>
                            <button type="submit" class="btn-modal btn-salvar">‚úÖ Adicionar</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        const arquivoInput = document.getElementById('arquivoUpload');
        arquivoInput.addEventListener('change', function() {
            const info = document.getElementById('arquivoInfoUpload');
            const nome = document.getElementById('arquivoNomeUpload');
            
            if (this.files && this.files.length > 0) {
                nome.textContent = this.files[0].name;
                info.classList.add('ativo');
            }
        });
        
        document.getElementById('btnRemoverArqUpload').addEventListener('click', function() {
            arquivoInput.value = '';
            document.getElementById('arquivoInfoUpload').classList.remove('ativo');
            document.getElementById('arquivoNomeUpload').textContent = '';
        });
        
        document.getElementById('btnCancelarArquivo').addEventListener('click', function() {
            document.getElementById('modalArquivo').remove();
        });
        
        document.getElementById('formAdicionarArquivo').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!arquivoInput.files || arquivoInput.files.length === 0) {
                alert('Por favor, selecione um arquivo.');
                return;
            }
            
            const arquivo = arquivoInput.files[0];
            const tamanhoMB = (arquivo.size / (1024 * 1024)).toFixed(1);
            const extensao = arquivo.name.split('.').pop();
            
            const novoArquivo = {
                id: Date.now(),
                nome: arquivo.name,
                tipo: extensao,
                tamanho: `${tamanhoMB} MB`,
                dataUpload: new Date().toISOString(),
                autor: userName
            };
            
            todosArquivos.push(novoArquivo);
            salvarArquivos();
            renderizarArquivos();
            document.getElementById('modalArquivo').remove();
            alert('‚úÖ Arquivo adicionado com sucesso!');
        });
    }

    // ===============================================
    // SISTEMA DE MEMBROS
    // ===============================================
    async function carregarMembros() {
        try {
            console.log('üîç Carregando membros da turma', turmaId);
            
            // 1Ô∏è‚É£ BUSCAR DADOS DA TURMA (para pegar o professor)
            let professorDaTurma = null;
            try {
                const turmaResponse = await fetch(`${API_URL}/turmas/${turmaId}`);
                if (turmaResponse.ok) {
                    const turmaData = await turmaResponse.json();
                    const turma = turmaData.turma || turmaData.data || turmaData;
                    
                    if (turma && turma.professorId) {
                        console.log('üë®‚Äçüè´ Professor ID encontrado na turma:', turma.professorId);
                        
                        // Buscar dados completos do professor
                        const profResponse = await fetch(`${API_URL}/users/${turma.professorId}`);
                        const profData = await profResponse.json();
                        
                        if (profData.success && profData.user) {
                            professorDaTurma = {
                                id: profData.user.id,
                                nome: profData.user.name,
                                email: profData.user.email,
                                tipo: 'professor',
                                avatar: profData.user.perfilUrl 
                                    ? `http://localhost:3000${profData.user.perfilUrl}` 
                                    : null,
                                matricula: null
                            };
                            console.log('‚úÖ Professor carregado:', professorDaTurma.nome);
                        }
                    }
                }
            } catch (err) {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel carregar o professor da turma:', err);
            }
            
            // 2Ô∏è‚É£ BUSCAR ALUNOS DA TURMA
            const response = await fetch(`${API_URL}/turmas/${turmaId}/membros`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                console.warn('‚ö†Ô∏è API de membros retornou erro:', response.status);
                throw new Error(`API n√£o dispon√≠vel: ${response.status}`);
            }
            
            const dados = await response.json();
            console.log('‚úÖ Resposta da API de membros (alunos):', dados);
            
            let alunosDaTurma = [];
            
            if (dados.membros && Array.isArray(dados.membros)) {
                // Buscar dados completos de cada aluno
                alunosDaTurma = await Promise.all(dados.membros.map(async (membro) => {
                    try {
                        const userResponse = await fetch(`${API_URL}/users/${membro.id || membro.alunoId}`);
                        const userData = await userResponse.json();
                        
                        if (userData.success && userData.user) {
                            return {
                                id: userData.user.id,
                                nome: userData.user.name || membro.nome || 'Nome n√£o dispon√≠vel',
                                email: userData.user.email || 'Email n√£o dispon√≠vel',
                                tipo: 'aluno', // For√ßar como aluno
                                avatar: userData.user.perfilUrl 
                                    ? `http://localhost:3000${userData.user.perfilUrl}` 
                                    : null,
                                matricula: membro.matricula || null
                            };
                        } else {
                            return {
                                id: membro.id || membro.alunoId,
                                nome: membro.nome || membro.name || 'Nome n√£o dispon√≠vel',
                                email: membro.email || 'Email n√£o dispon√≠vel',
                                tipo: 'aluno',
                                avatar: null,
                                matricula: membro.matricula || null
                            };
                        }
                    } catch (err) {
                        console.warn(`‚ö†Ô∏è Erro ao carregar dados do aluno ${membro.id}:`, err);
                        return {
                            id: membro.id || membro.alunoId,
                            nome: membro.nome || membro.name || 'Nome n√£o dispon√≠vel',
                            email: membro.email || 'Email n√£o dispon√≠vel',
                            tipo: 'aluno',
                            avatar: null,
                            matricula: membro.matricula || null
                        };
                    }
                }));
            }
            
            // 3Ô∏è‚É£ JUNTAR PROFESSOR + ALUNOS
            todosMembros = [];
            
            if (professorDaTurma) {
                todosMembros.push(professorDaTurma);
            }
            
            todosMembros = [...todosMembros, ...alunosDaTurma];
            
            console.log('‚úÖ Total de membros (professor + alunos):', todosMembros.length);
            console.log('üìã Membros finais:', todosMembros);
            
            renderizarMembros();
            
        } catch (error) {
            console.error('‚ùå Erro ao carregar membros:', error);
            console.log('üí° Tentando buscar apenas o usu√°rio logado como fallback...');
            
            // FALLBACK: Carregar apenas o usu√°rio logado
            try {
                const response = await fetch(`${API_URL}/users/${userId}`);
                const data = await response.json();
                
                if (data.success && data.user) {
                    todosMembros = [{
                        id: data.user.id,
                        nome: data.user.name,
                        email: data.user.email,
                        tipo: data.user.role,
                        avatar: data.user.perfilUrl ? `http://localhost:3000${data.user.perfilUrl}` : null,
                        matricula: null
                    }];
                    console.log('‚úÖ Usu√°rio logado adicionado aos membros');
                } else {
                    todosMembros = [];
                }
            } catch (err) {
                console.error('‚ùå N√£o foi poss√≠vel carregar nenhum membro');
                todosMembros = [];
            }
            
            renderizarMembros();
        }
    }

    function renderizarMembros() {
        const container = document.getElementById('conteudoMembros');
        if (!container) return;
        
        console.log('üë• ===== RENDERIZANDO MEMBROS =====');
        console.log('üìä Total de membros recebidos:', todosMembros.length);
        console.log('üìã Lista completa de membros:', todosMembros);
        
        // Log detalhado de cada membro
        todosMembros.forEach((m, index) => {
            console.log(`Membro ${index + 1}:`, {
                nome: m.nome,
                email: m.email,
                tipo: m.tipo,
                role: m.role,
                'tipo ou role': m.tipo || m.role
            });
        });
        
        const professores = todosMembros
            .filter(m => {
                const isProfessor = m.tipo === 'professor' || m.role === 'professor';
                console.log(`${m.nome} √© professor?`, isProfessor, '(tipo:', m.tipo, ', role:', m.role, ')');
                return isProfessor;
            })
            .sort((a, b) => a.nome.localeCompare(b.nome));
        
        const alunos = todosMembros
            .filter(m => {
                // Verificar se N√ÉO √© professor (ent√£o √© aluno)
                const isProfessor = m.tipo === 'professor' || m.role === 'professor';
                const isAluno = !isProfessor; // Todos que n√£o s√£o professor, s√£o alunos
                
                console.log(`${m.nome} √© aluno?`, isAluno, '(tipo:', m.tipo, ', role:', m.role, ', isProfessor:', isProfessor, ')');
                return isAluno;
            })
            .sort((a, b) => a.nome.localeCompare(b.nome));
        
        console.log('üë®‚Äçüè´ Professores filtrados:', professores.length, professores);
        console.log('üë®‚Äçüéì Alunos filtrados:', alunos.length, alunos);
        console.log('=============================');
        
        let html = '<div style="padding: 20px;">';
        
        // SE√á√ÉO DE PROFESSORES
        if (professores.length > 0) {
            html += `
                <div class="secao-tarefas" style="background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%); padding: 20px; border-radius: 12px; margin-bottom: 30px;">
                    <h2 style="display: flex; align-items: center; gap: 10px; margin: 0 0 20px 0; color: #667eea;">
                        üë®‚Äçüè´ Professores 
                        <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px;">
                            ${professores.length}
                        </span>
                    </h2>
                    <div style="display: grid; gap: 15px;">
            `;
            
            professores.forEach(prof => {
                html += criarCardMembro(prof, 'professor');
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        // SE√á√ÉO DE ALUNOS
        if (alunos.length > 0) {
            html += `
                <div class="secao-tarefas" style="background: linear-gradient(135deg, #4CAF5015 0%, #45B7D115 100%); padding: 20px; border-radius: 12px;">
                    <h2 style="display: flex; align-items: center; gap: 10px; margin: 0 0 20px 0; color: #4CAF50;">
                        üë• Alunos 
                        <span style="background: #4CAF50; color: white; padding: 4px 12px; border-radius: 20px; font-size: 14px;">
                            ${alunos.length}
                        </span>
                    </h2>
                    <div style="display: grid; gap: 15px;">
            `;
            
            alunos.forEach(aluno => {
                html += criarCardMembro(aluno, 'aluno');
            });
            
            html += `
                    </div>
                </div>
            `;
        }
        
        // MENSAGEM SE N√ÉO HOUVER MEMBROS
        if (professores.length === 0 && alunos.length === 0) {
            html += `
                <div class="mensagem-vazia" style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 64px; margin-bottom: 20px;">üë•</div>
                    <h3 style="color: #666; margin: 0 0 10px 0;">Nenhum membro encontrado</h3>
                    <p style="color: #999; margin: 0;">Esta turma ainda n√£o possui membros cadastrados.</p>
                    <p style="color: #999; margin: 10px 0 0 0; font-size: 12px;">Verifique o console (F12) para mais detalhes</p>
                </div>
            `;
        }
        
        html += '</div>';
        
        // CORRE√á√ÉO APLICADA AQUI:
        const content = container;
        content.innerHTML = html;
        
        console.log('‚úÖ Membros renderizados com sucesso!');
    }

    function criarCardMembro(membro, tipoForcado = null) {
        const tipo = tipoForcado || membro.tipo || membro.role || 'aluno';
        const email = membro.email || 'Email n√£o dispon√≠vel'; // SEM GERAR EMAIL FAKE
        
        const fotoDefault = '../imagens-sala/foto_de_perfil.png';
        const fotoUrl = membro.avatar || fotoDefault;
        
        return `
            <div class="card-atividade-dinamico" style="padding: 15px; background: white; border: 2px solid ${tipo === 'professor' ? '#667eea' : '#4CAF50'};">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; background: #f0f0f0; flex-shrink: 0; border: 3px solid ${tipo === 'professor' ? '#667eea' : '#4CAF50'};">
                        <img src="${fotoUrl}" alt="${membro.nome}" style="width: 100%; height: 100%; object-fit: cover;" 
                            onerror="this.src='${fotoDefault}'">
                    </div>
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 8px 0; color: #333; font-size: 16px;">${membro.nome}</h3>
                        <div style="font-size: 13px; color: #666;">
                            <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                <span>üìß</span>
                                <span style="word-break: break-all;">${email}</span>
                            </div>
                            ${membro.matricula ? `
                                <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                                    <span>üéì</span>
                                    <span>Matr√≠cula: ${membro.matricula}</span>
                                </div>
                            ` : ''}
                            <div style="margin-top: 8px;">
                                <span class="badge-status ${tipo === 'professor' ? 'badge-concluida' : 'badge-pendente'}" style="font-size: 11px; padding: 4px 12px; border-radius: 12px;">
                                    ${tipo === 'professor' ? 'üë®‚Äçüè´ Professor' : 'üë®‚Äçüéì Aluno'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function inicializarFiltros() {
        document.querySelectorAll('.btn-filtro').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.btn-filtro').forEach(b => b.classList.remove('ativo'));
                this.classList.add('ativo');
                filtroAtivo = this.getAttribute('data-filtro') || 'todas';
                renderizarTarefas();
            });
        });
        
        if (userRole === 'professor') {
            const filtros = document.querySelectorAll('.btn-filtro');
            filtros.forEach(btn => {
                const filtro = btn.getAttribute('data-filtro');
                if (filtro === 'pendente') btn.textContent = 'Em Andamento';
                if (filtro === 'atraso') btn.textContent = 'Prazo Encerrado';
                if (filtro === 'concluida') btn.style.display = 'none';
            });
        }
    }

    function filtrarAtividades(filtro) {
        if (filtro === 'todas') return todasAtividades;
        
        if (userRole === 'professor') {
            if (filtro === 'pendente') {
                return todasAtividades.filter(a => {
                    const statusProf = getStatusProfessor(a);
                    return !statusProf.prazoExpirou;
                });
            }
            if (filtro === 'atraso') {
                return todasAtividades.filter(a => {
                    const statusProf = getStatusProfessor(a);
                    return statusProf.prazoExpirou;
                });
            }
            if (filtro === 'concluida') return [];
        } else {
            if (filtro === 'pendente') return todasAtividades.filter(a => getStatus(a.prazo, a) === 'pendente');
            if (filtro === 'atraso') return todasAtividades.filter(a => getStatus(a.prazo, a) === 'atraso');
            if (filtro === 'concluida') return todasAtividades.filter(a => getStatus(a.prazo, a) === 'concluida');
        }
        
        return [];
    }

    function renderizarTarefas() {
        const container = document.getElementById('tarefasPorStatus');
        if (!container) return;

        const atividadesFiltradas = filtrarAtividades(filtroAtivo);

        if (atividadesFiltradas.length === 0) {
            const filtroNome = document.querySelector(`.btn-filtro[data-filtro="${filtroAtivo}"]`)?.textContent || 'todas';
            container.innerHTML = `<div class="mensagem-vazia">Nenhuma atividade na categoria: ${filtroNome}</div>`;
            return;
        }

        if (userRole === 'professor') {
            const abertas = [];
            const encerradas = [];
            
            atividadesFiltradas.forEach(a => {
                const statusProf = getStatusProfessor(a);
                if (statusProf.prazoExpirou) {
                    encerradas.push(a);
                } else {
                    abertas.push(a);
                }
            });

            let html = '';
            
            if (abertas.length > 0) {
                html += `<div class="secao-tarefas"><h2>üü¢ Atividades em Andamento</h2>`;
                html += abertas.map(criarCardAtividade).join('');
                html += `</div>`;
            }
            
            if (encerradas.length > 0) {
                html += `<div class="secao-tarefas"><h2>üî¥ Prazo Encerrado</h2>`;
                html += encerradas.map(criarCardAtividade).join('');
                html += `</div>`;
            }

            container.innerHTML = html;
        } else {
            const grupos = {
                'pendente': [], 
                'atraso': [], 
                'concluida': []
            };
            
            atividadesFiltradas.forEach(a => {
                grupos[getStatus(a.prazo, a)].push(a);
            });

            let html = '';
            for (const status in grupos) {
                if (grupos[status].length > 0) {
                    const statusTitulo = status === 'pendente' ? 'Pendentes' : status === 'atraso' ? 'Em Atraso' : 'Conclu√≠das';
                    html += `<div class="secao-tarefas"><h2>${statusTitulo}</h2>`;
                    html += grupos[status].map(criarCardAtividade).join('');
                    html += `</div>`;
                }
            }

            container.innerHTML = html;
        }
        
        inicializarCardsAtividade();
    }

        



    
</script>

        


    </body>
    </html>