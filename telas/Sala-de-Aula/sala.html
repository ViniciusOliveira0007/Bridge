<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sala de Aula</title>
    <link rel="stylesheet" href="./css-Sala/estilo_sala.css">
    
</head>
<body>
    <!-- Navega√ß√£o mantida igual -->
    <nav class="navegacao">
        <div class="menu">
            <div class="menu-1">
                <img src="./imagens-Sala/lotus.svg" alt="Logo" class="projeto" width="30px" height="30px">
            </div>
            <div class="menu-2">
                <input type="text" placeholder="Pesquise aqui...">
            </div>
            <div class="menu-3">
                <img src="./imagens-sala/sininho.svg" alt="notifica√ß√£o" class="btn-notificao-nav">
                <img src="./imagens-sala/configuracao.svg" alt="configura√ß√£o" class="btn-config">
                <img src="./imagens-sala/foto_de_perfil.png" alt="perfil" class="foto-de-perfil">
                
                <div class="dropdown-notificacoes" id="dropdownNotif">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-sala/sino-black.svg" alt="Notifica√ß√£o">
                            <span>Notifica√ß√µes</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-notif">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <div class="notificacao-vazia">Nenhuma notifica√ß√£o no momento</div>
                    </div>
                </div>

                <div class="dropdown-configuracoes" id="dropdownConfig">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-sala/configuracao-black.svg" alt="Configura√ß√£o">
                            <span>Configura√ß√µes</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-config">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item">Configura√ß√µes</button>
                        <button class="opcao-item">Acessibilidade</button>
                        <button class="opcao-item">Op√ß√µes avan√ßadas</button>
                        
                    </div>
                </div>

                <div class="dropdown-perfil" id="dropdownPerfil">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="./imagens-sala/foto_de_perfil.png" alt="Perfil" class="perfil-mini">
                            <span id="nomeUsuarioPerfil">Ol√°, Usu√°rio</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-perfil">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item">Seu perfil</button>
                        <button class="opcao-item">Privacidade</button>
                        <button class="opcao-item">Ajuda e Recursos</button>
                        <button class="opcao-item sair-conta" data-action="sair-da-conta">Sair da Conta</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="nome-da-guia">
        <ul>
            <li><a href="../Rede/connect.html">Redes</a></li>
            <li><a href="../Sala-de-Aula/sala.html">Sala de Aula</a></li>
            <li><a href="../Trilhas/trilhas.html">Trilhas</a></li>
            <li><a href="../Diario/diario.html">Di√°rio</a></li>
        </ul>
    </div>

    <main>
        <div class="conteudo-principal">
            <img src="./imagens-sala/Banner_Titulo_se√ß√£o_Sala.svg" alt="Banner" class="banner-componentes">
        </div>
        
        <div class="container-principal-cursos">
            <div class="coluna-esquerda-cursos" id="colunaEsquerda"></div>
            <div class="coluna-direita-cursos" id="colunaDireita"></div>
        </div>
    </main>

    <button class="btn-adicionar-sala" id="btnAdicionarSala" style="display: none;">
        ‚ûï Adicionar Sala
    </button>

    <!-- Modal Adicionar Sala -->
    <div class="modal-sala" id="modalAdicionarSala">
        <div class="modal-conteudo-sala">
            <h2>‚ûï Criar Nova Sala de Aula</h2>
            
            <form id="formAdicionarSala">
                <div class="form-group-sala">
                    <label for="nomeSala">Nome da Sala *</label>
                    <input type="text" id="nomeSala" placeholder="Ex: Sistemas Embarcados - 3¬∫ Semestre" required>
                </div>

                <div class="form-group-sala">
                    <label for="siglaSala">Sigla * (m√°x. 4 caracteres)</label>
                    <input type="text" id="siglaSala" placeholder="Ex: ADS, GTI, RC" maxlength="4" required style="text-transform: uppercase;">
                </div>

                <div class="form-group-sala">
                    <label for="cursoSala">Curso *</label>
                    <select id="cursoSala" required>
                        <option value="">Selecione um curso</option>
                    </select>
                </div>

                <div class="form-group-sala">
                    <label>Escolha a Cor da Sala *</label>
                    <div class="grade-cores" id="gradeCores"></div>
                    <input type="hidden" id="corSelecionada" required>
                </div>

                <div class="preview-card">
                    <h4>üëÅÔ∏è Pr√©-visualiza√ß√£o</h4>
                    <span class="preview-sigla" id="previewSigla">SALA</span>
                </div>

                <div class="form-group-sala">
                    <label for="descricaoSala">Descri√ß√£o</label>
                    <textarea id="descricaoSala" placeholder="Descreva o conte√∫do da sala..."></textarea>
                </div>

                <div class="loading-spinner" id="loadingCriarSala">
                    <div class="spinner"></div>
                    <p>Criando sala...</p>
                </div>

                <div class="modal-botoes-sala">
                    <button type="button" class="btn-cancelar-sala" id="btnCancelarSala">Cancelar</button>
                    <button type="submit" class="btn-criar-sala">‚úÖ Criar Sala</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';

        // Paleta de cores com alto contraste
        const CORES_DISPONIVEIS = [
            { bg: '#FF6B6B', text: '#FFFFFF', nome: 'Vermelho' },
            { bg: '#4ECDC4', text: '#FFFFFF', nome: 'Turquesa' },
            { bg: '#45B7D1', text: '#FFFFFF', nome: 'Azul Claro' },
            { bg: '#FFA07A', text: '#FFFFFF', nome: 'Laranja' },
            { bg: '#98D8C8', text: '#2C3E50', nome: 'Verde Menta' },
            { bg: '#6C5CE7', text: '#FFFFFF', nome: 'Roxo' },
            { bg: '#FDCB6E', text: '#2C3E50', nome: 'Amarelo' },
            { bg: '#E17055', text: '#FFFFFF', nome: 'Coral' },
            { bg: '#00B894', text: '#FFFFFF', nome: 'Verde' },
            { bg: '#0984E3', text: '#FFFFFF', nome: 'Azul' },
            { bg: '#FD79A8', text: '#FFFFFF', nome: 'Rosa' },
            { bg: '#A29BFE', text: '#FFFFFF', nome: 'Lil√°s' }
        ];

        let coresUsadas = [];
        let corSelecionada = null;

        // Verificar login
        const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
        if (!usuarioLogado || !usuarioLogado.id) {
            alert('Voc√™ precisa fazer login primeiro!');
            window.location.href = '/home.html';
        }

        const userId = usuarioLogado.id;
        const userName = usuarioLogado.name || 'Usu√°rio';
        const userRole = usuarioLogado.role || 'aluno';
        const userPerfilUrl = usuarioLogado.perfilUrl;

        // Atualizar nome do usu√°rio
        document.getElementById('nomeUsuarioPerfil').textContent = `Ol√°, ${userName}`;

        // ‚úÖ ATUALIZAR FOTO DE PERFIL DO LOCALSTORAGE (IMEDIATO)
        if (userPerfilUrl) {
            const urlFoto = userPerfilUrl.startsWith('http') 
                ? userPerfilUrl 
                : `http://localhost:3000${userPerfilUrl}`;
            
            // Atualizar todas as imagens de perfil
            document.querySelectorAll('.foto-de-perfil').forEach(img => {
                img.src = urlFoto;
                img.onerror = () => img.src = './imagens-sala/foto_de_perfil.png';
            });
            
            const fotoPerfilDropdown = document.querySelector('.perfil-mini');
            if (fotoPerfilDropdown) {
                fotoPerfilDropdown.src = urlFoto;
                fotoPerfilDropdown.onerror = () => fotoPerfilDropdown.src = './imagens-sala/foto_de_perfil.png';
            }
        }

        // Mostrar bot√£o de adicionar sala para professores
        if (userRole === 'professor') {
            document.getElementById('btnAdicionarSala').style.display = 'block';
        }

        // ‚úÖ CARREGAR DADOS ATUALIZADOS DO USU√ÅRIO DA API
        async function carregarDadosUsuario() {
            try {
                const response = await fetch(`${API_URL}/users/${userId}`);
                if (!response.ok) throw new Error('Erro ao carregar usu√°rio');
                
                const dados = await response.json();
                const usuario = dados.user || dados;
                
                // Atualizar localStorage com dados atualizados
                const usuarioAtualizado = {
                    ...usuarioLogado,
                    name: usuario.name,
                    perfilUrl: usuario.perfilUrl
                };
                localStorage.setItem('usuarioLogado', JSON.stringify(usuarioAtualizado));
                
                // Atualizar nome
                document.getElementById('nomeUsuarioPerfil').textContent = `Ol√°, ${usuario.name || 'Usu√°rio'}`;
                
                // Atualizar foto de perfil
                if (usuario.perfilUrl) {
                    const urlFoto = usuario.perfilUrl.startsWith('http') 
                        ? usuario.perfilUrl 
                        : `http://localhost:3000${usuario.perfilUrl}`;
                    
                    const fotosPerfilNav = document.querySelectorAll('.foto-de-perfil');
                    const fotoPerfilDropdown = document.querySelector('.perfil-mini');
                    
                    fotosPerfilNav.forEach(img => {
                        img.src = urlFoto;
                        img.onerror = () => {
                            img.src = './imagens-sala/foto_de_perfil.png';
                        };
                    });
                    
                    if (fotoPerfilDropdown) {
                        fotoPerfilDropdown.src = urlFoto;
                        fotoPerfilDropdown.onerror = () => {
                            fotoPerfilDropdown.src = './imagens-sala/foto_de_perfil.png';
                        };
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usu√°rio:', error);
            }
        }

        // Renderizar grade de cores
        function renderizarGradeCores() {
            const gradeCores = document.getElementById('gradeCores');
            gradeCores.innerHTML = '';

            CORES_DISPONIVEIS.forEach((cor, index) => {
                const estaUsada = coresUsadas.includes(cor.bg);
                const opcao = document.createElement('div');
                opcao.className = `opcao-cor ${estaUsada ? 'usada' : ''}`;
                opcao.style.backgroundColor = cor.bg;
                opcao.style.color = cor.text;
                opcao.dataset.corBg = cor.bg;
                opcao.dataset.corText = cor.text;
                
                if (!estaUsada) {
                    opcao.addEventListener('click', () => selecionarCor(cor.bg, cor.text, opcao));
                }
                
                gradeCores.appendChild(opcao);
            });
        }

        function selecionarCor(bg, text, elemento) {
            document.querySelectorAll('.opcao-cor').forEach(el => el.classList.remove('selecionada'));
            elemento.classList.add('selecionada');
            
            corSelecionada = { bg, text };
            document.getElementById('corSelecionada').value = bg;
            
            atualizarPreview();
        }

        function atualizarPreview() {
            const sigla = document.getElementById('siglaSala').value.toUpperCase() || 'SALA';
            const preview = document.getElementById('previewSigla');
            
            if (corSelecionada) {
                preview.style.backgroundColor = corSelecionada.bg;
                preview.style.color = corSelecionada.text;
            }
            
            preview.textContent = sigla;
        }

        document.getElementById('siglaSala').addEventListener('input', atualizarPreview);

        async function carregarCursos() {
            try {
                const response = await fetch(`${API_URL}/cursos`);
                if (!response.ok) throw new Error('Erro ao carregar cursos');
                
                const dados = await response.json();
                const cursos = dados.cursos || dados;
                
                const select = document.getElementById('cursoSala');
                select.innerHTML = '<option value="">Selecione um curso</option>';
                
                cursos.forEach(curso => {
                    const option = document.createElement('option');
                    option.value = curso.id;
                    option.textContent = `${curso.nome} (${curso.sigla})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar cursos:', error);
            }
        }

        async function carregarSalas() {
            try {
                const response = await fetch(`${API_URL}/turmas`);
                if (!response.ok) throw new Error('Erro');
                
                const dados = await response.json();
                const turmas = dados.turmas || dados;
                
                coresUsadas = turmas.map(t => t.cor).filter(Boolean);
                renderizarSalas(turmas);
            } catch (error) {
                console.error('Erro ao carregar salas:', error);
                renderizarSalasPadrao();
            }
        }

        function renderizarSalas(turmas) {
            const colE = document.getElementById('colunaEsquerda');
            const colD = document.getElementById('colunaDireita');
            
            colE.innerHTML = '';
            colD.innerHTML = '';
            
            turmas.forEach((turma, i) => {
                const card = criarCardSala(turma);
                (i % 2 === 0 ? colE : colD).innerHTML += card;
            });
            
            document.querySelectorAll('.botao-curso').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-turma-id');
                    window.location.href = `./cursos/componente-ads.html?turmaId=${id}`;
                });
            });
        }

        function criarCardSala(turma) {
            const sigla = turma.sigla || turma.curso?.sigla || 'SALA';
            const nome = turma.nome || 'Sala sem nome';
            const desc = turma.descricao || 'Sem descri√ß√£o';
            
            const corFundo = turma.cor || '#FF6B6B';
            const corTexto = turma.corTexto || '#FFFFFF';
            
            return `
                <button class="botao-curso" data-turma-id="${turma.id}">
                    <div class="conteudo-botao-curso">
                        <div class="area-interna-curso">
                            <div class="sigla-curso" style="background-color: ${corFundo}; color: ${corTexto};">
                                <div class="texto-sigla">${sigla}</div>
                            </div>
                            <div class="area-nome-curso">
                                <div class="texto-nome-curso">${nome}</div>
                            </div>
                        </div>
                    </div>
                    <div class="descricao-deslizante">${desc}</div>
                </button>
            `;
        }

        function renderizarSalasPadrao() {
            const salas = [
                { id: 1, sigla: 'ADS', nome: 'AN√ÅLISE E DESENVOLVIMENTO DE SISTEMAS', descricao: 'Desenvolvimento de software', cor: '#FF6B6B', corTexto: '#FFFFFF' },
                { id: 2, sigla: 'GTI', nome: 'GEST√ÉO DA TECNOLOGIA DA INFORMA√á√ÉO', descricao: 'Gest√£o de TI', cor: '#4ECDC4', corTexto: '#FFFFFF' }
            ];
            renderizarSalas(salas);
        }

        // Modal
        const modal = document.getElementById('modalAdicionarSala');
        const btnAdd = document.getElementById('btnAdicionarSala');
        const btnCancel = document.getElementById('btnCancelarSala');
        const form = document.getElementById('formAdicionarSala');

        btnAdd.addEventListener('click', () => {
            modal.classList.add('ativo');
            carregarCursos();
            renderizarGradeCores();
        });

        btnCancel.addEventListener('click', () => {
            modal.classList.remove('ativo');
            form.reset();
            corSelecionada = null;
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('ativo');
                form.reset();
            }
        });

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!corSelecionada) {
                alert('‚ö†Ô∏è Escolha uma cor para a sala!');
                return;
            }
            
            const loading = document.getElementById('loadingCriarSala');
            loading.classList.add('ativo');
            
            const novaSala = {
                nome: document.getElementById('nomeSala').value,
                sigla: document.getElementById('siglaSala').value.toUpperCase(),
                cursoId: parseInt(document.getElementById('cursoSala').value),
                professorId: parseInt(userId),
                descricao: document.getElementById('descricaoSala').value,
                cor: corSelecionada.bg,
                corTexto: corSelecionada.text
            };
            
            try {
                const response = await fetch(`${API_URL}/turmas`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(novaSala)
                });
                
                if (!response.ok) throw new Error('Erro ao criar sala');
                
                alert('‚úÖ Sala criada com sucesso!');
                modal.classList.remove('ativo');
                form.reset();
                corSelecionada = null;
                carregarSalas();
            } catch (error) {
                console.error('Erro:', error);
                alert('‚ùå Erro ao criar sala.');
            } finally {
                loading.classList.remove('ativo');
            }
        });

        // Dropdowns
        const dropdownNotif = document.getElementById('dropdownNotif');
        const dropdownConfig = document.getElementById('dropdownConfig');
        const dropdownPerfil = document.getElementById('dropdownPerfil');

        document.querySelector('.btn-notificao-nav').addEventListener('click', () => {
            dropdownConfig.classList.remove('ativo');
            dropdownPerfil.classList.remove('ativo');
            dropdownNotif.classList.toggle('ativo');
        });

        document.querySelector('.btn-config').addEventListener('click', () => {
            dropdownNotif.classList.remove('ativo');
            dropdownPerfil.classList.remove('ativo');
            dropdownConfig.classList.toggle('ativo');
        });

        document.querySelector('.foto-de-perfil').addEventListener('click', () => {
            dropdownNotif.classList.remove('ativo');
            dropdownConfig.classList.remove('ativo');
            dropdownPerfil.classList.toggle('ativo');
        });

        document.querySelectorAll('[data-action]').forEach(btn => {
            btn.addEventListener('click', function() {
                const action = this.getAttribute('data-action');
                if (action === 'sair-da-conta') {
                    if (confirm('Sair?')) {
                        localStorage.clear();
                        window.location.href = '/home.html';
                    }
                }
            });
        });

        // ‚úÖ INICIALIZAR - Carregar dados do usu√°rio primeiro, depois as salas
        carregarDadosUsuario();
        carregarSalas();
    </script>
</body>
</html>