<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil Trilhas</title>
    <link rel="stylesheet" href="../estilos_trilhas/estilo_perfil_trilhas.css">
</head>
<body>

    <nav class="navegacao">
        <div class="menu">
            <div class="menu-1">
                <img src="../imagens_trilhas/lotus.svg" alt="Logo da institui√ß√£o" class="projeto" width="30px" height="30px">
            </div>
            <div class="menu-2">
                <input type="text" placeholder="Pesquise aqui...">
            </div> 
            <div class="menu-3">
                <img src="../imagens_trilhas/sininho.svg" alt="notifica√ß√£o" class="btn-notificao-nav">
                <img src="../imagens_trilhas/configuracao.svg" alt="bot√£o de configura√ß√£o" class="btn-config">
                <img src="../imagens_trilhas/foto_de_perfil.png" alt="imagem de perfil" class="foto-de-perfil" id="fotoPerfilNav">
                
                <div class="dropdown-notificacoes" id="dropdownNotif">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="../imagens_trilhas/sino-black.svg" alt="Notifica√ß√£o">
                            <span>Notifica√ß√µes</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-notif">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <div class="notificacao-vazia">Nenhuma notifica√ß√£o no momento</div>
                    </div>
                </div>

                <div class="dropdown-configuracoes" id="dropdownConfig">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="../imagens_trilhas/configuracao-black.svg" alt="Configura√ß√£o">
                            <span>Configura√ß√µes</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-config">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item" data-action="abrir-tema">Tema</button>
                        <button class="opcao-item" data-action="abrir-acessibilidade">Acessibilidade</button>
                        <button class="opcao-item" data-action="abrir-opcoes-avancadas">Op√ß√µes avan√ßadas</button>
                    </div>
                </div>

                <div class="dropdown-perfil" id="dropdownPerfil">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="../../imagens_trilhas/foto_de_perfil.png" alt="Perfil" class="perfil-mini" id="fotoPerfilMini">
                            <span id="nomeUsuarioPerfil">Ol√°, Usu√°rio</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-perfil">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item" data-action="abrir-seu-perfil">Seu perfil</button>
                        <button class="opcao-item" data-action="abrir-privacidade">Privacidade</button>
                        <button class="opcao-item" data-action="abrir-ajuda-recursos">Ajuda e Recursos</button>
                        <button class="opcao-item sair-conta" data-action="sair-da-conta">Sair da Conta</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="nome-da-guia">
        <ul>
            <li><a href="../../Rede/connect.html">Redes</a></li>
            <li><a href="../../Sala-de-Aula/sala.html">Sala de Aula</a></li>
            <li><a href="../../Trilhas/trilhas.html">Trilhas</a></li>
            <li><a href="../../Diario/diario.html">Di√°rio</a></li>
        </ul>
    </div>

    <main class="conteudo-principal"> 
        <div class="empresas">
            <div class="perfil-trilhas">
                <div class="box-perfil">
                   <img src="../imagens_trilhas/foto_de_perfil.png" alt="sua foto de perfil" class="img-perfil">
                    <div class="botoes-perfil">
                        <a href="../trilhas.html" class="btn-trilhas-perfil">Explorar <img src="../imagens_trilhas/home-icon-trilhas.svg" alt="Explorar"></a>    
                        <a href="" class="btn-trilhas-perfil">Portif√≥lio <img src="../imagens_trilhas/portifolio-perfil-trilhas.svg" alt="portifolio"></a>    
                        <a href="" class="btn-trilhas-perfil">Seus Projetos<img src="../imagens_trilhas/seus-projetos.svg" alt="seus projetos"></a>    
                        <a href="" class="btn-trilhas-perfil">Propostas<img src="../imagens_trilhas/projetos-aceitos-trilhas.svg" alt="projetos aceitos"></a>    
                    </div>
                </div>
            </div>
            <h3 class="h3-proposta">Sugest√µes de Propostas</h3>
            <div class="secao-propostas">
                <a href="/telas-trilhas/pendentes_trilhas.html" class="btn-proposta">
                    <div class="box-propostas-projeto">
                            <img src="../imagens_trilhas/google-pendente.svg" alt="Projeto Pendente Google" class="proposta">
                        <div class="content-desc-proposta-projeto">
                            <h4 class="desc-projeto">
                                oiii
                            </h4>
                        </div>
                    </div>
                </a>
                <a href="/telas-trilhas/pendentes_trilhas.html" class="btn-proposta">
                    <div class="box-propostas-projeto">
                            <img src="../imagens_trilhas/google-pendente.svg" alt="Projeto Pendente Google" class="proposta">
                        <div class="content-desc-proposta-projeto">
                            <h4 class="desc-projeto">
                                oiii
                            </h4>
                        </div>
                    </div>
                </a>
                <a href="./telas-trilhas/pendentes_trilhas.html" class="btn-proposta">
                    <div class="box-propostas-projeto">
                            <img src="../imagens_trilhas/google-pendente.svg" alt="Projeto Pendente Google" class="proposta">
                        <div class="content-desc-proposta-projeto">
                            <h4 class="desc-projeto">
                                Tabela Excel, contabilidade e gerenciamento
                            </h4>
                        </div>
                    </div>
                </a>

                <a href="" class="btn-trilhas-proposta">Filtrar Propostas</a> 
            </div>>
        </div>
        <div class="seu-perfil">
            <div class="container-seu-perfil">
                <div class="box-seu-perfil">
                    <div class="content-trilhas-perfil">
                        <div class="info-perfil-trilhas">
                            <div class="conteudo-perfil-trilhas">
                                <img src="../imagens_trilhas/foto_de_perfil.png" alt="" class="img-perfil-trilhas">
                                <div class="estrutura-perfil">
                                    <h4 class="nm-usuario">Rodrigo Santos</h4>
                                    <p class="especializacao-perfil">T√©cnico em Desenvolvimento de Sistemas</p>
                                </div>
                                <div class="botoes-perfil-trilhas">
                                    <a href="" class="btn-trilhas">Editar Perfil <img src="../imagens_trilhas/edit-icon-perfil.svg" alt="editar perfil"></a>
                                </div>
                            </div>
                            <div class="suas-formacoes-perfil">
                                <div class="content-formacoes">
                                    <h3 class="h3-suas-formacoes">Minhas forma√ß√µes</h3>
                                    <div class="suas-formacoes">
                                        <div class="secao-suas-formacoes">
                                            <div class="card-formacao">
                                                <div class="img-sua-formacao">
                                                    <img src="../imagens_trilhas/img-formacoes/USP.svg" alt="" class="img-formacao">
                                                </div>
                                                <div class="box-formacao">
                                                    <p class="nome-local-formacao">USP</p>
                                                    <div class="nm-data">
                                                        <p class="nome-especializacao">T√©cnico em Desenvolvimento de Sistemas</p>
                                                        
                                                        <p class="data-especializacao">2025</p>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="card-formacao">
                                                <div class="img-sua-formacao">
                                                    <img src="../imagens_trilhas/img-formacoes/Etec.svg" alt="" class="img-formacao">
                                                </div>
                                                <div class="box-formacao">
                                                    <p class="nome-local-formacao">Etec</p>
                                                    <div class="nm-data">
                                                        <p class="nome-especializacao">T√©cnico em Desenvolvimento de Sistemas</p>
                                                        
                                                        <p class="data-especializacao">2025</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="content-add-formacao">
                                            <a href="" class="btn-trilhas">Adicionar Forma√ß√µes <img src="../imagens_trilhas/icone-formacao.svg" alt="forma√ß√µes"></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="desc-perfil">
                                <h5 class="desc-seu-perfil">Sobre mim</h5>
                                <div>
                                    <p class="content-desc-seu-perfil">
                                        Lorem ipsum dolor sit amet consectetur adipisicing elit. Cumque, est reiciendis. Quisquam illum unde quae eveniet corrupti harum et eaque praesentium alias est, recusandae, sint at, asperiores impedit dolorum vitae.
                                        Ipsam quidem, repudiandae optio veritatis tenetur provident. Ipsum perferendis rerum vel magnam accusantium numquam ab, odit eligendi soluta dicta asperiores natus non fugiat corrupti accusamus nisi, maiores beatae optio! Voluptatum.
                                        Odio, sequi sed, aliquid est ipsa magni harum aut esse nemo obcaecati amet sint nobis minus omnis labore doloremque dicta quas possimus in molestiae enim! Debitis impedit iure inventore qui!
                                        Ut nulla voluptatum veniam reiciendis fugiat. Ipsam optio facere corrupti odio eaque laboriosam sint obcaecati! Animi, laboriosam omnis. Vitae numquam autem ullam. Molestiae numquam quo reiciendis asperiores ut voluptates ad!
                                    </p>
                                </div>
                            </div>
                            <div class="habilidades-perfil">
                                <div class=content-habilidades>
                                    <h3 class="h3-habilidades">Suas habilidades</h3>
                                    <div class="suas-habilidades">
                                        <div class="secao-suas-habilidades">
                                            <div class="card-habilidade" id="card-figma" data-projetos="45">
                                                <div class="img-sua-habilidade">
                                                    <img src="../imagens_trilhas/icone-habilidades-trilhas/FIGMA.svg" alt="" class="img-habilidade">
                                                </div>
                                                <div class="box-nm-nivel">
                                                    <div class="nome-nivel">
                                                        <div class="espaco-nome-habilidade">
                                                            <p class="nome-habilidade">Figma</p>
                                                        </div>
                                                        <p class="nivel-habilidade">N√≠vel: <span id="nivel-figma">1</span>/6</p>
                                                    </div>
                                                    <div class="linha-progresso-habilidade">
                                                        <div id="progresso-figma" class="progresso-linha-habilidade"></div>
                                                    </div>
                                                    <div class="xp-nivel">
                                                        <p class="xp-necessario texto-xp">XP: <span id="xp-faixa-figma">0</span>/600</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-habilidade" id="card-figma" data-projetos="45">
                                                <div class="img-sua-habilidade">
                                                    <img src="../imagens_trilhas/icone-habilidades-trilhas/FIGMA.svg" alt="" class="img-habilidade">
                                                </div>
                                                <div class="box-nm-nivel">
                                                    <div class="nome-nivel">
                                                        <div class="espaco-nome-habilidade">
                                                            <p class="nome-habilidade">Figma</p>
                                                        </div>
                                                        <p class="nivel-habilidade">N√≠vel: <span id="nivel-figma">1</span>/6</p>
                                                    </div>
                                                    <div class="linha-progresso-habilidade">
                                                        <div id="progresso-figma" class="progresso-linha-habilidade"></div>
                                                    </div>
                                                    <div class="xp-nivel">
                                                        <p class="xp-necessario texto-xp">XP: <span id="xp-faixa-figma">0</span>/600</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-habilidade" id="card-figma" data-projetos="45">
                                                <div class="img-sua-habilidade">
                                                    <img src="../imagens_trilhas/icone-habilidades-trilhas/FIGMA.svg" alt="" class="img-habilidade">
                                                </div>
                                                <div class="box-nm-nivel">
                                                    <div class="nome-nivel">
                                                        <div class="espaco-nome-habilidade">
                                                            <p class="nome-habilidade">Figma</p>
                                                        </div>
                                                        <p class="nivel-habilidade">N√≠vel: <span id="nivel-figma">1</span>/6</p>
                                                    </div>
                                                    <div class="linha-progresso-habilidade">
                                                        <div id="progresso-figma" class="progresso-linha-habilidade"></div>
                                                    </div>
                                                    <div class="xp-nivel">
                                                        <p class="xp-necessario texto-xp">XP: <span id="xp-faixa-figma">0</span>/600</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; text-align: center;">
                                                <button onclick="entregarProjeto('card-figma')" class="btn-trilhas" style="width:100%">
                                                    + Entregar Projeto
                                                </button>
                                            </div>
                                        </div>
                                        <div class="content-add-habilidade">
                                            <a href="" class="btn-trilhas">Adicionar Habilidades <img src="../imagens_trilhas/habilidades-trilhas.svg" alt="habilidades"></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:3000/api';
        const STORAGE_KEY = 'trilhasCommentsPost1';

        document.addEventListener('DOMContentLoaded', async function() {
            
            // ============================================
            // 1. VERIFICAR LOGIN E CARREGAR DADOS
            // ============================================
            const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
            
            if (!usuarioLogado || !usuarioLogado.id) {
                alert('Voc√™ precisa fazer login primeiro!');
                window.location.href = '/home.html';
                return;
            }

            const URL_PADRAO = './imagens_trilhas/foto_de_perfil.png';
            const fotoPerfilNav = document.getElementById('fotoPerfilNav');
            const fotoPerfilMini = document.getElementById('fotoPerfilMini');
            const fotoComentario = document.getElementById('fotoComentario');

            console.log('üë§ Usu√°rio logado:', usuarioLogado);

            // ============================================
            // 2. CARREGAR FOTO DE PERFIL DO BACKEND
            // ============================================
            async function carregarFotoPerfil() {
                try {
                    const response = await fetch(`${API_URL}/users/${usuarioLogado.id}`);
                    const data = await response.json();
                    
                    if (data.success && data.user) {
                        const fotoUrl = data.user.perfilUrl 
                            ? `http://localhost:3000${data.user.perfilUrl}` 
                            : URL_PADRAO;
                        
                        fotoPerfilNav.src = fotoUrl;
                        fotoPerfilMini.src = fotoUrl;
                        fotoComentario.src = fotoUrl;
                        
                        // Atualizar nome do usu√°rio
                        document.getElementById('nomeUsuarioPerfil').textContent = `Ol√°, ${data.user.name || 'Usu√°rio'}`;
                        
                        console.log('‚úÖ Foto de perfil carregada:', fotoUrl);
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar foto de perfil:', error);
                    // Usar foto padr√£o em caso de erro
                    fotoPerfilNav.src = URL_PADRAO;
                    fotoPerfilMini.src = URL_PADRAO;
                }
            }

            await carregarFotoPerfil();

            // ============================================
            // 3. N√çVEIS DE HABILIDADE
            // ============================================
            
            const XpPorProjeto = 20;
            const MetaNivel = 600;
            const NivelMax = 6;

            // ============================================
            // 3.1 CALCULAR SUE NIVEL ATUAL 
            // ============================================

            function calcularNivel(totalProjetos){
                const xpTotal = totalProjetos * XpPorProjeto;

                let nivelAtual = Math.floor(xpTotal/MetaNivel) +1;

                let xpNaFaixa = xpTotal % MetaNivel;

                if(nivelAtual >= NivelMax){
                    nivelAtual = NivelMax;
                    xpNaFaixa = MetaNivel;
                }

                return {
                    nivel: nivelAtual,
                    xp: xpNaFaixa,
                };
            }

            // ============================================
            // 3.2 ATUALIZAR O CODIGO
            // ============================================

            function atualizarCardsDeHabilidade() {
            const cards = document.querySelectorAll('.card-habilidade');

            cards.forEach(card => {
                const projetos = parseInt(card.getAttribute('data-projetos')) || 0;

                const resultado = calcularNivel(projetos);

                const txtNivel = card.querySelector('.texto-nivel');
                const txtXP = card.querySelector('.texto-xp');

                if (txtNivel) {
                    txtNivel.innerText = `N√≠vel: ${resultado.nivel}/${NivelMax}`;
                }
                
                if (txtXP) {
                    txtXP.innerText = `XP: ${resultado.xp} / ${MetaNivel}`;
                }
                });
            }

            
            // 3.3 ANIMA√á√ÉO BARRA DE PROGRESSO
            

            
            // Executa a fun√ß√£o de atualiza√ß√£o imediatamente
            atualizarCardsDeHabilidade();

            // ============================================
            // 4. DROPDOWNS
            // ============================================
            const dropdownNotif = document.getElementById('dropdownNotif');
            const dropdownConfig = document.getElementById('dropdownConfig');
            const dropdownPerfil = document.getElementById('dropdownPerfil');
            const btnNotif = document.querySelector('.btn-notificao-nav');
            const btnConfig = document.querySelector('.btn-config');
            
            function fecharDropdownNotif() { dropdownNotif.classList.remove('ativo'); }
            function fecharDropdownConfig() { dropdownConfig.classList.remove('ativo'); }
            function fecharDropdownPerfil() { dropdownPerfil.classList.remove('ativo'); }
            
            btnNotif.addEventListener('click', function() {
                fecharDropdownConfig();
                fecharDropdownPerfil();
                dropdownNotif.classList.toggle('ativo');
            });
            
            btnConfig.addEventListener('click', function() {
                fecharDropdownNotif();
                fecharDropdownPerfil();
                dropdownConfig.classList.toggle('ativo');
            });
            
            fotoPerfilNav.addEventListener('click', function() {
                fecharDropdownNotif();
                fecharDropdownConfig();
                dropdownPerfil.classList.toggle('ativo');
            });

            document.querySelectorAll('[data-action]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const action = this.getAttribute('data-action');
                    switch(action) {
                        case 'fechar-notif': fecharDropdownNotif(); break;
                        case 'fechar-config': fecharDropdownConfig(); break;
                        case 'fechar-perfil': fecharDropdownPerfil(); break;
                        case 'sair-da-conta':
                            if (confirm('Tem certeza que deseja sair da conta?')) {
                                localStorage.removeItem('usuarioLogado');
                                window.location.href = '/home.html';
                            }
                            fecharDropdownPerfil();
                            break;
                        default:
                            alert(`Funcionalidade '${action.replace('abrir-', '')}' ser√° implementada`);
                            fecharDropdownConfig(); 
                            fecharDropdownPerfil();
                            break;
                    }
                });
            });
            
            document.addEventListener('click', function(event) {
                const isClickOutside = !dropdownNotif.contains(event.target) && event.target !== btnNotif &&
                                       !dropdownConfig.contains(event.target) && event.target !== btnConfig &&
                                       !dropdownPerfil.contains(event.target) && event.target !== fotoPerfilNav;
                
                if (isClickOutside) {
                    fecharDropdownNotif();
                    fecharDropdownConfig();
                    fecharDropdownPerfil();
                }
            });
        });
    </script>
</body>
</html>