<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propostas Trilhas</title>
    <link rel="stylesheet" href="../estilos_trilhas/estilo_propostas_trilhas.css">
</head>
<body>

    <nav class="navegacao">
        <div class="menu">
            <div class="menu-1">
                <img src="../imagens_trilhas/lotus.svg" alt="Logo da institui√ß√£o" class="projeto" width="30px" height="30px">
            </div>
            <div class="menu-2">
                <input type="text" placeholder="Pesquise aqui...">
            </div> 
            <div class="menu-3">
                <img src="../imagens_trilhas/sininho.svg" alt="notifica√ß√£o" class="btn-notificao-nav">
                <img src="../imagens_trilhas/configuracao.svg" alt="bot√£o de configura√ß√£o" class="btn-config">
                <img src="../imagens_trilhas/foto_de_perfil.png" alt="imagem de perfil" class="foto-de-perfil" id="fotoPerfilNav">
                
                <div class="dropdown-notificacoes" id="dropdownNotif">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="../imagens_trilhas/sino-black.svg" alt="Notifica√ß√£o">
                            <span>Notifica√ß√µes</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-notif">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <div class="notificacao-vazia">Nenhuma notifica√ß√£o no momento</div>
                    </div>
                </div>

                <div class="dropdown-configuracoes" id="dropdownConfig">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="../imagens_trilhas/configuracao-black.svg" alt="Configura√ß√£o">
                            <span>Configura√ß√µes</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-config">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item" data-action="abrir-tema">Tema</button>
                        <button class="opcao-item" data-action="abrir-acessibilidade">Acessibilidade</button>
                        <button class="opcao-item" data-action="abrir-opcoes-avancadas">Op√ß√µes avan√ßadas</button>
                    </div>
                </div>

                <div class="dropdown-perfil" id="dropdownPerfil">
                    <div class="dropdown-header">
                        <div class="dropdown-titulo">
                            <img src="../../imagens_trilhas/foto_de_perfil.png" alt="Perfil" class="perfil-mini" id="fotoPerfilMini">
                            <span id="nomeUsuarioPerfil">Ol√°, Usu√°rio</span>
                        </div>
                        <button class="btn-fechar" data-action="fechar-perfil">&times;</button>
                    </div>
                    <div class="dropdown-opcoes">
                        <button class="opcao-item" data-action="abrir-seu-perfil">Seu perfil</button>
                        <button class="opcao-item" data-action="abrir-privacidade">Privacidade</button>
                        <button class="opcao-item" data-action="abrir-ajuda-recursos">Ajuda e Recursos</button>
                        <button class="opcao-item sair-conta" data-action="sair-da-conta">Sair da Conta</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="nome-da-guia">
        <ul>
            <li><a href="../../Rede/connect.html">Redes</a></li>
            <li><a href="../../Sala-de-Aula/sala.html">Sala de Aula</a></li>
            <li><a href="../../Trilhas/trilhas.html">Trilhas</a></li>
            <li><a href="../../Diario/diario.html">Di√°rio</a></li>
        </ul>
    </div>

    <main class="conteudo-principal"> 
        <div class="empresas">
            <div class="perfil-trilhas">
                <div class="box-perfil">
                   <img src="../imagens_trilhas/foto_de_perfil.png" alt="sua foto de perfil" class="img-perfil">
                    <div class="botoes-perfil">
                        <a href="../trilhas.html" class="btn-trilhas-perfil">Explorar <img src="../imagens_trilhas/home-icon-trilhas.svg" alt="Explorar"></a>    
                        <a href="./perfil_trilhas.html" class="btn-trilhas-perfil">Seu perfil<img src="../imagens_trilhas/seu-perfil-trilhas.svg" alt="projetos aceitos"></a>    
                        <a href="./portifolio_trilhas.html" class="btn-trilhas-perfil">Portif√≥lio <img src="../imagens_trilhas/portifolio-perfil-trilhas.svg" alt="portifolio"></a>    
                        <a href="./seus_projetos_trilhas.html" class="btn-trilhas-perfil">Meus Projetos<img src="../imagens_trilhas/seus-projetos.svg" alt="seus projetos"></a>    
                    </div>
                </div>
            </div>
            <h3 class="h3-proposta">Sugest√µes de Propostas</h3>
            <div class="secao-propostas">
                <a href="#" class="btn-proposta">
                    <div class="box-propostas-projeto">
                            <img src="../imagens_trilhas/img-empresas/meta.svg" alt="Projeto Pendente Google" class="proposta">
                        <div class="content-desc-proposta-projeto">
                            <h4 class="desc-projeto">
                                Nova identidade visual.
                            </h4>
                        </div>
                    </div>
                </a>
                <a href="#" class="btn-proposta">
                    <div class="box-propostas-projeto">
                            <img src="../imagens_trilhas/img-empresas/amazon.svg" alt="Projeto Pendente Google" class="proposta">
                        <div class="content-desc-proposta-projeto">
                            <h4 class="desc-projeto">
                                Sistema autonomo de IA.
                            </h4>
                        </div>
                    </div>
                </a>
                <a href="#" class="btn-proposta">
                    <div class="box-propostas-projeto">
                            <img src="../imagens_trilhas/img-empresas/google.svg" alt="Projeto Pendente Google" class="proposta">
                        <div class="content-desc-proposta-projeto">
                            <h4 class="desc-projeto">
                                Tabela Excel, contabilidade e gerenciamento de informa√ß√µes
                            </h4>
                        </div>
                    </div>
                </a>

                <a href="" class="btn-trilhas-proposta">Filtrar Propostas</a> 
            </div>
        </div>
        <div class="seu-perfil">
            <div class="container-seu-perfil">
                <div class="box-seu-perfil">
                    <div class="content-trilhas-perfil">
                        <div class="info-perfil-trilhas">
                            <div class="card-projeto">
                                <div class="card-header">
                                    <div class="empresa-info">
                                        <div class="empresa-avatar">N</div> 
                                        <div class="empresa-nome">Nubank</div>
                                    </div>
                                    <span class="projeto-prioridade prioridade-Alta">Alta</span>
                                </div>
                                
                                <div class="card-body">
                                    <h3>Redesign App Banc√°rio</h3>
                                    <p class="card-descricao">
                                        Precisamos reformular a experi√™ncia de usu√°rio na tela de investimentos do nosso aplicativo. O foco √© clareza e acessibilidade.
                                    </p>
                                    <div class="card-tags">
                                        <span class="tag-skill tag-categoria">UI/UX Design</span>
                                        <span class="tag-skill">Figma</span>
                                        <span class="tag-skill">Prototipagem</span>
                                    </div>
                                </div>
                            
                                <div class="card-footer">
                                    <div class="info-vagas">
                                        <span>üë• 2 vagas restantes</span>
                                    </div>
                                    <a href="#" class="btn-ver-detalhes">Ver Detalhes</a>
                                </div>
                            </div>
                            
                            <div class="card-projeto">
                                <div class="card-header">
                                    <div class="empresa-info">
                                        <div class="empresa-avatar">M</div> 
                                        <div class="empresa-nome">Mercado Livre</div>
                                    </div>
                                    <span class="projeto-prioridade prioridade-Media">M√©dia</span>
                                </div>
                                
                                <div class="card-body">
                                    <h3>API de Pagamentos PIX</h3>
                                    <p class="card-descricao">
                                        Desenvolvimento de microsservi√ßos para processamento de pagamentos via PIX utilizando Node.js e arquitetura serverless.
                                    </p>
                                    <div class="card-tags">
                                        <span class="tag-skill tag-categoria">Backend Dev</span>
                                        <span class="tag-skill">Node.js</span>
                                        <span class="tag-skill">SQL</span>
                                    </div>
                                </div>
                            
                                <div class="card-footer">
                                    <div class="info-vagas">
                                        <span>üë• 3 vagas restantes</span>
                                    </div>
                                    <a href="#" class="btn-ver-detalhes">Ver Detalhes</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    


<script>
const API_URL = 'http://localhost:3000/api';

document.addEventListener('DOMContentLoaded', async function() {
    
    const usuarioLogado = JSON.parse(localStorage.getItem('usuarioLogado'));
    
    if (!usuarioLogado || !usuarioLogado.id) {
    showNotification('error', 'Acesso Negado', 'Voc√™ precisa fazer login primeiro.');
    setTimeout(() => {
        window.location.href = '/home.html';
    }, 2000);
    return;
}

    console.log('üë§ Usu√°rio logado:', usuarioLogado);

    // ============================================
    // FUN√á√ïES GERAIS E CARREGAMENTO
    // ============================================
    function atualizarTodasFotosPerfil(fotoUrl) {
        const URL_PADRAO = '../imagens_trilhas/foto_de_perfil.png';
        
        // Se n√£o tem foto, usa a padr√£o local
        if (!fotoUrl) {
            const elementos = [
                document.getElementById('fotoPerfilNav'),
                document.getElementById('fotoPerfilMini'),
                document.querySelector('.img-perfil'),
                document.querySelector('.img-perfil-trilhas')
            ];
            elementos.forEach(el => {
                if (el) el.src = URL_PADRAO;
            });
            return;
        }
        
        // Se tem foto, monta URL completa
        const urlCompleta = fotoUrl.startsWith('http') ? fotoUrl : `http://localhost:3000${fotoUrl}`;
        
        const elementos = [
            document.getElementById('fotoPerfilNav'),
            document.getElementById('fotoPerfilMini'),
            document.querySelector('.img-perfil'),
            document.querySelector('.img-perfil-trilhas')
        ];
        
        elementos.forEach(el => {
            if (el) {
                el.src = urlCompleta;
                el.onerror = () => el.src = URL_PADRAO;
            }
        });
    }

    // Atualiza√ß√£o imediata do localStorage
    if (usuarioLogado.perfilUrl) {
        atualizarTodasFotosPerfil(usuarioLogado.perfilUrl);
    }

    async function carregarDadosUsuario() {
        try {
            const response = await fetch(`${API_URL}/trilhas/perfil/${usuarioLogado.id}`);

            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }

            const data = await response.json();
            console.log('üì¶ Dados completos do usu√°rio:', data);

            if (data.success && data.user) {
                console.log('üìù Sobre mim recebido:', data.user.sobreMim);

                const usuarioAtualizado = {
                    ...usuarioLogado,
                    name: data.user.name,
                    perfilUrl: data.user.perfilUrl,
                    sobreMim: data.user.sobreMim
                };
                localStorage.setItem('usuarioLogado', JSON.stringify(usuarioAtualizado));

                document.getElementById('nomeUsuarioPerfil').textContent = `Ol√°, ${data.user.name || 'Usu√°rio'}`;
                const nmUsuario = document.querySelector('.nm-usuario');
                if (nmUsuario) nmUsuario.textContent = data.user.name || 'Usu√°rio';

                const sobreMimElement = document.querySelector('.content-desc-seu-perfil');
                if (sobreMimElement) {
                    const textoSobreMim = data.user.sobreMim || "Ol√°! Escreva um pouco sobre voc√™...";
                    sobreMimElement.textContent = textoSobreMim;
                    console.log('‚úèÔ∏è Texto exibido na tela:', textoSobreMim);
                }

                if (data.user.perfilUrl) {
                    atualizarTodasFotosPerfil(data.user.perfilUrl);
                }

                console.log('‚úÖ Dados do usu√°rio carregados');
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar dados do usu√°rio:', error);
            alert('Erro ao carregar dados do perfil. Verifique sua conex√£o.');
        }
    }

    await carregarDadosUsuario();

    // ============================================
    // HABILIDADES
    // ============================================
    async function carregarHabilidades() {
        try {
            console.log('üîÑ Carregando habilidades...');
            const response = await fetch(`${API_URL}/trilhas/habilidades/${usuarioLogado.id}`);
            
            if (!response.ok) {
                console.error('Erro na resposta:', response.status);
                return;
            }
            
            const data = await response.json();
            console.log('üì¶ Dados recebidos:', data);
            
            if (data.success && data.habilidades) {
                renderizarHabilidades(data.habilidades);
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar habilidades:', error);
        }
    }

    function renderizarHabilidades(habilidades) {
    const container = document.querySelector('.secao-suas-habilidades');
    if (!container) return;

    container.innerHTML = '';

    if (habilidades.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999;">Nenhuma habilidade adicionada ainda</p>';
        return;
    }

    habilidades.forEach(hab => {
        const nivel = calcularNivel(hab.xp);
        const cardHTML = `
            <div class="card-habilidade" data-habilidade-id="${hab.id}">
                <button class="btn-excluir-habilidade" data-id-usuario-habilidade="${hab.id}">&times;</button>
                <div class="img-sua-habilidade">
                    <img src="../imagens_trilhas/icone-habilidades-trilhas/${hab.habilidade.icone || 'default.svg'}" 
                         alt="${hab.habilidade.nome}" 
                         class="img-habilidade">
                </div>
                <div class="box-nm-nivel">
                    <div class="nome-nivel">
                        <div class="espaco-nome-habilidade">
                            <p class="nome-habilidade">${hab.habilidade.nome}</p>
                        </div>
                        <p class="nivel-habilidade">N√≠vel: <span>${nivel.nivel}</span>/6</p>
                    </div>
                    <div class="linha-progresso-habilidade">
                        <div class="progresso-linha-habilidade" style="width: ${nivel.progresso}%"></div>
                    </div>
                    <div class="xp-nivel">
                        <p class="xp-necessario texto-xp">XP: <span>${nivel.xp}</span>/600</p>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', cardHTML);
    });
    }

    const META_NIVEL = 600;
    const NIVEL_MAX = 6;

    function calcularNivel(xpTotal) {
        let nivelBase = Math.floor(xpTotal / META_NIVEL);
        let nivelAtual = nivelBase + 1;
        let xpNaFaixa = xpTotal % META_NIVEL;
        let progressoPercentual = (xpNaFaixa / META_NIVEL) * 100;

        if (nivelAtual > NIVEL_MAX) {
            nivelAtual = NIVEL_MAX;
            xpNaFaixa = META_NIVEL;
            progressoPercentual = 100;
        }

        return { nivel: nivelAtual, xp: xpNaFaixa, progresso: progressoPercentual.toFixed(2) };
        }

        await carregarHabilidades();

    // ============================================
    // EDI√á√ÉO/EXCLUS√ÉO DE HABILIDADES
    // ============================================

    const btnEditarHabilidades = document.getElementById('btnEditarHabilidades');
    const btnCancelarEdicao = document.getElementById('btnCancelarEdicao');
    const secaoHabilidades = document.querySelector('.secao-suas-habilidades');
    const btnAdicionarHabilidades = document.getElementById('btnAbrirPopup'); 

    let modoEdicaoAtivo = false;

    function toggleEditMode(ativo) {
        modoEdicaoAtivo = ativo;

        if (modoEdicaoAtivo) {
            // Entra no Modo de Edi√ß√£o
            secaoHabilidades.classList.add('modo-edicao-ativo');
            btnEditarHabilidades.style.display = 'none';
            btnCancelarEdicao.style.display = 'block';
            btnAdicionarHabilidades.style.display = 'none'; 
            console.log('Modo de Edi√ß√£o de Habilidades ATIVADO');
        } else {
            // Sai do Modo de Edi√ß√£o
            secaoHabilidades.classList.remove('modo-edicao-ativo');
            btnEditarHabilidades.style.display = 'block';
            btnCancelarEdicao.style.display = 'none';
            btnAdicionarHabilidades.style.display = 'block'; 
            console.log('Modo de Edi√ß√£o de Habilidades DESATIVADO');
        }
    }

    async function excluirHabilidade(usuarioHabilidadeId) {
        if (!confirm('Tem certeza que deseja excluir esta habilidade do seu perfil?')) {
            return;
        }

        try {
            const response = await fetch(`${API_URL}/trilhas/habilidades/${usuarioHabilidadeId}`, {
                method: 'DELETE',
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
            }

            alert('‚úÖ Habilidade exclu√≠da com sucesso!');
            await carregarHabilidades(); 
        } catch (error) {
            console.error('‚ùå Erro ao excluir habilidade:', error);
            alert('‚ùå Falha ao excluir a habilidade: ' + error.message);
        }
    }


    if (btnEditarHabilidades) {
        btnEditarHabilidades.addEventListener('click', (e) => {
            e.preventDefault();
            toggleEditMode(true);
        });
    }

    if (btnCancelarEdicao) {
        btnCancelarEdicao.addEventListener('click', (e) => {
            e.preventDefault();
            toggleEditMode(false);
        });
    }

    if (secaoHabilidades) {
        secaoHabilidades.addEventListener('click', (e) => {
            const btnExcluir = e.target.closest('.btn-excluir-habilidade');

            if (btnExcluir && modoEdicaoAtivo) {
                const idParaDeletar = btnExcluir.dataset.idUsuarioHabilidade;
                if (idParaDeletar) {
                    excluirHabilidade(idParaDeletar);
                }
            }
        });
    }



    // ============================================
    // FORMA√á√ïES
    // ============================================
    async function carregarFormacoes() {
        try {
            console.log('üîÑ Carregando forma√ß√µes...');
            const response = await fetch(`${API_URL}/trilhas/formacoes/${usuarioLogado.id}`);
            
            if (!response.ok) {
                console.error('Erro na resposta:', response.status);
                return;
            }
            
            const data = await response.json();
            console.log('üì¶ Forma√ß√µes recebidas:', data);
            
            if (data.success && data.formacoes) {
                renderizarFormacoes(data.formacoes);
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar forma√ß√µes:', error);
        }
    }

    function renderizarFormacoes(formacoes) {
        const container = document.querySelector('.secao-suas-formacoes');
        if (!container) return;
        container.innerHTML = '';

        if (formacoes.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #999;">Nenhuma forma√ß√£o adicionada ainda</p>';
            return;
        }

        formacoes.forEach(form => {
            const dataInicio = form.dataInicio ? new Date(form.dataInicio).getFullYear() : '-';
            const dataFim = form.dataFim ? new Date(form.dataFim).getFullYear() : (form.emAndamento ? 'Cursando' : '-');
            
            const cardHTML = `
                <div class="card-formacao" data-formacao-id="${form.id}">
                    <div class="img-sua-formacao">
                        <img src="../imagens_trilhas/icone-formacao.svg" alt="Forma√ß√£o" class="img-formacao">
                    </div>
                    <div class="box-formacao">
                        <p class="nome-local-formacao">${form.instituicao}</p>
                        <div class="nm-data">
                            <p class="nome-especializacao">${form.titulo}</p>
                            <p class="data-especializacao">${dataInicio} - ${dataFim}</p>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', cardHTML);
        });
    }

    await carregarFormacoes();


    function renderizarFormacoes(formacoes) {

    const container = document.getElementById('secaoSuasFormacoes'); 
    if (!container) return;
    container.innerHTML = '';

    if (formacoes.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #999;">Nenhuma forma√ß√£o adicionada ainda</p>';
        return;
    }

    formacoes.forEach(form => {
        const dataInicio = form.dataInicio ? new Date(form.dataInicio).getFullYear() : '-';
        const dataFim = form.dataFim ? new Date(form.dataFim).getFullYear() : (form.emAndamento ? 'Cursando' : '-');
        
        const cardHTML = `
            <div class="card-formacao" data-formacao-id="${form.id}">
                <button class="btn-excluir-formacao" data-id-formacao="${form.id}">&times;</button>
                <div class="img-sua-formacao">
                    <img src="../imagens_trilhas/icone-formacao.svg" alt="Forma√ß√£o" class="img-formacao">
                </div>
                <div class="box-formacao">
                    <p class="nome-local-formacao">${form.instituicao}</p>
                    <div class="nm-data">
                        <p class="nome-especializacao">${form.titulo}</p>
                        <p class="data-especializacao">${dataInicio} - ${dataFim}</p>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', cardHTML);
    });
    
    if (modoEdicaoFormacaoAtivo) {
        container.classList.add('modo-edicao-ativo');
    } else {
        container.classList.remove('modo-edicao-ativo');
    }
}

    // ============================================
    // EDI√á√ÉO/EXCLUS√ÉO DE FORMA√á√ïES
    // ============================================

    const btnEditarFormacoes = document.getElementById('btnEditarFormacoes');
    const btnCancelarEdicaoFormacao = document.getElementById('btnCancelarEdicaoFormacao');
    const secaoFormacoes = document.getElementById('secaoSuasFormacoes');
    const btnAdicionarFormacao = document.getElementById('btnAbrirFormacao');

    let modoEdicaoFormacaoAtivo = false;

    function toggleEditModeFormacao(ativo) {
        modoEdicaoFormacaoAtivo = ativo;

        if (modoEdicaoFormacaoAtivo) {
            // Entra no Modo de Edi√ß√£o
            secaoFormacoes.classList.add('modo-edicao-ativo');
            btnEditarFormacoes.style.display = 'none';
            btnCancelarEdicaoFormacao.style.display = 'block';
            btnAdicionarFormacao.style.display = 'none';
            console.log('Modo de Edi√ß√£o de Forma√ß√µes ATIVADO');
        } else {
            // Sai do Modo de Edi√ß√£o
            secaoFormacoes.classList.remove('modo-edicao-ativo');
            btnEditarFormacoes.style.display = 'block';
            btnCancelarEdicaoFormacao.style.display = 'none';
            btnAdicionarFormacao.style.display = 'block';
            console.log('Modo de Edi√ß√£o de Forma√ß√µes DESATIVADO');
        }
    }

    async function excluirFormacao(formacaoId) {
        if (!confirm('Tem certeza que deseja excluir esta forma√ß√£o do seu perfil?')) {
            return;
        }

        try {
            const response = await fetch(`${API_URL}/trilhas/formacoes/${formacaoId}`, {
                method: 'DELETE',
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Erro HTTP: ${response.status}`);
            }

            alert('‚úÖ Forma√ß√£o exclu√≠da com sucesso!');
            await carregarFormacoes(); // Recarrega a lista
        } catch (error) {
            console.error('‚ùå Erro ao excluir forma√ß√£o:', error);
            alert('‚ùå Falha ao excluir a forma√ß√£o: ' + error.message);
        }
    }


    // 1. Evento para ATIVAR o modo de exclus√£o
    if (btnEditarFormacoes) {
        btnEditarFormacoes.addEventListener('click', (e) => {
            e.preventDefault();
            toggleEditModeFormacao(true);
        });
    }

    // 2. Evento para DESATIVAR o modo de exclus√£o
    if (btnCancelarEdicaoFormacao) {
        btnCancelarEdicaoFormacao.addEventListener('click', (e) => {
            e.preventDefault();
            toggleEditModeFormacao(false);
        });
    }

    // 3. Delega√ß√£o de evento para EXCLUIR ao clicar no 'X'
    if (secaoFormacoes) {
        secaoFormacoes.addEventListener('click', (e) => {
            // Usa closest para encontrar o bot√£o de exclus√£o
            const btnExcluir = e.target.closest('.btn-excluir-formacao');

            if (btnExcluir && modoEdicaoFormacaoAtivo) {
                e.stopPropagation(); // Evita cliques indesejados no card
                const idParaDeletar = btnExcluir.dataset.idFormacao;
                if (idParaDeletar) {
                    excluirFormacao(idParaDeletar);
                }
            }
        });
    }

    // ============================================
    // POPUP HABILIDADE
    // ============================================
    const popupHabilidade = document.getElementById('popupHabilidade');
    const btnAbrirPopup = document.getElementById('btnAbrirPopup');
    const btnFecharPopup = document.getElementById('btnFecharPopup');
    const btnCancelarPopup = document.getElementById('btnCancelarPopup');
    const btnSalvarHabilidade = document.getElementById('btnSalvarHabilidade');

    async function carregarCatalogoHabilidades() {
        try {
            console.log('üîÑ Carregando cat√°logo...');
            const response = await fetch(`${API_URL}/trilhas/habilidades-catalogo`);
            
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('üì¶ Cat√°logo recebido:', data);
            
            if (data.success && data.habilidades) {
                renderizarCatalogo(data.habilidades);
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar cat√°logo:', error);
            alert('Erro ao carregar cat√°logo de habilidades. Verifique sua conex√£o.');
        }
    }

    function renderizarCatalogo(habilidades) {
        const grid = document.querySelector('.grid-habilidades');
        if (!grid) return;
        grid.innerHTML = '';

        habilidades.forEach(hab => {
            const cardHTML = `
                <div class="card-habilidade card-selecionavel" data-habilidade-id="${hab.id}">
                    <img src="../imagens_trilhas/icone-habilidades-trilhas/${hab.icone || 'default.svg'}" 
                         alt="${hab.nome}" 
                         class="img-habilidade">
                    <div class="box-habilidade">
                        <p class="nm-habilidade">${hab.nome}</p>
                        <div class="nivel-habilidade">
                            <div class="barra-habilidade">
                                <div class="progress" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            grid.insertAdjacentHTML('beforeend', cardHTML);
        });
    }

    document.addEventListener('click', function(e) {
        const card = e.target.closest('.card-selecionavel');
        if (card) {
            document.querySelectorAll('.card-selecionavel').forEach(c => c.classList.remove('selecionada'));
            card.classList.add('selecionada');
        }
    });

    if (btnAbrirPopup) {
        btnAbrirPopup.addEventListener('click', async (e) => {
            e.preventDefault();
            await carregarCatalogoHabilidades();
            popupHabilidade.classList.add('ativo');
        });
    }

    function fecharPopupHabilidadeFunc() {
        popupHabilidade.classList.remove('ativo');
    }

    if (btnFecharPopup) btnFecharPopup.addEventListener('click', fecharPopupHabilidadeFunc);
    if (btnCancelarPopup) btnCancelarPopup.addEventListener('click', fecharPopupHabilidadeFunc);

    if (btnSalvarHabilidade) {
        btnSalvarHabilidade.addEventListener('click', async (e) => {
            e.preventDefault();
            const selecionado = document.querySelector('.card-selecionavel.selecionada');
            
            if (!selecionado) {
                alert('‚ö†Ô∏è Selecione uma habilidade primeiro!');
                return;
            }

            const habilidadeId = selecionado.dataset.habilidadeId;
            
            console.log('üì§ Enviando dados:', {
                usuarioId: usuarioLogado.id,
                habilidadeId: parseInt(habilidadeId),
                nivel: 1
            });
            
            try {
                const response = await fetch(`${API_URL}/trilhas/habilidades`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usuarioId: parseInt(usuarioLogado.id),
                        habilidadeId: parseInt(habilidadeId),
                        nivel: 1
                    })
                });
                
                console.log('üì• Status resposta:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erro do servidor:', errorText);
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Resposta:', data);
                
                if (data.success) {
                    alert('‚úÖ Habilidade adicionada com sucesso!');
                    fecharPopupHabilidadeFunc();
                    await carregarHabilidades();
                } else {
                    alert('‚ùå Erro: ' + (data.message || 'Falha ao adicionar'));
                }
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                alert('‚ùå Erro de conex√£o. Verifique se o servidor est√° rodando na porta 3000.');
            }
        });
    }

    // ============================================
    // POPUP SOBRE MIM
    // ============================================
    const popupSobre = document.getElementById('popupSobreMim');
    const btnAbrirSobre = document.getElementById('btnAbrirSobreMim');
    const btnFecharSobre = document.getElementById('btnFecharSobreMim');
    const btnCancelarSobre = document.getElementById('btnCancelarSobreMim');
    const formSobre = document.getElementById('formSobreMim');
    const txtAreaSobre = document.getElementById('txtSobreMim');
    const textoPerfilAtual = document.querySelector('.content-desc-seu-perfil');
    const contador = document.getElementById('contadorAtual');

    if (btnAbrirSobre) {
        btnAbrirSobre.addEventListener('click', (e) => {
            e.preventDefault();
            const textoAtual = textoPerfilAtual.innerText.trim();
            const textoParaEditar = (textoAtual === "Carregando..." || textoAtual === "Ol√°! Escreva um pouco sobre voc√™...") ? "" : textoAtual;
            txtAreaSobre.value = textoParaEditar;
            contador.innerText = txtAreaSobre.value.length;
            popupSobre.classList.add('ativo');
        });
    }

    function fecharPopupSobre() {
        popupSobre.classList.remove('ativo');
    }

    if (btnFecharSobre) btnFecharSobre.addEventListener('click', fecharPopupSobre);
    if (btnCancelarSobre) btnCancelarSobre.addEventListener('click', fecharPopupSobre);

    if (txtAreaSobre) {
        txtAreaSobre.addEventListener('input', function() {
            contador.innerText = this.value.length;
        });
    }

    // ============================================
    // POPUP SOBRE MIM - FINALIZANDO A CHAMADA
    // ============================================



    if (formSobre) {
        formSobre.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Desabilitar o bot√£o para evitar envio duplicado
            const btnSalvar = formSobre.querySelector('.btn-salvar');
            if (btnSalvar) btnSalvar.disabled = true;

            const novoTexto = txtAreaSobre.value.trim();
            const usuarioId = usuarioLogado.id; 

            if (!novoTexto) {
                alert('O campo "Sobre Mim" n√£o pode estar vazio.');
                if (btnSalvar) btnSalvar.disabled = false;
                return;
            }

            console.log(`üì§ Tentando atualizar Sobre Mim para o usu√°rio ${usuarioId} com o texto:`, novoTexto);

            try {
                const url = `${API_URL}/trilhas/perfil/${usuarioId}/sobre-mim`;

                const response = await fetch(url, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        sobreMim: novoTexto 
                    })
                });
                // ---------------------------------------------

                const data = await response.json();
                console.log('üì• Resposta do servidor:', data);

                if (response.ok) {
                    alert('‚úÖ Campo "Sobre Mim" atualizado com sucesso!');
                    const sobreMimElement = document.querySelector('.content-desc-seu-perfil');
                    if (sobreMimElement) {
                        sobreMimElement.textContent = novoTexto;
                    }

                    await carregarDadosUsuario(); 

                    fecharPopupSobre();

                } else {
                    const mensagemErro = data.message || `Erro ao salvar. Status: ${response.status}`;
                    alert(`‚ùå Falha ao salvar: ${mensagemErro}`);
                }

            } catch (error) {
                console.error('‚ùå Erro de conex√£o ao salvar Sobre Mim:', error);
                alert('‚ùå Erro de conex√£o com o servidor. Verifique se o Backend est√° rodando.');
            } finally {
                // Reabilitar o bot√£o
                if (btnSalvar) btnSalvar.disabled = false;
            }
        });
    }

    // ============================================
    // POPUP FORMA√á√ÉO
    // ============================================
    const popupFormacao = document.getElementById('popupFormacao');
    const btnAbrirFormacao = document.getElementById('btnAbrirFormacao');
    const btnFecharFormacao = document.getElementById('btnFecharPopupFormacao');
    const btnCancelarFormacao = document.getElementById('btnCancelarFormacao');
    const formAdicionarFormacao = document.getElementById('form-adicionar-formacao');

    if (btnAbrirFormacao) {
        btnAbrirFormacao.addEventListener('click', (e) => {
            e.preventDefault();
            popupFormacao.classList.add('ativo');
        });
    }

    function fecharPopupFormacao() {
        popupFormacao.classList.remove('ativo');
        setTimeout(() => {
            if (formAdicionarFormacao) formAdicionarFormacao.reset();
        }, 300);
    }

    if (btnFecharFormacao) btnFecharFormacao.addEventListener('click', fecharPopupFormacao);
    if (btnCancelarFormacao) btnCancelarFormacao.addEventListener('click', fecharPopupFormacao);

    if (formAdicionarFormacao) {
        formAdicionarFormacao.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const instituicao = document.getElementById('nomeInstituicao').value.trim();
            const curso = document.getElementById('nomeCurso').value.trim();
            const anoInicio = document.getElementById('anoInicio').value;
            const anoFim = document.getElementById('anoFim').value;

            if (!instituicao || !curso) {
                alert('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios!');
                return;
            }

            console.log('üì§ Enviando forma√ß√£o:', {
                usuarioId: usuarioLogado.id,
                titulo: curso,
                instituicao: instituicao,
                dataInicio: anoInicio ? `${anoInicio}-01-01` : null,
                dataFim: anoFim ? `${anoFim}-01-01` : null
            });

            try {
                const response = await fetch(`${API_URL}/trilhas/formacoes`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usuarioId: parseInt(usuarioLogado.id),
                        titulo: curso,
                        instituicao: instituicao,
                        dataInicio: anoInicio ? `${anoInicio}-01-01` : null,
                        dataFim: anoFim ? `${anoFim}-01-01` : null,
                        emAndamento: false
                    })
                });
                
                console.log('üì• Status resposta:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Erro do servidor:', errorText);
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('üì¶ Resposta:', data);
                
                if (data.success) {
                    alert('‚úÖ Forma√ß√£o adicionada com sucesso!');
                    fecharPopupFormacao();
                    await carregarFormacoes();
                } else {
                    alert('‚ùå Erro: ' + (data.message || 'Falha ao salvar'));
                }
            } catch (error) {
                console.error('‚ùå Erro completo:', error);
                alert('‚ùå Erro de conex√£o. Verifique se o servidor est√° rodando.');
            }
        });
    }

    // ============================================
    // DROPDOWNS NAV
    // ============================================
    const dropdownNotif = document.getElementById('dropdownNotif');
    const dropdownConfig = document.getElementById('dropdownConfig');
    const dropdownPerfil = document.getElementById('dropdownPerfil');
    const btnNotif = document.querySelector('.btn-notificao-nav');
    const btnConfig = document.querySelector('.btn-config');
    const fotoPerfilNav = document.getElementById('fotoPerfilNav');
    
    function fecharDropdownNotif() { dropdownNotif.classList.remove('ativo'); }
    function fecharDropdownConfig() { dropdownConfig.classList.remove('ativo'); }
    function fecharDropdownPerfil() { dropdownPerfil.classList.remove('ativo'); }
    
    if (btnNotif) {
        btnNotif.addEventListener('click', () => {
            fecharDropdownConfig();
            fecharDropdownPerfil();
            dropdownNotif.classList.toggle('ativo');
        });
    }
    
    if (btnConfig) {
        btnConfig.addEventListener('click', () => {
            fecharDropdownNotif();
            fecharDropdownPerfil();
            dropdownConfig.classList.toggle('ativo');
        });
    }
    
    if (fotoPerfilNav) {
        fotoPerfilNav.addEventListener('click', () => {
            fecharDropdownNotif();
            fecharDropdownConfig();
            dropdownPerfil.classList.toggle('ativo');
        });
    }

    document.querySelectorAll('[data-action]').forEach(btn => {
        btn.addEventListener('click', function() {
            const action = this.getAttribute('data-action');
            switch(action) {
                case 'fechar-notif': fecharDropdownNotif(); break;
                case 'fechar-config': fecharDropdownConfig(); break;
                case 'fechar-perfil': fecharDropdownPerfil(); break;
                case 'sair-da-conta':
                    if (confirm('Tem certeza que deseja sair da conta?')) {
                        localStorage.removeItem('usuarioLogado');
                        window.location.href = '/home.html';
                    }
                    fecharDropdownPerfil();
                    break;
                default:
                    fecharDropdownConfig(); 
                    fecharDropdownPerfil();
                    break;
            }
        });
    });
    
    document.addEventListener('click', event => {
        const isClickOutside = !dropdownNotif.contains(event.target) && event.target !== btnNotif &&
                               !dropdownConfig.contains(event.target) && event.target !== btnConfig &&
                               !dropdownPerfil.contains(event.target) && event.target !== fotoPerfilNav;
        
        if (isClickOutside) {
            fecharDropdownNotif();
            fecharDropdownConfig();
            fecharDropdownPerfil();
        }
    });
});
    </script>
</body>
</html>