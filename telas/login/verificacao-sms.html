<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifica√ß√£o SMS - Bridge</title>
    <link rel="stylesheet" href="./estilos_login/estilos_confirmacao-de-email.css">
    <style>
        .container-verificacao {
            background: #161616;
            border-radius: 50px;
            border: 1px solid #ffffff;
            padding: 50px;
            max-width: 500px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 25px;
            align-items: center;
            position: relative;
            z-index: 10;
            box-shadow: 0px 2px 20px 0px rgba(0, 0, 0, 0.25);
        }
        .sms-icon { font-size: 64px; margin-bottom: 10px; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        .sms-title { color: #ffffff; font-family: "Roboto-Bold", sans-serif; font-size: 24px; font-weight: 700; text-align: center; margin: 0; }
        .sms-subtitle { color: #ffffff; font-family: "Roboto-Regular", sans-serif; font-size: 14px; font-weight: 400; text-align: center; margin: 0; line-height: 1.5; }
        .sms-subtitle strong { color: #15D3B1; font-weight: 700; }
        #smsForm { width: 100%; display: flex; flex-direction: column; gap: 15px; margin-top: 10px; }
        .codigo-input { background: #ffffff; border-radius: 10px; border: 2px solid #ffffff; padding: 15px; font-family: "Roboto-Bold", sans-serif; font-size: 28px; text-align: center; letter-spacing: 8px; width: 100%; outline: none; transition: border-color 0.3s ease; }
        .codigo-input:focus { border-color: #15D3B1; box-shadow: 0 0 10px rgba(21, 211, 177, 0.3); }
        .helper-text { color: #929292; font-family: "Roboto-Regular", sans-serif; font-size: 12px; text-align: center; margin: -5px 0 0 0; }
        .error-message { color: #ff6b6b; font-size: 14px; text-align: center; display: none; margin: 0; padding: 10px; background: rgba(255, 107, 107, 0.1); border-radius: 8px; }
        .success-message { color: #15D3B1; font-size: 14px; text-align: center; display: none; margin: 0; padding: 10px; background: rgba(21, 211, 177, 0.1); border-radius: 8px; }
        .btn-verificar { background: #ffffff; border-radius: 10px; border: none; padding: 12px 20px; font-size: 16px; font-weight: 700; cursor: pointer; width: 100%; transition: all 0.3s ease; }
        .btn-verificar:hover:not(:disabled) { background: #15D3B1; color: #ffffff; }
        .btn-verificar:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-reenviar { background: transparent; border: 2px solid #ffffff; border-radius: 10px; padding: 10px 20px; font-size: 14px; font-weight: 700; color: #ffffff; cursor: pointer; width: 100%; transition: all 0.3s ease; }
        .btn-reenviar:hover:not(:disabled) { background: rgba(255, 255, 255, 0.1); }
        .btn-reenviar:disabled { opacity: 0.5; cursor: not-allowed; }
        .countdown { color: #15D3B1; font-size: 13px; text-align: center; margin: 10px 0 0 0; }
        .voltar-link { color: #ffffff; font-size: 14px; text-decoration: none; margin-top: 20px; display: block; text-align: center; transition: color 0.3s ease; }
        .voltar-link:hover { color: #15D3B1; }
    </style>
</head>
<body>
    <nav>
        <div class="bloco-de-opcoes">
            <div class="layout-fixo">
                <div class="bloco-logo">
                    <img src="./imagens_login/lotus.svg" width="30px" height="30px">
                    <div class="bridge">BRIDGE</div>
                    <div class="barra"></div>
                    <div class="login">Login</div>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <div class="bloco-senha-wrapper">
            <img class="bloco-senha" src="./imagens_login/fundo-instituicao.svg" />
            <div class="degrade-overlay"></div>
        </div>

        <div class="container-verificacao">
            <div class="sms-icon">üì±</div>
            <h2 class="sms-title">Verifica√ß√£o de Seguran√ßa</h2>
            <p class="sms-subtitle">Digite o c√≥digo enviado para <strong id="telefoneDisplay">...</strong> para confirmar a opera√ß√£o.</p>

            <form id="smsForm">
                <input type="text" id="codigoInput" class="codigo-input" placeholder="000000" maxlength="6" autocomplete="off" required>
                <p class="helper-text">O c√≥digo expira em 5 minutos</p>

                <p id="errorMessage" class="error-message"></p>
                <p id="successMessage" class="success-message"></p>

                <button type="submit" class="btn-verificar" id="submitBtn">Confirmar c√≥digo</button>
                <button type="button" class="btn-reenviar" id="reenviarBtn">Reenviar c√≥digo</button>
                <p class="countdown" id="countdown"></p>
            </form>
            <a href="#" class="voltar-link" onclick="history.back(); return false;">‚Üê Cancelar</a>
        </div>
    </main>

   <script>
    // ‚úÖ Dados do usu√°rio e fluxo
    const userIdString = localStorage.getItem('userId');
    const userEmail = localStorage.getItem('userEmail');
    const userId = userIdString ? parseInt(userIdString) : null;
    const authFlow = sessionStorage.getItem('authFlow'); 
    const tempNovaSenha = sessionStorage.getItem('tempNovaSenha');
    let telefone = localStorage.getItem('userTelefone'); 

    console.log('üîê Fluxo de autentica√ß√£o:', authFlow || 'login-normal');

    // Elementos do DOM
    const telefoneDisplay = document.getElementById('telefoneDisplay');
    const codigoInput = document.getElementById('codigoInput');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    const submitBtn = document.getElementById('submitBtn');
    const reenviarBtn = document.getElementById('reenviarBtn');
    const countdown = document.getElementById('countdown');

    // Valida√ß√µes iniciais
    if (!userEmail || userId === null || isNaN(userId)) {
        alert('Sess√£o inv√°lida ou informa√ß√µes ausentes.');
        window.location.href = './tela-senha.html';
    }
    
    // Exibi√ß√£o do telefone mascarado
    if (telefone) {
        const inicio = telefone.substring(0, 7); 
        const fim = telefone.substring(telefone.length - 4);
        telefoneDisplay.textContent = `${inicio}*****${fim}`;
    } else {
        telefoneDisplay.textContent = 'o seu n√∫mero cadastrado';
    }

    // Input apenas n√∫meros
    codigoInput.focus();
    codigoInput.addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    });

    // ‚è±Ô∏è Timer de expira√ß√£o
    let tempoRestante = 300; // 5 minutos
    const intervalo = setInterval(() => {
        tempoRestante--;
        const m = Math.floor(tempoRestante / 60);
        const s = tempoRestante % 60;
        countdown.textContent = `Tempo restante: ${m}:${s.toString().padStart(2, '0')}`;
        
        if (tempoRestante <= 0) {
            clearInterval(intervalo);
            countdown.textContent = 'C√≥digo expirado';
            countdown.style.color = '#ff6b6b';
            submitBtn.disabled = true;
        }
    }, 1000);

    // ‚úÖ SUBMIT DO FORMUL√ÅRIO (VERIFICAR C√ìDIGO)
    document.getElementById('smsForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const codigo = codigoInput.value;

        if (codigo.length !== 6) {
            errorMessage.textContent = 'Digite o c√≥digo de 6 d√≠gitos';
            errorMessage.style.display = 'block';
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Verificando...';
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';

        try {
            // 1Ô∏è‚É£ Verifica o c√≥digo SMS
            const response = await fetch('http://localhost:3000/api/verificar-codigo-sms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: userEmail,
                    codigo: codigo
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                console.log('‚úÖ C√≥digo verificado com sucesso');
                
                // 2Ô∏è‚É£ Verifica se √© fluxo de reset de senha
                if (authFlow === 'reset-password' && tempNovaSenha) {
                    console.log('üîÑ Fluxo de reset de senha detectado');
                    submitBtn.textContent = 'Alterando senha...';
                    
                    // 3Ô∏è‚É£ Chama API para efetivamente trocar a senha
                    const resetResponse = await fetch('http://localhost:3000/api/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            email: userEmail,
                            novaSenha: tempNovaSenha
                        })
                    });

                    const resetData = await resetResponse.json();

                    if (resetResponse.ok && resetData.success) {
                        console.log('‚úÖ Senha alterada com sucesso');
                        successMessage.textContent = '‚úÖ Senha alterada com sucesso! Redirecionando...';
                        successMessage.style.display = 'block';
                        
                        // Limpa dados tempor√°rios
                        sessionStorage.removeItem('tempNovaSenha');
                        sessionStorage.removeItem('authFlow');
                        localStorage.removeItem('userTelefone');
                        localStorage.removeItem('userId');
                        
                        // Redireciona para tela de login
                        setTimeout(() => {
                            window.location.href = './tela-senha.html';
                        }, 2000);
                    } else {
                        throw new Error(resetData.message || 'Erro ao alterar senha no banco.');
                    }

                } else {
                    // üîê Fluxo de login normal (2FA)
                    console.log('‚úÖ Login 2FA bem-sucedido');
                    successMessage.textContent = '‚úÖ Verifica√ß√£o conclu√≠da! Entrando...';
                    successMessage.style.display = 'block';
                    
                    setTimeout(() => {
                        window.location.href = '/telas/Sala-de-Aula/sala.html';
                    }, 1500);
                }

            } else {
                throw new Error(data.message || 'C√≥digo incorreto.');
            }

        } catch (error) {
            console.error('‚ùå Erro:', error);
            errorMessage.textContent = error.message || 'Erro ao verificar c√≥digo';
            errorMessage.style.display = 'block';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Confirmar c√≥digo';
        }
    });

    // ‚ôªÔ∏è Reenviar C√≥digo
    reenviarBtn.addEventListener('click', async () => {
        reenviarBtn.disabled = true;
        reenviarBtn.textContent = 'Reenviando...';
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';
        
        try {
            const response = await fetch('http://localhost:3000/api/enviar-codigo-sms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    email: userEmail
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                console.log('‚úÖ C√≥digo reenviado');
                successMessage.textContent = '‚úÖ Novo c√≥digo enviado!';
                successMessage.style.display = 'block';

                // Reset do timer
                tempoRestante = 300;
                submitBtn.disabled = false;
                countdown.style.color = '#15D3B1';

                // Atualiza telefone se retornado
                if (data.telefone) {
                    localStorage.setItem('userTelefone', data.telefone);
                    telefone = data.telefone;
                    const inicio = telefone.substring(0, 7); 
                    const fim = telefone.substring(telefone.length - 4);
                    telefoneDisplay.textContent = `${inicio}*****${fim}`;
                }

                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);

            } else {
                errorMessage.textContent = data.message || 'Erro ao reenviar c√≥digo';
                errorMessage.style.display = 'block';
            }

        } catch (error) {
            console.error('‚ùå Erro ao reenviar:', error);
            errorMessage.textContent = 'Erro ao conectar com o servidor';
            errorMessage.style.display = 'block';
        } finally {
            reenviarBtn.disabled = false;
            reenviarBtn.textContent = 'Reenviar c√≥digo';
        }
    });

    // Limpeza ao sair da p√°gina
    window.addEventListener('beforeunload', () => {
        clearInterval(intervalo);
    });
</script>
</body>
</html>