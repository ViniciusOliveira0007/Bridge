<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redefinir Senha</title>
    <link rel="stylesheet" href="./estilos_login/estilos_confirmacao-de-email.css">
    <link rel="stylesheet" href="./estilos_login/estilo_senha_esquecida.css">
</head>
<body>
    <nav>
        <div class="bloco-de-opcoes">
            <div class="layout-fixo">
                <div class="bloco-logo">
                    <img src="./imagens_login/lotus.svg" alt="Logo da instituição" class="projeto" width="30px" height="30px">
                    <div class="bridge">BRIDGE</div>
                    <div class="barra"></div>
                    <div class="login">Login</div>
                </div>
                <div class="navega">
                    <div class="btn-voltar">
                        <a class="voltar" href="/home.html">Voltar ao inicio</a>
                    </div>
                    <div class="btn-default">
                        <a class="button">Suporte</a>
                    </div>
                    <div class="btn-default">
                        <div class="button">Quem somos</div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main>
        <div class="bloco-senha-wrapper">
            <img class="bloco-senha" src="./imagens_login/fundo-instituicao.svg" />
            <div class="degrade-overlay"></div>
        </div>

        <div class="container-principal">
            <form id="resetPasswordForm" class="formulario-senha">
                <div class="campos-formulario">
                    <div class="campo-nova-senha">
                        <div class="cabecalho-campo">
                            <div class="nova-senha">Nova senha</div>
                        </div>
                        <input class="entrada-texto" placeholder="*Exemplo123" type="password" id="novaSenha" required>
                    </div>
                    <div class="campo-confirmar-senha">
                        <div class="cabecalho-campo">
                            <div class="confirmar-senha">Confirmar senha</div>
                        </div>
                        <input class="entrada-texto" placeholder="*Exemplo123" type="password" id="confirmarSenha" required>
                    </div>
                    
                    <div id="messageArea" style="margin-top: 10px; display: none;">
                        <p id="errorMessage" style="color: red; font-size: 14px;"></p>
                        <p id="successMessage" style="color: green; font-size: 14px;"></p>
                    </div>
                    
                    <div class="area-ajuda">
                        <div class="precisa-de-ajuda">Precisa de ajuda?</div>
                    </div>
                    <button type="submit" class="botao-confirmar" id="submitBtn">
                        Continuar
                    </button>
                </div>
            </form>
            
            <div class="painel-requisitos">
                <img class="fundo-requisitos" src="./imagens_login/Fundo-de-requerimentos.svg" />
                <div class="conteudo-requisitos">
                    <div class="titulo-requisitos">
                        <div class="requisitos-para-validacao-de-senha">Requisitos para validação de senha:</div>
                    </div>
                    <div class="lista-requisitos">
                        <div class="item-requisito">
                            <img class="icone-aceitacao" id="icon-length" src="./imagens_login/Recusado.svg" />
                            <div class="ter-pelo-menos-8-caracteres">Ter pelo menos 8 caracteres</div>
                        </div>
                        <div class="item-requisito">
                            <img class="icone-aceitacao" id="icon-uppercase" src="./imagens_login/Recusado.svg" />
                            <div class="ter-pelo-menos-1-letra-maiuscula">Ter pelo menos 1 letra maiúscula</div>
                        </div>
                        <div class="item-requisito">
                            <img class="icone-aceitacao" id="icon-lowercase" src="./imagens_login/Recusado.svg" />
                            <div class="ter-pelo-menos-1-letra-minuscula">Ter pelo menos 1 letra minúscula</div>
                        </div>
                        <div class="item-requisito">
                            <img class="icone-aceitacao" id="icon-special" src="./imagens_login/Recusado.svg" />
                            <div class="ter-pelo-menos-1-caracter-especial">Ter pelo menos 1 caracter especial</div>
                        </div>
                        <div class="item-requisito">
                            <img class="icone-aceitacao" id="icon-number" src="./imagens_login/Recusado.svg" />   
                            <div class="ter-pelo-menos-1-numero">Ter pelo menos 1 número</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="botao-voltar-secao">
                <a class="voltar1" href="./confirmacao-de-senha.html">Voltar</a>
            </div>
            <img class="etec" src="./imagens_login/Etec.svg" />
            <div class="logo-bridge">
                <img src="./imagens_login/lotus.svg" width="30px" height="30px" alt="">
                <div class="bridge">BRIDGE</div>
            </div>
        </div>
    </main>

     <script>
    // ✅ Pega dados salvos do fluxo de login
    const userEmail = localStorage.getItem('userEmail');
    const userIdString = localStorage.getItem('userId');
    const userId = userIdString ? parseInt(userIdString) : null;
    
    // Check de segurança
    if (!userEmail || userId === null || isNaN(userId)) {
        alert('Sessão expirada. Por favor, inicie o processo de recuperação novamente.');
        window.location.href = './tela-senha.html';
    }

    // Elementos
    const novaSenhaInput = document.getElementById('novaSenha');
    const confirmarSenhaInput = document.getElementById('confirmarSenha');
    const form = document.getElementById('resetPasswordForm');
    const submitBtn = document.getElementById('submitBtn');
    const messageArea = document.getElementById('messageArea');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');

    // Ícones de Validação
    const icons = {
        length: document.getElementById('icon-length'),
        uppercase: document.getElementById('icon-uppercase'),
        lowercase: document.getElementById('icon-lowercase'),
        special: document.getElementById('icon-special'),
        number: document.getElementById('icon-number')
    };

    let requisitos = {
        length: false, 
        uppercase: false, 
        lowercase: false, 
        special: false, 
        number: false
    };

    function validarSenha(senha) {
        requisitos.length = senha.length >= 8;
        requisitos.uppercase = /[A-Z]/.test(senha);
        requisitos.lowercase = /[a-z]/.test(senha);
        requisitos.special = /[@$!%*?&#]/.test(senha);
        requisitos.number = /\d/.test(senha);
        atualizarIcones();
    }

    function atualizarIcones() {
        for (const key in requisitos) {
            icons[key].src = requisitos[key] 
                ? './imagens_login/Aceitação.svg' 
                : './imagens_login/Recusado.svg';
        }
    }

    novaSenhaInput.addEventListener('input', (e) => validarSenha(e.target.value));

    // ✅ SUBMISSÃO DO FORMULÁRIO (CORRIGIDA)
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const novaSenha = novaSenhaInput.value;
        const confirmarSenha = confirmarSenhaInput.value;
        
        messageArea.style.display = 'none';
        errorMessage.textContent = '';
        successMessage.textContent = '';
        
        // Valida requisitos
        if (!Object.values(requisitos).every(Boolean)) {
            messageArea.style.display = 'block';
            errorMessage.textContent = 'A senha não atende a todos os requisitos';
            return;
        }
        
        // Valida se as senhas coincidem
        if (novaSenha !== confirmarSenha) {
            messageArea.style.display = 'block';
            errorMessage.textContent = 'As senhas não coincidem';
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando código...';

        try {
            // ✅ Envia código SMS usando email (controller busca o telefone)
            const response = await fetch('http://localhost:3000/api/enviar-codigo-sms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    email: userEmail  // ✅ Envia apenas email, controller busca o telefone
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                console.log('✅ Código SMS enviado com sucesso');
                
                // ✅ Salva senha temporariamente e marca fluxo de reset
                sessionStorage.setItem('tempNovaSenha', novaSenha);
                sessionStorage.setItem('authFlow', 'reset-password');
                
                // Salva telefone se retornado
                if (data.telefone) {
                    localStorage.setItem('userTelefone', data.telefone);
                }

                messageArea.style.display = 'block';
                successMessage.textContent = 'Código enviado! Redirecionando...';

                // Redireciona para verificação SMS
                setTimeout(() => {
                    window.location.href = './verificacao-sms.html';
                }, 1500);
            } else {
                throw new Error(data.message || 'Erro ao enviar código SMS');
            }

        } catch (error) {
            console.error('❌ Erro:', error);
            messageArea.style.display = 'block';
            errorMessage.textContent = error.message || 'Erro ao comunicar com servidor. Verifique se possui telefone cadastrado.';
            submitBtn.disabled = false;
            submitBtn.textContent = 'Continuar';
        }
    });
</script>
</body>
</html>